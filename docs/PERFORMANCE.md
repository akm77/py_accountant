# Performance

## Цель
Этот документ кратко описывает, что и как измерять в производительности проекта. Он даёт единый формат отчёта и простые правила, без привязки к несуществующим тестам или скриптам.

## Минимальный JSON‑пример
Ниже — компактный пример отчёта. Его можно сохранять в файл или выводить в stdout.

```json
{"generated_at": "2025-11-12T10:00:00Z", "scenario": "trading_detailed_snapshot", "metrics": {"duration_ms": 12, "db_queries": 3, "rows_read": 42}}
```

Расширенный читаемый вариант того же примера:

```json
{
  "generated_at": "2025-11-12T10:00:00Z",
  "scenario": "trading_detailed_snapshot",
  "metrics": {
    "duration_ms": 12,
    "db_queries": 3,          
    "rows_read": 42           
  },
  "environment": "local"
}
```

Пояснения к полям:
- generated_at: момент генерации отчёта в UTC.
- scenario: короткое имя сценария, которое вы измеряете (например, «создание N транзакций» или «расчёт trading detailed»).
- metrics.duration_ms: длительность сценария в миллисекундах (единицу фиксируем явно).
- metrics.db_queries: количество SQL‑запросов за сценарий (опционально, если вы умеете считать).
- metrics.rows_read: суммарное число прочитанных строк из БД (опционально).
- environment: краткое описание окружения запуска (local/CI/…)

## Форматы (обязательно к соблюдению)
- Decimal сериализуем как строку, если значение — денежное или курс:
  - деньги сравниваем после квантизации до 2 знаков (ROUND_HALF_EVEN)
  - курсы — 6 знаков (ROUND_HALF_EVEN)
  - реализация квантизации в `src/domain/quantize.py`
- datetime — в ISO8601 UTC с суффиксом Z (например, `2025-11-12T10:00:00Z`).
- Не смешивать типы метрик: все числовые метрики — числа (int/float в выбранной единице). Денежные величины в метриках — только после квантизации.
- Единицы измерения фиксируйте явно в имени метрики (например, `duration_ms`, `size_bytes`).

## Как запускать измерения (шаблон)
В репозитории нет обязательного «стандартного» профайлера. Используйте удобный вам способ, но сохраняйте результат в JSON по формату выше.

Варианты:
- PyTest: выберите свои тесты/сценарии и запустите фильтр выражением `-k`, без требования специальных маркеров.
  - Пример (шаблон):
    ```bash
    poetry run pytest -q -k "trading and detailed"  # подставьте своё выражение
    ```
- Ад‑hoc сценарий: напишите скрипт, который выполняет нужные use case/CLI команды и печатает JSON на stdout.
  - Пример (псевдокод):
    ```python
    # ...existing code...
    result = {
        "generated_at": "2025-11-12T10:00:00Z",
        "scenario": "my_scenario",
        "metrics": {"duration_ms": 25}
    }
    print(json.dumps(result))
    ```

Правило: не расширяйте набор метрик без «источника истины» (реальной точки сбора). Если вы не измеряете `db_queries` — не добавляйте его в отчёт.

## Интерпретация результатов
- Сравнивайте однотипные запуски: тот же сценарий, те же данные, то же окружение.
- Изменения больше 20% — сигнал посмотреть последние коммиты и конфигурацию.
- Для денег/курсов — не забывайте про квантизацию (2dp/6dp) перед сравнением.

## Future
- Агрегатор отчётов и дашборды — запланировано, но отсутствует сейчас. Если нужен — обсудите требования и реализацию.

## Acceptance Criteria
- Документ не содержит ссылок/команд, отсутствующих в репозитории.
- Есть единая секция «Форматы» (Decimal, datetime, precision).
- Есть минимум один рабочий JSON‑пример (валидная структура).
- Текст понятен джуниору (короткие предложения, минимум жаргона).
- Указаны grep‑команды для быстрой проверки.

## Verification (grep)
Следующие команды должны отработать как ожидается.

- Отсутствуют legacy colon‑команды (ищем по каталогу docs/, исключая этот файл):
  ```bash
  grep -R -nE 'trading:balance|maintenance:fx-ttl|diagnostics:rates-audit|diagnostics:parity-report' docs/ --exclude 'PERFORMANCE.md' || true
  ```
- Есть секция форматов (по ключевой фразе):
  ```bash
  grep -n 'Decimal сериализуем как строку' docs/PERFORMANCE.md
  ```
- Есть JSON‑пример (по ключу generated_at):
  ```bash
  grep -n '{"generated_at"' docs/PERFORMANCE.md
  ```
- Нет прямых ссылок на конкретные test_*.py в документации (исключая этот файл):
  ```bash
  grep -R -nE 'test_.*\.py' docs/ --exclude 'PERFORMANCE.md' || true
  ```
