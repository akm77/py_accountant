rpg_plan:
  metadata:
    project: py_accountant
    generated_at: 2025-11-11
    source: REFACTORING_RPG_PLAN.md
    methodology: RPG
    principles:
      - async_only_path
      - domain_logic_outside_infrastructure
      - single_async_ports_layer
      - explicit_domain_services
      - dto_separation_simple_vs_detailed
      - no_hidden_global_state
      - test_first_topology
      - simplified_uow
    notes: "Мелкие итерации для высокого качества; каждая завершается зелёными тестами перед переходом."

  topology_order:
    - domain.errors
    - domain.quantize
    - domain.value_objects.currencies
    - domain.value_objects.accounts
    - domain.ledger.balance_validation
    - domain.trading_balance.raw
    - domain.trading_balance.converted
    - domain.fx_audit.ttl_archival
    - application.dto.refactor
    - application.ports.unify_async
    - infrastructure.db.models.minimal
    - infrastructure.db.repositories.async_crud
    - infrastructure.db.uow.simplified
    - application.use_cases.currencies
    - application.use_cases.accounts
    - application.use_cases.ledger
    - application.use_cases.trading_balance
    - application.use_cases.fx_audit
    - application.use_cases.reporting
    - presentation.cli.foundation
    - presentation.cli.currencies
    - presentation.cli.accounts
    - presentation.cli.ledger
    - presentation.cli.trading_balance
    - presentation.cli.fx_audit
    - removal.async_bridge
    - deprecation.sync_repositories
    - tests.migration.clean_up
    - metrics.baseline_and_post
    - docs.update.architecture
    - docs.update.migration_history
    - docs.update.readme_async_transition

  iterations:
    # === DOMAIN FOUNDATION ===
    - id: I01
      name: domain.errors.module
      scope:
        - create domain/errors.py (DomainError, ValidationError)
        - add basic docstrings
      dependencies: []
      deliverables:
        - src/domain/errors.py
        - tests/unit/domain/test_errors.py
      tests:
        - test_errors_raise_and_inherit
      acceptance_criteria:
        - DomainError and ValidationError defined
        - tests green
      risk_mitigation: "Минимальный объём, низкий риск."
      status: done
      completed_at: 2025-11-11
      notes: "Модуль создан, тест test_errors_raise_and_inherit зелёный; исключения доступны через domain.errors и ре-экспортируются в domain.__init__.py."

    - id: I02
      name: domain.quantize.utilities
      scope:
        - create domain/quantize.py (money_quantize, rate_quantize)
        - define Decimal contexts (precision, rounding)
      dependencies: [I01]
      deliverables:
        - src/domain/quantize.py
        - tests/unit/domain/test_quantize.py
      tests:
        - test_money_quantize_rounds
        - test_rate_quantize_rounds
        - test_no_global_context_mutation
      acceptance_criteria:
        - Functions return expected quantized values
        - No global Decimal context mutation
      risk_mitigation: "Изолировать контекст через localcontext."
      status: done
      completed_at: 2025-11-11
      notes: "Реализованы money_quantize и rate_quantize с docstring; входы преобразуются через Decimal(str(x)), локальный контекст с ROUND_HALF_EVEN; добавлены тесты на границы и неизменность глобального контекста; импортировать через from domain.quantize import money_quantize, rate_quantize (без экспорта в __init__)."

    - id: I03
      name: domain.currency.value_object
      scope:
        - create domain/currencies.py (Currency, BaseCurrencyRule)
        - enforce single base without mass UPDATE all
      dependencies: [I01, I02]
      deliverables:
        - src/domain/currencies.py
        - tests/unit/domain/test_currency_base_rule.py
      tests:
        - test_set_base_preserves_other_rates
        - test_clear_base
        - test_set_base_missing_code_raises
      acceptance_criteria:
        - Base currency singleton logic passes tests
      risk_mitigation: "Не вносить пока зависимости на репозитории."
      status: done
      completed_at: 2025-11-11
      notes: "Добавлен Currency (валидация длины кода, upper, положительный rate через rate_quantize) и BaseCurrencyRule без сторонних зависимостей; смена базы не трогает другие rate_to_base; тесты (3) зелёные; helper get_base_currency возвращает None при отсутствии базы; TODO комментарий про уникальность кодов."

    - id: I04
      name: domain.account.value_object
      scope:
        - create domain/accounts.py (Account with validation)
      dependencies: [I01]
      deliverables:
        - src/domain/accounts.py
        - tests/unit/domain/test_accounts.py
      tests:
        - test_account_full_name_validation
        - test_account_parent_id_optional
      acceptance_criteria:
        - Validation errors raise ValidationError
      risk_mitigation: "Простая структура, без persistence."
      status: done
      completed_at: 2025-11-11
      notes: "Введён Account (валидация full_name с тримом, запрет ':' на краях/двойных '::', сегменты 1..64, максимум 64 сегмента, длина full_name <=255; currency_code upper и длина 3..10; parent_id опционален). Добавлены тесты: happy-path (включая root), negative cases (пустые/пробелы/':A'/'A:'/'A::B'/'A: :B'/слишком длинный сегмент/слишком глубокая иерархия). Все тесты зелёные."

    - id: I05
      name: domain.ledger.balance_validation
      scope:
        - create domain/ledger.py (LedgerValidator)
        - implement multi-currency balance check using quantize
      dependencies: [I02, I03, I04]
      deliverables:
        - src/domain/ledger.py
        - tests/unit/domain/test_ledger_balance.py
      tests:
        - test_single_currency_balanced
        - test_multi_currency_balanced_with_rates
        - test_unbalanced_detected
      acceptance_criteria:
        - All scenarios pass
      risk_mitigation: "Независимо от инфраструктуры."
      status: done
      completed_at: 2025-11-11
      notes: "Реализованы EntrySide, LedgerEntry (валидация side/amount>0/код валюты 3..10, upper) и LedgerValidator.validate: определение ��азы по base_code либо get_base_currency; поддержка currencies как списка или mapping; конвертация небазовой суммы через amount * rate_to_base (>0, обязательна); сравнение сумм debit/credit после money_quantize (2dp, HALF_EVEN); без изменения глобального Decimal контекста; ошибки ValidationError для некорректных входов/курсов/неизвестных валют/пустых линий, DomainError для несбалансированности. Добавлены тесты (включая негативные, проверка контекста и округления); все зелёные."

    - id: I06
      name: domain.trading_balance.raw_aggregation
      scope:
        - create domain/trading_balance.py (RawAggregator)
        - aggregate debit/credit per currency
      dependencies: [I05]
      deliverables:
        - src/domain/trading_balance.py
        - tests/unit/domain/test_trading_balance_raw.py
      tests:
        - test_empty_returns_no_lines
        - test_single_currency_aggregate
        - test_multi_currency_aggregate_separate_groups
        - test_rounding_half_even_each_currency
        - test_preserve_decimal_context
        - test_reject_non_ledger_entry_input_guard
      acceptance_criteria:
        - Raw aggregation yields expected totals; list sorted by currency_code
        - Quantization via money_quantize; no global Decimal context changes
        - No FX/base conversion; public objects have short docstrings
      risk_mitigation: "Не добавлять конверсию; одно‑проходный алгоритм, защитные проверки типов."
      status: done
      completed_at: 2025-11-11
      notes: "Добавлен RawAggregator без инфраструктурных зависимостей; суммы аккумулируются как Decimal без округления, квантование на выходе (2dp HALF_EVEN). Возвращается список RawBalanceLine, отсортированный по ��оду валюты. Добавлены тесты (6) включая проверк�� неизменности Decimal контекста и защиту от неверного ввода; все зелёные."

    - id: I07
      name: domain.trading_balance.converted_aggregation
      scope:
        - extend trading_balance.py (ConvertedAggregator, ConvertedBalanceLine DTO)
        - keep RawAggregator/RawBalanceLine intact
        - convert per-currency totals to base using rate_to_base
        - rounding on output only (money_quantize), rate in DTO via rate_quantize
      dependencies: [I02, I03, I05, I06]
      deliverables:
        - updated src/domain/trading_balance.py
        - tests/unit/domain/test_trading_balance_converted.py
      tests:
        - test_empty_returns_no_lines_converted
        - test_single_currency_base_passthrough
        - test_single_nonbase_with_rate
        - test_multi_currency_mixed_and_sorting
        - test_rounding_half_even_in_base
        - test_missing_rate_raises_for_non_base
        - test_non_positive_rate_raises
        - test_unknown_currency_line_raises
        - test_base_detection_via_get_base_currency
        - test_preserve_decimal_context_converted
        - test_input_guard_non_ledger_entry
      acceptance_criteria:
        - All tests in tests/unit/domain/test_trading_balance_converted.py are green
        - Public DTOs/classes have short docstrings
        - List is sorted by currency_code ASC; empty in -> empty out
        - ValidationError raised per spec (unknown currency, base missing, rate missing/non-positive, non-LedgerEntry)
        - No infrastructure dependencies; domain-only; Decimal context unchanged
      risk_mitigation: "Единый текущий курс per currency задокументирован; строгие ValidationError сообщения; O(n)+sort без побочных эффектов."
      status: done
      completed_at: 2025-11-11
      notes: "Добавлены ConvertedBalanceLine и ConvertedAggregator: одно‑проходная агрегация сырых сумм, определение базы (по base_code или get_base_currency), конвертация небазовых валют по rate_to_base (>0) с выводом used_rate через rate_quantize. Округление денег только на выходе через money_quantize; сохранение глобального Decimal контекста. Список отсортирован лексикографически по currency_code. Добавлен модуль тестов (11 сценариев; 13 ассёртов/параметризаций), все зелёные."

    - id: I08
      name: domain.fx_audit.ttl_archival_service
      scope:
        - create domain/fx_audit.py (FxAuditTTLService)
        - define methods make_cutoff, identify_old, batch_plan
        - add dataclasses ExchangeRateEventRef, TTLConfig, Batch and ArchivalMode enum
      dependencies: [I01, I03]
      deliverables:
        - src/domain/fx_audit.py
        - tests/unit/domain/test_fx_audit_ttl.py
      tests:
        - test_identify_old_events
        - test_archival_plan_sizes
        - test_make_cutoff_normalization_utc
        - test_validation_errors
      acceptance_criteria:
        - Pure domain logic, no I/O or repository dependencies
        - UTC normalization for naive/aware datetimes
        - Stable filtering order documented
        - Strict ValidationError on invalid parameters
        - All listed tests green
      risk_mitigation: "Только чистая логика; малый объём; покрытие edge случаев временем/пустыми списками."
      status: done
      completed_at: 2025-11-11
      notes: "Реализован FxAuditTTLService (make_cutoff/identify_old/batch_plan) с docstrings и валидацией; время нормализуется к UTC (naive => UTC, aware => astimezone UTC); stable filtering без сортировки; batch_plan покрывает [0..total) неперекрывающимися окнами; добавлены вспомогательные dataclass'ы ExchangeRateEventRef, TTLConfig, Batch и enum ArchivalMode; тесты (4) зелёные."

    - id: I08A
      name: tests.inventory_snapshot
      scope:
        - generate initial inventory report tests/report/test_inventory.md
        - mark candidates for xfail
      dependencies: [I08]
      deliverables:
        - tests/report/test_inventory.md
      tests: []
      acceptance_criteria:
        - Inventory file exists and lists categories
      risk_mitigation: "Не меняет код, только аналитика"
      status: done
      completed_at: 2025-11-11
      notes: "Файл tests/report/test_inventory.md создан: содержит категории (KEEP-ASIS, ADAPT-SHALLOW, REWRITE-DOMAIN, UPGRADE-CLI, DROP-TRIVIAL, OBSOLETE, PERF-OPTIONAL, SPLIT, MOVE) и рекомендации по меткам xfail для будущих итераций."

    # === APPLICATION LAYER REFACTOR ===
    - id: I09
      name: application.dto.refactor_step1
      scope:
        - introduce TradingBalanceLineSimple, TradingBalanceLineDetailed
        - remove converted_* from old DTO
      dependencies: [I07]
      deliverables:
        - src/application/dto/models.py (refactored)
        - tests/unit/domain/test_dto_trading_balance_refactor.py
      tests:
        - test_simple_line_without_converted_fields
        - test_detailed_line_contains_conversion
      acceptance_criteria:
        - Old fields not present in simple DTO
      risk_mitigation: "Сохранить совместимость имён остальных DTO."
      status: done
      completed_at: 2025-11-11
      notes: "Добавлены TradingBalanceLineSimple (только raw debit/credit/net) и TradingBalanceLineDetailed (raw + base conversion: base_currency_code, used_rate (6 знаков), *_base). Legacy TradingBalanceLineDTO оставлен нетронутым для совместимости до I10. Все 4 новых теста (простая/детальная ф��рма, docstrings, frozen slots guard) зелёные. Simple DTO не содержит converted_* полей (проверено через hasattr и dataclasses.fields). Публичный экспорт __all__ обновлён. Докстроки добавлены к публичным DTO."

    - id: I10
      name: application.dto.refactor_step2_backwards_shim
      scope:
        - introduce compatibility alias/deprecation for legacy TradingBalanceLineDTO
        - adapt application use cases to return new DTOs (raw -> Simple, detailed -> Detailed)
        - update unit tests to consume new DTOs; add mapping tests
      dependencies: [I09]
      deliverables:
        - src/application/dto/models.py (deprecated docstring for TradingBalanceLineDTO)
        - src/application/use_cases/ledger.py (new GetTradingBalanceRawDTOs, GetTradingBalanceDetailedDTOs)
        - tests/unit/application/test_ports_and_dtos.py (adapted)
        - tests/unit/application/test_trading_balance_use_cases_dto_mapping.py (new)
      tests:
        - test_raw_use_case_returns_simple_dto
        - test_detailed_use_case_returns_detailed_dto
        - test_legacy_trading_balance_line_alias (see: test_legacy_alias_points_to_detailed_class)
        - test_no_converted_fields_in_simple_output
      acceptance_criteria:
        - All use cases added return new DTOs
        - No new references to converted_* outside legacy paths
        - Legacy name only used via deprecated class; no new instantiation in app layer
        - Test suites I09+I10 green
      risk_mitigation: "Оставить существующие sync/async use cases нетронутыми для совместимости; потребители постепенно переводятся на новые методы."

    - id: I11
      name: application.ports.unify_async_protocols
      scope:
        - create single module src/application/ports.py with async Protocols only
        - remove sync Protocol definitions from active contract
        - add deprecated proxy src/application/interfaces/ports.py re-exporting async names
        - add minimal docstrings to all public async Protocols
        - introduce test tests/unit/application/test_ports_async_only.py
      dependencies: [I09]
      deliverables:
        - src/application/ports.py
        - src/application/interfaces/ports.py (deprecated proxy)
        - tests/unit/application/test_ports_async_only.py
      tests:
        - test_async_ports_public_surface_only_async
        - test_deprecated_proxy_reexports_identity
        - test_no_legacy_sync_protocols_present
      acceptance_criteria:
        - application.ports exposes only async Protocols (names prefixed Async*) and Clock
        - legacy sync Protocol names not present in application.ports
        - deprecated proxy re-exports same objects (identity) without runtime warnings
        - docstrings present on public Protocol classes
        - existing imports from application.interfaces.ports remain functional
      risk_mitigation: "Proxy keeps backward compatibility; structural tests guard against accidental sync leakage."
      status: done
      completed_at: 2025-11-11
      notes: "Unified async ports layer established; sync Protocols removed from source of truth; future iterations will migrate remaining consumers and delete proxy."

    # === INFRASTRUCTURE FOUNDATION ===
    - id: I12
      name: infrastructure.models.minimal_revision
      scope:
        - ensure models.py contains only schema (no business logic)
        - annotate deprecated balance cache table
        - remove helper factories (make_engine/make_session_factory) from models.py
        - add module docstring with policy "schema only"
        - adjust tests to not import removed helpers
      dependencies: [I11]
      deliverables:
        - src/infrastructure/persistence/sqlalchemy/models.py
        - tests/integration/db/test_models_exist.py
        - tests/integration/ledger/test_performance_indices.py (updated)
      tests:
        - test_tables_present
        - test_indexes_present_sqlite_memory (still green)
      acceptance_criteria:
        - No aggregation/business methods in models
        - Module-level docstring present with schema-only rule
        - BalanceORM clearly marked DEPRECATED
        - Integration test asserts minimal set of tables exists
        - All existing tests green
      risk_mitigation: "Diff проверка на удаление ��ода; быстрый grep на aggregate/balance/compute/convert."
      status: done
      completed_at: 2025-11-11
      notes: "models.py очищен: оставлены только ORM схемы, удалены make_engine/make_session_factory; BalanceORM помечен DEPRECATED (удаление в будущей миграции). Добавлен тест tests/integration/db/test_models_exist.py, актуализирован test_performance_indices для прямого create_engine."

    - id: I13
      name: infrastructure.repositories.async_crud
      scope:
        - simplify async repositories to CRUD-only (no aggregations/conversions)
        - remove trading/account balance calculations from repositories
        - keep simple filters/sorting/pagination only
        - preserve async Protocol signatures from application.ports
        - balance cache: allowed as CRUD only (DEPRECATED), no smart updates
      dependencies: [I12]
      deliverables:
        - src/infrastructure/persistence/sqlalchemy/repositories_async.py (trimmed to CRUD)
        - tests/integration/db/test_repositories_crud.py (new)
      tests:
        - test_currency_crud
        - test_account_crud
      acceptance_criteria:
        - no business aggregation/compute/convert methods present in async repos
        - public methods match async Protocols; have short docstrings
        - new CRUD tests green in CI
      risk_mitigation: "Stub removed business methods with NotImplementedError and DEPRECATED docstrings if imports remain; adjust/xfail legacy tests in later iterations."
      status: done
      completed_at: 2025-11-11
      notes: "repositories_async.py cleaned to CRUD-only; added minimal integration CRUD tests for Currency and Account. Aggregations moved to domain/use cases in later iterations."

    - id: I14
      name: infrastructure.uow.simplified
      scope:
        - implement simplified AsyncUoW (remove retry/timeout/backoff/transient detection)
        - drop _committed/_commit_attempted and settings dependency
        - preserve public surface: __aenter__/__aexit__/commit/rollback/session/engine + repo properties
        - add _explicit_commit flag (True only after explicit commit())
        - auto-commit on context exit if no exception and no explicit commit
        - rollback on exception; always close session
        - keep lazy repositories (single instance per context)
        - no SET LOCAL statement_timeout
        - do not touch sync UoW (deferred removal I27+)
      dependencies: [I13]
      deliverables:
        - src/infrastructure/persistence/sqlalchemy/uow.py (simplified class)
        - tests/integration/db/test_uow_lifecycle.py (new lifecycle tests)
        - tests/unit/infrastructure/test_async_uow_retries.py (marked xfail OBSOLETE I14)
        - rpg_py_accountant.yaml (component description updated)
        - docs/REFACTORING_RPG_ITERATIONS.yaml (this node expanded)
      tests:
        - test_commit_persists
        - test_rollback_discards
        - test_double_enter_raises
        - test_session_property_outside_context_raises
        - test_repositories_lazy_singleton_per_context
        - test_no_retry_backoff_left_in_source (grep assertions)
        - xfail: test_commit_retries_then_succeeds (OBSOLETE I14)
        - xfail: test_commit_gives_up_on_non_transient (OBSOLETE I14)
      acceptance_criteria:
        - AsyncSqlAlchemyUnitOfWork has no _is_transient_error/_commit_with_retry methods
        - File contains no tokens: retry, backoff, statement_timeout, _commit_with_retry, _is_transient_error
        - Public methods/properties have concise docstrings
        - All new lifecycle tests green
        - Previous CRUD tests from I13 remain green
        - Obsolete retry tests marked xfail with reason OBSOLETE (I14)
        - Updated component description in rpg_py_accountant.yaml reflects simplification
      risk_mitigation: "Retry/timeout responsibility shifted outward; document in class docstring; guard re-entry and session access outside context via RuntimeError tests."
      status: done
      completed_at: 2025-11-11
      notes: |
        Simplified Async UoW eliminates internal retry/backoff and statement timeout configuration.
        Responsibility for transient failure retries now sits with orchestrators or external infra.
        Cleanup reduced state to _entered and _explicit_commit for clarity. Obsolete tests retained as xfail for traceability.

    # === APPLICATION USE CASES ===
    - id: I15
      name: use_cases.currencies_refactor
      scope:
        - adapt currency use cases to domain services + new ports
        - move validation of code/rate into domain.currencies (Currency)
        - base selection via BaseCurrencyRule in use case, repositories remain CRUD-only
        - prefer Variant B persistence: clear_base + upsert(is_base=True, exchange_rate=None)
      dependencies: [I14]
      deliverables:
        - src/application/use_cases_async/currencies.py
        - tests/unit/application/test_use_cases_currencies.py
        - rpg_py_accountant.yaml (node description for use_cases_async/currencies updated)
      tests:
        - test_create_currency_creates_with_rate_via_domain_quantize
        - test_create_currency_invalid_code_raises_validation_error
        - test_set_base_currency_switches_single_base_no_rate_changes
        - test_set_base_currency_missing_raises_validation_error
        - test_list_currencies_passthrough
      acceptance_criteria:
        - AsyncCreateCurrency/AsyncSetBaseCurrency use domain.currencies for validation/logic
        - Repositories used only for CRUD operations (get_by_code, list_all, upsert, clear_base)
        - Public ports/DTO unchanged; signatures preserved
        - Concise docstrings present on public classes/methods
        - New tests green; existing I13 tests not broken
      risk_mitigation: "Репозитории остаются CRUD-only (I13 freeze); покрыть edge кейсы тестами."
      status: done
      completed_at: 2025-11-11
      notes: |
        Use cases now own currency business decisions: code and rate validation via domain.Currency;
        base selection via BaseCurrencyRule with idempotency. Persistence uses clear_base + upsert to
        avoid depending on set_base semantics. Rates for base currency are always None. Added a focused
        test module covering quantization, invalid inputs, base switching stability, and passthrough list.

    - id: I16
      name: use_cases.accounts_refactor
      scope:
        - Перенести валидацию full_name/currency_code в домен через domain.Account
        - Нормализация full_name (trim/segments join) и currency_code (upper) в домене
        - Репозитории остаются CRUD-only; use case проверяет только существование валюты и уникальность full_name
        - Обновить краткие докстроки у AsyncCreateAccount/AsyncGetAccount/AsyncListAccounts
      dependencies: [I15]
      deliverables:
        - src/application/use_cases_async/accounts.py (refactored)
        - tests/unit/application/test_use_cases_accounts.py (new)
        - docs/REFACTORING_RPG_ITERATIONS.yaml (этот узел расширен)
        - rpg_py_accountant.yaml (описание узла use_cases_async/accounts обновлено)
      tests:
        - test_create_account_valid_domain_projection
        - test_create_account_invalid_full_name_parametrized
        - test_create_account_invalid_currency_code
        - test_create_account_missing_currency_raises_value_error
        - test_create_account_duplicate_raises_value_error
        - test_get_account_returns_none_for_missing
        - test_list_accounts_passthrough
        - test_root_account_parent_path_none
        - test_account_depth_matches_segments (optional)
      acceptance_criteria:
        - AsyncCreateAccount использует domain.Account для валидации и нормализации
        - Ошибки: ValidationError — формат/валидация; ValueError — валюта отсутствует/дубликат
        - Сигнатуры публичных классов/методов не изменены; краткие докстроки добавлены
        - Репозитории не содержат бизнес‑логики (CRUD only)
        - Все новые тесты зелёные; существующие тесты не ломаются
      risk_mitigation: "Строгое разделение ValidationError vs ValueError, покрыто юнит‑тестами; sync слой не меняется."
      status: done
      completed_at: 2025-11-12
      notes: |
        AsyncCreateAccount теперь создаёт domain.Account для проверки формата имени/глубины/длины и нормализации кода валюты.
        Затем use case проверяет наличие валюты через repo.currencies.get_by_code и уникальность full_name через repo.accounts.get_by_full_name,
        выбрасывая ValueError для отсутствующей валюты/дубликата. Создание идёт через repo.accounts.create с доменно-проецированным DTO.
        AsyncGetAccount/AsyncListAccounts оставлены passthrough; добавлены лаконичные докстроки. Добавлен модуль тестов, покрывающий edge‑кейсы.

    - id: I17
      name: use_cases.ledger_refactor
      scope:
        - integrate LedgerValidator into post_transaction (async path)
        - move formal validation (side, amount>0, currency_code length) to domain LedgerEntry
        - verify resources (accounts/currencies) via repositories (CRUD-only)
        - assemble domain Currency from DTOs and validate base/rates
        - keep signature of AsyncPostTransaction unchanged
        - add concise docstrings
      dependencies: [I16]
      deliverables:
        - src/application/use_cases_async/ledger.py (AsyncPostTransaction uses LedgerValidator)
        - tests/unit/application/test_use_cases_ledger.py (new)
        - rpg_py_accountant.yaml (node description updated for use_cases_async/ledger)
      tests:
        - test_post_transaction_balanced_simple_usd
        - test_post_transaction_unbalanced_raises_domain_error
        - test_post_transaction_empty_lines_raises_validation_error
        - test_post_transaction_missing_account_raises_value_error
        - test_post_transaction_missing_currency_raises_value_error
        - test_post_transaction_zero_or_negative_amount_validation_error
        - test_post_transaction_invalid_side_validation_error
        - test_post_transaction_unknown_currency_in_domain_validation_error
        - test_post_transaction_missing_rate_non_base_validation_error
        - test_post_transaction_rounding_balance_passes
        - test_post_transaction_multi_currency_balanced_with_rates
      acceptance_criteria:
        - AsyncPostTransaction uses LedgerEntry and LedgerValidator.validate
        - Errors classification: ValidationError (format/domain), DomainError (unbalanced), ValueError (missing resources)
        - Signature unchanged; docstrings updated
        - All new tests green; existing smoke adapted where necessary
      risk_mitigation: "Тестами закреплены ошибки и отсутствие базы; репозитории не изменялись (CRUD-only)."
      status: done
      completed_at: 2025-11-12
      notes: |
        AsyncPostTransaction now validates ledger balance via domain LedgerValidator.
        It projects EntryLineDTO to LedgerEntry, loads distinct CurrencyDTOs and converts to domain Currency
        (code/is_base/rate_to_base). The validator auto-detects base (via get_base_currency) and requires
        positive rate_to_base for non-base currencies. On success, transaction is persisted with id 'tx:<uuidhex>'.
        Integration test for ledger pagination updated to set base currency explicitly.

    - id: I18
      name: use_cases.trading_balance_refactor
      scope:
        - move aggregation from legacy async use case to new module use_cases_async/trading_balance.py
        - introduce AsyncGetTradingBalanceRaw and AsyncGetTradingBalanceDetailed (async-only path)
        - use domain RawAggregator / ConvertedAggregator for computation
        - preserve legacy AsyncGetTradingBalance (deprecated) for backward compatibility
        - repositories remain CRUD-only (no aggregate_trading_balance usage)
        - add concise docstrings to new public classes/methods
      dependencies: [I17]
      deliverables:
        - src/application/use_cases_async/trading_balance.py
        - tests/unit/application/test_use_cases_trading_balance.py
        - updated src/application/use_cases_async/__init__.py (exports)
        - updated docs/REFACTORING_RPG_ITERATIONS.yaml (this node)
        - updated rpg_py_accountant.yaml (module/file node for trading_balance use cases)
      tests:
        - test_trading_balance_raw_empty_returns_empty
        - test_trading_balance_raw_single_currency_aggregate
        - test_trading_balance_raw_multi_currency_sorted_and_rounded
        - test_trading_balance_detailed_base_detected_via_get_base
        - test_trading_balance_detailed_missing_base_raises_validation_error
        - test_trading_balance_detailed_nonbase_missing_rate_raises_validation_error
        - test_trading_balance_detailed_non_positive_rate_validation_error (xfail)
        - test_trading_balance_detailed_multi_currency_correct_conversion_and_used_rate_quantized
        - test_window_validation_and_meta_type
      acceptance_criteria:
        - New async use cases return lists of TradingBalanceLineSimple/Detailed
        - Domain aggregators (RawAggregator/ConvertedAggregator) are used exclusively
        - Error classification: ValidationError (domain/validation issues), ValueError (window/meta params), DomainError not used
        - Repositories remain CRUD-only (no business aggregation methods called)
        - Public docstrings present on new classes/methods
        - Full pytest run green (xfail acknowledged)
      risk_mitigation: |
        Empty transaction sets return empty lists; strict validation propagates domain errors.
        xfail test documents non-positive rate scenario unreachable due to domain Currency guard.
      status: done
      completed_at: 2025-11-12
      notes: |
        Implemented new async trading balance module integrating domain aggregators.
        Legacy AsyncGetTradingBalance retained for compatibility and marked conceptually deprecated.
        All new tests green; xfail captured for non-positive rate scenario. Window/meta validation enforced.
        rpg graph updated to include new module and file nodes.
        Added explicit DEPRECATED docstring to legacy AsyncGetTradingBalance (ledger.py) after implementation to guide migration to AsyncGetTradingBalanceRaw/Detailed.

    - id: I19
      name: use_cases.fx_audit_refactor
      scope:
        - integrate domain FxAuditTTLService into async path (planning + execution)
        - add TTL DTOs (BatchDTO, FxAuditTTLPlanDTO, FxAuditTTLResultDTO) to application.dto.models
        - create async use cases AsyncPlanFxAuditTTL and AsyncExecuteFxAuditTTL
        - update use_cases_async/__init__.py export surface (I19)
        - remove reliance on deprecated move_events_to_archive orchestration
        - classify errors: ValidationError (parameters/plan consistency), ValueError (missing repo - unexpected)
        - ensure dry_run transparency (zero side-effects counts)
      dependencies: [I18]
      deliverables:
        - src/application/dto/models.py (TTL DTOs added)
        - src/application/use_cases_async/fx_audit_ttl.py (new module)
        - src/application/use_cases_async/__init__.py (exports updated)
        - tests/unit/application/test_use_cases_fx_audit_ttl.py (new unit tests)
        - tests/integration/test_async_fx_ttl.py (refactored integration test)
        - docs/REFACTORING_RPG_ITERATIONS.yaml (this node expanded)
        - rpg_py_accountant.yaml (new nodes for TTL use cases & DTOs pending next update)
      tests:
        - unit: test_plan_ttl_empty_events_returns_empty_batches
        - unit: test_plan_ttl_negative_retention_raises_validation_error
        - unit: test_plan_ttl_zero_retention_cutoff_now
        - unit: test_plan_ttl_batch_plan_matches_total
        - unit: test_plan_ttl_limit_restricts_old_event_ids
        - unit: test_execute_ttl_dry_run_no_side_effects
        - unit: test_execute_ttl_mode_none_no_side_effects
        - unit: test_execute_ttl_delete_mode_removes_events
        - unit: test_execute_ttl_archive_mode_archives_events (archive+delete)
        - unit: test_execute_ttl_invalid_mode_raises_validation_error
        - unit: test_execute_ttl_no_ids_with_delete_mode_raises
        - integration: test_fx_ttl_plan_and_delete_flow
        - integration: test_fx_ttl_plan_and_archive_flow
        - integration: test_fx_ttl_plan_large_events_batch_sizes
      acceptance_criteria:
        - Planning returns correct UTC cutoff, batch plan covering [0..total_old) without overlaps/gaps
        - limit restricts old_event_ids while total_old reflects full count
        - Execution dry_run produces zero side-effects counts and batches_executed=0
        - mode 'none' produces no side effects regardless of candidate IDs
        - delete removes all targeted old events; archive archives then deletes (counts equal total_old)
        - ValidationError raised for invalid params, modes, empty candidate IDs with destructive modes, batch coverage mismatch
        - No DomainError usage (only ValidationError / ValueError)
        - Updated integration tests pass; legacy xfail removed
        - All public classes/methods have concise docstrings
      risk_mitigation: |
        Snapshot ID list prevents drift during batch execution; archive path refetches rows once per batch (acceptable for current scale). Large scans capped at _MAX_SCAN (100k) to avoid runaway memory. Additional optimization (count query) deferred to later iteration if needed.
      status: done
      completed_at: 2025-11-12
      notes: |
        Implemented TTL planning/execution async use cases; integrated domain service. Removed dependency on deprecated move_events_to_archive. Added DTOs with minimal docstrings. All new unit (11) and integration (3) tests pass. Dry-run logic verified. Error classification consistent with RPG principles. Pending graph update for rpg_py_accountant.yaml in follow-up commit.

    - id: I20
      name: use_cases.reporting_initial
      scope:
        - scaffold reporting use cases using trading balance & fx audit
      dependencies: [I19]
      deliverables:
        - src/application/use_cases/reporting.py
        - tests/unit/application/test_use_cases_reporting.py
      tests:
        - test_parity_report_basic
      acceptance_criteria:
        - Reporting layer composes lower use cases
      risk_mitigation: "Минимальная логика, только композиция."

    # === PRESENTATION (ASYNC CLI) ===
    - id: I21
      name: cli.foundation_async
      scope:
        - introduce Typer async main.py skeleton
      dependencies: [I20]
      deliverables:
        - src/presentation/cli/main.py
        - tests/integration/cli/test_cli_startup.py
      tests:
        - test_cli_starts_help
        - test_cli_version_outputs_version
        - test_cli_ping
      acceptance_criteria:
        - CLI runs help command with usage banner
        - version command prints package version (fallback 'unknown')
        - diagnostics ping prints 'pong' (async loop active)
        - DATABASE_URL_ASYNC absent -> fallback to in-memory URL without error
        - Validation/domain errors produce exit code 2; unexpected -> 1
        - Legacy extended CLI tests (currency/add etc.) marked xfail (deferred to I22+)
        - Public functions (cli, version_cmd, diagnostics_ping) have short docstrings
      risk_mitigation: "Пустой каркас; преддиспетчер для минимальных команд без зависимостей click internals."
      status: done
      completed_at: 2025-11-12
      notes: |
        Async foundation established. Only help/version/diagnostics ping implemented. Legacy Argparse commands removed.
        All out-of-scope CLI tests (currency/add, diagnostics:rates, trading, fx audit, parity-report, maintenance:fx-ttl) marked xfail with reason
        'migrated to async CLI foundation; commands deferred to I22+'. Future iterations (I22–I26) will reintroduce business commands atop Typer.

    - id: I22
      name: cli.currencies_commands
      scope:
        - implement currencies subcommands using async use cases (list/add/set-base)
        - human + JSON output (flag --json)
        - ephemeral async UoW per command (no shared mutable state)
        - lazy schema creation (create_all) via shared helper infra.run_ephemeral_async_uow
      dependencies: [I21]
      deliverables:
        - src/presentation/cli/infra.py (shared CLI helper)
        - src/presentation/cli/currencies.py
        - tests/integration/cli/test_cli_currencies.py
        - docs/REFACTORING_RPG_ITERATIONS.yaml (updated I22 node)
        - rpg_py_accountant.yaml (component AsyncCLICurrencies добавлен)
      tests:
        - test_cli_currency_list_empty_returns_empty_json
        - test_cli_currency_add_list_json
        - test_cli_currency_add_with_rate_and_human_output
        - test_cli_currency_set_base
        - test_cli_currency_set_base_missing_raises
        - test_cli_currency_duplicate_add_raises
      acceptance_criteria:
        - All listed tests pass (green)
        - currency list --json returns [] for fresh DB
        - currency add USD normalizes code upper and is_base False, rate None
        - currency add EUR --rate 1.2500 stores quantized exchange_rate (string) and is_base False
        - currency set-base USD produces single base (USD is_base True, exchange_rate null)
        - duplicate add without rate produces exit code 2 with ValidationError message
        - set-base for missing code exit code 2 with ValidationError message
        - JSON format: [{"code":"USD","is_base":true,"exchange_rate":null}, ...]
        - human format: Currency USD base=True rate=None
        - Exit codes: success=0, validation/domain=2, unexpected=1
        - DATABASE_URL_ASYNC absent -> fallback sqlite+aiosqlite file path (py_accountant_cli.db) works
        - No shared UoW state leaks between commands (fresh instance per invocation)
        - Docstrings present on public command functions and shared helper
        - Legacy diagnostics:rates currency tests removed / xfail count reduced >=2
      risk_mitigation: "Thin controller layer; shared helper centralizes schema creation; isolated file DB per test to avoid cross-test leakage."
      status: done
      completed_at: 2025-11-12
      notes: |
        Implemented async currency CLI sub-app with list/add/set-base commands atop existing async use cases.
        Introduced infra helper (infra.py) for ephemeral UoW + idempotent schema creation, removingEarlier circular import and greenlet issues.
        Added integration test suite (6 scenarios) with per-test isolated SQLite file; all passing.
        Reduced legacy xfail diagnostics currency tests by removing obsolete 'diagnostics:rates' cases.
        JSON/human output formats stabilized; error classification consistent with CLI foundation.

    - id: I23
      name: cli.accounts_commands
      scope:
        - implement accounts subcommands using async use cases (list/add/get optional)
        - human + JSON output (flag --json), stable snake_case keys
        - ephemeral async UoW per command via shared helper (no singletons)
        - thin controllers: parsing/normalization only; validation in domain/use cases
      dependencies: [I22, I15, I16]
      deliverables:
        - src/presentation/cli/accounts.py
        - tests/integration/cli/test_cli_accounts.py
        - docs/REFACTORING_RPG_ITERATIONS.yaml (this node updated)
        - rpg_py_accountant.yaml (component AsyncCLIAccounts добавлен)
      tests:
        - test_cli_account_list_empty_returns_empty_json
        - test_cli_account_add_and_list_json
        - test_cli_account_add_human_output
        - test_cli_account_add_invalid_full_name_raises
        - test_cli_account_add_invalid_currency_code_raises
        - test_cli_account_add_missing_currency_raises
        - test_cli_account_duplicate_add_raises
        - test_cli_account_list_human_format_multiple
        - optional: test_cli_account_get_existing_json
        - optional: test_cli_account_get_missing_raises
        - test_cli_account_add_currency_code_normalized_upper
        - test_cli_account_add_trims_whitespace_full_name
      acceptance_criteria:
        - All mandatory tests green
        - account add normalizes currency code to upper; trims full_name
        - Empty list returns [] for --json; human output is empty without errors
        - Duplicate full_name -> exit 2 with message containing "already exists"
        - Invalid full_name/currency_code -> ValidationError -> exit 2
        - Missing currency on add -> exit 2 (ValueError per use case)
        - JSON formats exactly {"full_name":"..","currency_code":".."} for item and list
        - Output contains no extra fields; list sorted lexicographically by full_name
        - Commands do not require DATABASE_URL_ASYNC (fallback file URL works)
        - No state leakage between commands (fresh UoW per invocation)
        - Public command functions have concise docstrings
        - Legacy argparse account tests reduced by >=2 xfail or replaced
      risk_mitigation: "Sort output, use shared helper, minimal controller logic, explicit dict shaping."
      status: done
      completed_at: 2025-11-12
      notes: "Implemented accounts CLI (list/add/get). All 12 integration tests green; JSON/human форматы стабильны; классификация ошибок согласована. Нормализация (trim/upper) проверена."
    - id: I24
      name: cli.ledger_commands
      scope:
        - add async CLI commands for ledger: post, list, balance (thin controllers)
        - JSON output via --json with strict snake_case keys
        - ephemeral async UoW per command via helper (infra.run_ephemeral_async_uow)
        - parsing/normalization in controller; business validation in domain/use cases
      dependencies: [I23, I17, I21, I22]
      deliverables:
        - src/presentation/cli/ledger.py
        - tests/integration/cli/test_cli_ledger.py
        - docs/REFACTORING_RPG_ITERATIONS.yaml (this node updated)
        - rpg_py_accountant.yaml (component AsyncCLILedger добавлен)
      tests:
        - test_cli_ledger_post_balanced_usd
        - test_cli_ledger_post_unbalanced_raises
        - test_cli_ledger_post_missing_account_raises
        - test_cli_ledger_post_invalid_side_raises
        - test_cli_ledger_post_negative_amount_raises
        - test_cli_ledger_list_json_default_asc
        - test_cli_ledger_list_invalid_order_raises
        - test_cli_ledger_list_invalid_account_format_raises
        - test_cli_ledger_list_pagination_limit_zero_empty
        - test_cli_ledger_balance_self_post_zero
        - test_cli_ledger_window_invalid_dates_raises
        - optional: test_cli_ledger_post_with_memo_and_meta
        - optional: test_cli_ledger_list_with_meta_filter_matches
        - optional: test_cli_ledger_balance_as_of_parsed_utc
      acceptance_criteria:
        - post balanced USD transaction -> exit 0; JSON has id and 2 lines
        - domain/unbalanced or invalid -> exit 2
        - list sorted by occurred_at with order=ASC default; limit=0 -> []
        - balance deterministic string amounts ("0.00") in JSON
        - fallback DATABASE_URL_ASYNC works via helper
        - fresh UoW per command (no state leaks)
        - public command functions have brief docstrings
        - I24 status toggled to done after green test run
      risk_mitigation: "Explicit dict serialization for JSON; date/decimal parsing guarded with ValidationError; use cases handle ordering/pagination."
      status: done
      completed_at: 2025-11-12
      notes: |
        Implemented Typer sub-app 'ledger' with post/list/balance commands. Controllers parse/normalize lines/meta/datetime,
        delegate to async use cases, and output human/JSON with deterministic keys. Added integration tests covering happy/edge cases
        per acceptance criteria; all green. AsyncGetAccountBalance gained a fallback to compute balance via ledger scan when repository
        account_balance is deprecated (I13), preserving async-only path and domain-first validation.

    - id: I25
      name: cli.trading_balance_commands
      scope:
        - add trading balance commands (raw, detailed)
      dependencies: [I24, I21, I22, I23, I17, I18]
      deliverables:
        - src/presentation/cli/trading_balance.py
        - tests/integration/cli/test_cli_trading_balance.py
        - rpg_py_accountant.yaml (component AsyncCLITradingBalance добавлен)
      tests:
        - test_cli_trading_raw_empty_returns_empty_json
        - test_cli_trading_raw_usd_simple
        - test_cli_trading_detailed_eur_converted_to_usd
        - test_cli_trading_window_invalid_dates_raises
        - test_cli_trading_invalid_meta_item_raises
        - test_cli_trading_detailed_missing_base_raises
        - optional: test_cli_trading_raw_with_meta_filter
        - optional: test_cli_trading_detailed_with_explicit_base_ok
        - xfail: test_cli_trading_detailed_non_positive_rate_raises
      acceptance_criteria:
        - trading raw on empty DB returns exit 0 and prints [] with --json
        - USD transactions aggregate into one raw line with correct debit/credit/net (strings)
        - detailed converts EUR to USD with used_rate=6dp and *_base quantized to 2dp
        - invalid date window/meta/base produce exit code 2 with [ERROR] prefix
        - JSON keys strictly match DTO fields; all Decimal values serialized as strings
        - Deterministic ordering by currency_code enforced by domain aggregators (ASC)
        - Per-command ephemeral async UoW (no cross-command state leakage) validated by multiple sequential CLI invocations
        - Public command functions include concise docstrings (3–6 lines) and helpers have brief docstrings
        - rpg_py_accountant.yaml updated with AsyncCLITradingBalance component
        - Iteration marked done with notes after green test run
        - Attempted reduction of legacy xfail CLI trading tests (none remaining for Argparse path)
      risk_mitigation: "Explicit serialization and thin controllers; reuse shared helpers for date/meta parsing; domain sorting guarantees deterministic output."
      status: done
      completed_at: 2025-11-12
      notes: |
        Implemented 'trading' Typer sub-app with 'raw' and 'detailed' commands. Controllers parse ISO dates (naive->UTC),
        meta k=v, optional base (upper/trim), and delegate to AsyncGetTradingBalanceRaw/Detailed with a fresh async UoW per invocation.
        JSON output strictly snake_case with Decimals as strings; human output minimal per line. Added integration tests covering empty,
        simple USD aggregate, EUR converted with rate, invalid params, and optional scenarios. Wired into main CLI, updated graph.
        Full suite green; legacy Argparse trading tests retired. Per-command isolation confirmed by separate DB file runs.

    - id: I26
      name: cli.fx_audit_commands
      scope:
        - add fx audit commands (add-event, list, ttl-archive-plan)
      dependencies: [I25]
      deliverables:
        - src/presentation/cli/fx_audit.py
        - tests/integration/cli/test_cli_fx_audit.py
        - docs/REFACTORING_RPG_ITERATIONS.yaml (this node updated)
        - rpg_py_accountant.yaml (graph updated with AsyncCLIFxAudit component)
      tests:
        - test_cli_fx_add_event_and_list_json
        - test_cli_fx_add_event_invalid_code_raises
        - test_cli_fx_add_event_invalid_rate_raises
        - test_cli_fx_list_filter_by_code
        - test_cli_fx_list_window_invalid_dates_raises
        - test_cli_fx_ttl_plan_basic
        - test_cli_fx_ttl_plan_invalid_params_raises
        - optional: test_cli_fx_list_pagination_limit_zero_empty
        - optional: test_cli_fx_add_event_human_output_smoke
        - optional: test_cli_fx_ttl_plan_human_output_smoke
      acceptance_criteria:
        - fx add-event returns 0; JSON contains id, code, rate (string), occurred_at (ISO), policy_applied, source
        - fx list filters by code and window; order=ASC|DESC; limit=0 -> []
        - ttl-plan computes plan JSON with keys: cutoff, mode, retention_days, batch_size, dry_run, total_old, batches, old_event_ids
        - invalid params (code empty, rate invalid/<=0, bad dates/order/offset/limit/mode/batch_size/retention_days) -> exit 2
        - JSON snake_case; Decimal -> strings; datetimes ISO8601; deterministic ordering by occurred_at
        - per-command ephemeral UoW; DATABASE_URL_ASYNC fallback works
        - public command functions and helpers have short docstrings
      risk_mitigation: "Строгая сериализация JSON; окно и пагинация применяются после фильтрации; логика репозиториев — CRUD-only."
      status: done
      completed_at: 2025-11-12
      notes: |
        Реализован Typer sub-app 'fx' с командами add-event, list и ttl-plan. Контроллеры парсят и нормализуют входы
        (код валюты upper, Decimal rate >0, ISO время naive->UTC), используют эфемерный async UoW и async use cases
        (AsyncAddExchangeRateEvent, AsyncListExchangeRateEvents, AsyncPlanFxAuditTTL). JSON стабильный snake_case, Decimal
        сериализуются как строки с 6 знаками для rate, datetime в ISO. Список детерминирован по occurred_at (ASC по умолчанию);
        пагинация offset/limit применяется после упорядочивания. Добавлены интеграционные тесты, узел помечен done.

    # === REMOVALS & DEPRECATIONS ===
    - id: I27
      name: removal.async_bridge
      scope:
        - delete presentation/async_bridge.py
        - search & replace imports with new CLI calls
      dependencies: [I26]
      deliverables:
        - removed file
        - search report
        - tests/unit/presentation/test_no_async_bridge_imports.py
      tests:
        - test_no_async_bridge_imports
      acceptance_criteria:
        - File absent; no imports remain
      risk_mitigation: "Глобальный grep перед удалением."

    - id: I28
      name: deprecation.sync_repositories
      scope:
        - replace ImportError raise with DeprecationWarning stub OR remove
      dependencies: [I27]
      deliverables:
        - updated repositories.py (or deleted)
        - tests/unit/infrastructure/test_sync_repo_stub.py
      tests:
        - test_sync_repo_import_warns_or_absent
      acceptance_criteria:
        - No hard ImportError
      risk_mitigation: "Докстрока с указанием перехода."

    # === TEST MIGRATION & CLEAN UP ===
    - id: I29
      name: tests.migration_cleanup
      scope:
        - adjust existing tests to new DTOs & ports
        - remove flaky retry tests
      dependencies: [I28]
      deliverables:
        - updated tests tree
        - tests/report/test_cleanup_report.md
      tests:
        - test_all_pass_post_cleanup
      acceptance_criteria:
        - All previous suites green
      risk_mitigation: "Пошагово запускать pytest -k groups."

    # === METRICS & DOCUMENTATION ===
    - id: I30
      name: metrics.baseline_collection
      scope:
        - collect LOC, cyclomatic complexity before refactor finalization
      dependencies: [I29]
      deliverables:
        - metrics/before.json
      tests: []
      acceptance_criteria:
        - Metrics file generated
      risk_mitigation: "Скрипт замера отдельно от основного кода."

    - id: I31
      name: metrics.post_collection
      scope:
        - collect LOC & complexity after changes; compute deltas
      dependencies: [I30]
      deliverables:
        - metrics/after.json
        - metrics/delta.json
      tests: []
      acceptance_criteria:
        - Delta shows target improvements
      risk_mitigation: "Сравнение автоматическое."

    - id: I32
      name: docs.architecture_update
      scope:
        - update ARCHITECTURE_OVERVIEW.md (async-only)
      dependencies: [I31]
      deliverables:
        - docs/ARCHITECTURE_OVERVIEW.md (updated)
      tests:
        - test_docs_sections_present (should still pass)
      acceptance_criteria:
        - Async pathway documented; no sync mentions except migration note
      risk_mitigation: "Сделать diff review."

    - id: I33
      name: docs.migration_history_update
      scope:
        - add "Async Consolidation" section
      dependencies: [I32]
      deliverables:
        - docs/MIGRATION_HISTORY.md (updated)
      tests:
        - test_docs_sections_present (unchanged required header still there)
      acceptance_criteria:
        - New section added without breaking existing headers
      risk_mitigation: "Сохранить требуемые заголовки."

    - id: I34
      name: docs.readme_async_transition
      scope:
        - add README section "Переход на полностью асинхронное ядро"
      dependencies: [I33]
      deliverables:
        - README.md (updated)
      tests:
        - test_docs_sections_present (ENV variables header remains)
      acceptance_criteria:
        - New section present; legacy guidance included
      risk_mitigation: "Не удалять существующий ENV блок."

    - id: I35
      name: final_validation_and_release
      scope:
        - full test run
        - generate final summary report
      dependencies: [I34]
      deliverables:
        - reports/final_summary.md
      tests:
        - pytest full suite
      acceptance_criteria:
        - All suites green; metrics targets met
      risk_mitigation: "Повторный прогон при временных сбоях."

  execution_rules:
    test_first: true
    max_attempts_per_node: 8
    commit_policy: "Commit только после зелёных тестов узла"
    interface_freeze_stage: I11
    allow_backward_shim: I10
    deprecated_cleanup_stage: I28

  quality_gates:
    - name: build
      description: "Проект собирается без ошибок"
    - name: lint
      description: "Нет критических линт ошибок"
    - name: tests
      description: "Все тесты зелёные"
    - name: docs
      description: "Обязательные заголовки присутствуют"
    - name: metrics
      description: "Целевые снижения достигнуты"

  success_metrics_targets:
    loc_infrastructure_reduction_percent: 15
    uow_cyclomatic_reduction_percent: 50
    protocols_count_reduction_factor: 0.5
    test_runtime_reduction_percent: 10
    no_global_singletons: true

  risk_register:
    - risk: legacy_sync_dependency_breakage
      mitigation: provide optional shim (I10) and clear migration section
    - risk: hidden_imports_async_bridge
      mitigation: grep before removal (I27)
    - risk: dto_refactor_breaks_tests
      mitigation: refactor in two steps (I09, I10)
    - risk: overfragmentation
      mitigation: keep iteration scope minimal but coherent domain-first
    - risk: metrics_noise
      mitigation: measure after cleanup (I29) before docs edits
