# RPG Integration Example: ai_context –≤ –≥—Ä–∞—Ñ–µ –ø—Ä–æ–µ–∫—Ç–∞
# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–∞ 2 - —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ rpg_py_accountant.yaml

# –ü—Ä–∏–º–µ—Ä: –∫–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å ai_context —Å–µ–∫—Ü–∏—é –∫ —É–∑–ª—É use case –≤ RPG –≥—Ä–∞—Ñ–µ

nodes:
  - id: N-UC-POST-TX
    name: "AsyncPostTransaction"
    type: use_case
    layer: application
    status: implemented

    # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è RPG (–Ω–µ –º–µ–Ω—è—é—Ç—Å—è)
    dependencies:
      - N-PORT-UOW
      - N-PORT-CLOCK
      - N-DOM-TRANSACTION
      - N-DOM-ENTRY-LINE
      - N-DTO-ENTRY-LINE
      - N-DTO-TRANSACTION

    implementation:
      file: src/py_accountant/application/use_cases_async/ledger.py
      class: AsyncPostTransaction
      lines_of_code: 85

    tests:
      - tests/unit/application/use_cases_async/test_ledger.py::test_post_transaction_success
      - tests/unit/application/use_cases_async/test_ledger.py::test_post_transaction_unbalanced
      - tests/integration/ledger/test_post_transaction_integration.py

    # üÜï AI Context - –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –º–æ–¥–µ–ª–µ–π
    ai_context:
      # –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –≤—Ö–æ–¥–æ–≤/–≤—ã—Ö–æ–¥–æ–≤
      contracts:
        constructor:
          - name: uow
            type: AsyncUnitOfWork
            protocol: true
          - name: clock
            type: Clock
            protocol: true

        input:
          - name: lines
            type: list[EntryLineDTO]
            min_length: 2
            schema:
              full_name: str  # "ASSET:CASH_USD"
              debit: Decimal  # quantized(2)
              credit: Decimal # quantized(2)
          - name: memo
            type: str
          - name: meta
            type: dict | None
            optional: true

        output:
          type: TransactionDTO
          schema:
            transaction_id: int
            posted_at: datetime  # UTC
            memo: str
            lines: list[EntryLineDTO]
            meta: dict | None

        exceptions:
          - ValidationError: "Double-entry invariant violated"
          - ValueError: "Account not found"
          - IntegrityError: "Idempotency key duplicate"

      # Data flow (–∫–æ–º–ø–∞–∫—Ç–Ω–æ)
      dataflow:
        - step: validate
          action: "Check sum(debits) == sum(credits)"
        - step: load_accounts
          action: "uow.accounts.get_by_full_name() for each line"
        - step: create_domain
          action: "Transaction.create(lines, memo, posted_at, meta)"
        - step: persist
          action: "uow.transactions.add() + uow.commit()"
        - step: return_dto
          action: "Convert Transaction ‚Üí TransactionDTO"

      # –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã
      invariants:
        - "sum(line.debit) == sum(line.credit)"
        - "len(lines) >= 2"
        - "all(line.debit >= 0 and line.credit >= 0)"
        - "All amounts quantized to 2 decimals"

      # –ü–∞—Ç—Ç–µ—Ä–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
      usage_pattern: |
        async with async_uow_factory() as uow:
            uc = AsyncPostTransaction(uow, SystemClock())
            result = await uc(
                lines=[EntryLineDTO(...), EntryLineDTO(...)],
                memo="Transaction memo",
                meta={"idempotency_key": "tx-001"}
            )

      # –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏
      common_errors:
        - error: "Unbalanced transaction"
          cause: "sum(debits) != sum(credits)"
          fix: "Ensure double-entry invariant"
        - error: "Account not found"
          cause: "full_name doesn't exist"
          fix: "Create account first with AsyncCreateAccount"

---

# –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:

# 1. –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
#    - –ì—Ä–∞—Ñ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π + –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ
#    - –¢–æ–ø–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ä–∞–∑—É –≤–∏–¥–µ–Ω

# 2. –ö–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç—å
#    - –¢–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
#    - –ë–µ–∑ "—à—É–º–∞" –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞

# 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å RPG
#    - tools/rpg –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å ai_context
#    - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ—Ç–∏–≤ –∫–æ–¥–∞

# 4. –ú–æ–¥—É–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
#    - –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–π —É–∑–µ–ª
#    - –ì—Ä–∞—Ñ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

---

# –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ –º–æ–¥–µ–ª–∏:

# "Implement AsyncCreateAccount use case"

# 1. –ó–∞–≥—Ä—É–∑–∏—Ç—å —É–∑–µ–ª N-UC-CREATE-ACCOUNT –∏–∑ –≥—Ä–∞—Ñ–∞
# 2. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å dependencies ‚Üí –∑–∞–≥—Ä—É–∑–∏—Ç—å N-PORT-UOW, N-DOM-ACCOUNT
# 3. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å ai_context ‚Üí —É–≤–∏–¥–µ—Ç—å contracts, dataflow, invariants
# 4. –ù–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–π —É–∑–µ–ª (N-UC-CREATE-CURRENCY) ‚Üí —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω

# –ò—Ç–æ–≥–æ: ~200-300 —Å—Ç—Ä–æ–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–º–µ—Å—Ç–æ 10,614
