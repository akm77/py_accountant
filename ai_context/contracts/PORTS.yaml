# AI Context: Ports (Protocols)
# Версия: 1.1.0
# Последнее обновление: 2025-11-28
# Назначение: Контракты всех портов для dependency injection

---
# AsyncUnitOfWork
---
AsyncUnitOfWork:
  type: Protocol
  purpose: "Transaction boundary and repository aggregation"
  location: py_accountant.application.ports

  methods:
    - name: __aenter__
      async: true
      returns: Self
      description: "Enter async context"

    - name: __aexit__
      async: true
      args:
        - name: exc_type
          type: type[BaseException] | None
        - name: exc_val
          type: BaseException | None
        - name: exc_tb
          type: TracebackType | None
      returns: None
      description: "Exit async context"

    - name: commit
      async: true
      returns: None
      description: "Commit transaction"
      raises: []

    - name: rollback
      async: true
      returns: None
      description: "Rollback transaction"
      raises: []

  attributes:
    - name: accounts
      type: AsyncAccountRepository
      description: "Account repository"

    - name: currencies
      type: AsyncCurrencyRepository
      description: "Currency repository"

    - name: transactions
      type: AsyncTransactionRepository
      description: "Transaction repository"

    - name: exchange_rate_events
      type: AsyncExchangeRateEventRepository
      description: "Exchange rate event repository"

---
# AsyncAccountRepository
---
AsyncAccountRepository:
  type: Protocol
  purpose: "CRUD for Account domain objects"
  location: py_accountant.application.ports
  rule: "CRUD-only, no business logic"

  methods:
    - name: get_by_full_name
      async: true
      args:
        - name: full_name
          type: str
          format: "TYPE:NAME (e.g., ASSET:CASH_USD)"
      returns: Account | None
      raises:
        - ValidationError: "Invalid full_name format"
      description: "Load account by full_name"

    - name: add
      async: true
      args:
        - name: account
          type: Account
      returns: None
      raises:
        - ValidationError: "Invalid account data"
      description: "Persist new account"

    - name: list_all
      async: true
      returns: list[Account]
      description: "Load all accounts"

    - name: get_balances
      async: true
      args:
        - name: as_of
          type: datetime | None
          default: null
      returns: dict[str, tuple[Decimal, Decimal, Decimal]]
      description: "Get balances for all accounts (debit, credit, net)"

---
# AsyncCurrencyRepository
---
AsyncCurrencyRepository:
  type: Protocol
  purpose: "CRUD for Currency domain objects"
  location: py_accountant.application.ports
  rule: "CRUD-only, no business logic"

  methods:
    - name: get_by_code
      async: true
      args:
        - name: code
          type: str
          format: "ISO 4217 or custom (3 chars)"
      returns: Currency | None
      raises:
        - ValidationError: "Invalid code format"
      description: "Load currency by code"

    - name: add
      async: true
      args:
        - name: currency
          type: Currency
      returns: None
      raises:
        - ValidationError: "Invalid currency data"
      description: "Persist new currency"

    - name: list_all
      async: true
      returns: list[Currency]
      description: "Load all currencies"

    - name: get_base_currency
      async: true
      returns: Currency | None
      description: "Load currency with is_base=True (if exists)"

---
# AsyncTransactionRepository
---
AsyncTransactionRepository:
  type: Protocol
  purpose: "CRUD for Transaction domain objects"
  location: py_accountant.application.ports
  rule: "CRUD-only, no business logic"

  methods:
    - name: get_by_id
      async: true
      args:
        - name: transaction_id
          type: int
      returns: Transaction | None
      description: "Load transaction by ID"

    - name: add
      async: true
      args:
        - name: transaction
          type: Transaction
      returns: None
      raises:
        - ValidationError: "Invalid transaction data"
        - ValidationError: "Double-entry invariant violated"
      description: "Persist new transaction"

    - name: list_all
      async: true
      args:
        - name: limit
          type: int | None
          default: null
        - name: offset
          type: int
          default: 0
      returns: list[Transaction]
      description: "Load transactions with pagination"

---
# AsyncExchangeRateEventRepository
---
AsyncExchangeRateEventRepository:
  type: Protocol
  purpose: "CRUD for ExchangeRateEvent domain objects"
  location: py_accountant.application.ports
  rule: "CRUD-only, no business logic"

  methods:
    - name: add
      async: true
      args:
        - name: event
          type: ExchangeRateEvent
      returns: None
      raises:
        - ValidationError: "Invalid event data"
      description: "Persist new exchange rate event"

    - name: get_latest_rate
      async: true
      args:
        - name: currency_code
          type: str
        - name: as_of
          type: datetime
      returns: Decimal | None
      description: "Get latest rate <= as_of"

    - name: list_events
      async: true
      args:
        - name: currency_code
          type: str | None
          default: null
        - name: start_date
          type: datetime | None
          default: null
        - name: end_date
          type: datetime | None
          default: null
      returns: list[ExchangeRateEvent]
      description: "List events with optional filters"

    - name: count_old_events
      async: true
      args:
        - name: cutoff
          type: datetime
      returns: int
      description: "Count events older than cutoff (for TTL)"

    - name: delete_old_events
      async: true
      args:
        - name: cutoff
          type: datetime
        - name: batch_size
          type: int
      returns: int
      description: "Delete old events, return count (for TTL)"

    - name: archive_old_events
      async: true
      args:
        - name: cutoff
          type: datetime
        - name: batch_size
          type: int
      returns: int
      description: "Archive old events, return count (for TTL)"

---
# Clock
---
Clock:
  type: Protocol
  purpose: "Time provider for deterministic testing"
  location: py_accountant.application.ports

  methods:
    - name: now
      async: false
      returns: datetime
      description: "Current datetime (UTC)"
      note: "Use SystemClock for production, FixedClock for tests"

---
# Usage Patterns
---
usage_patterns:
  dependency_injection:
    description: "All use cases accept ports via constructor"
    example: |
      @dataclass(slots=True)
      class AsyncCreateAccount:
          uow: AsyncUnitOfWork

          async def __call__(self, ...) -> AccountDTO:
              async with self.uow:
                  # use self.uow.accounts, self.uow.currencies, etc.
                  await self.uow.commit()

  repository_usage:
    description: "Repositories return domain objects or None"
    example: |
      account = await uow.accounts.get_by_full_name("ASSET:CASH_USD")
      if account is None:
          raise ValueError("Account not found")

  uow_transaction:
    description: "Use async context manager for transactions"
    example: |
      async with uow:
          # ... do work with repositories
          await uow.commit()  # or rollback on exception

---
# Key Rules
---
rules:
  - "All repositories are CRUD-only (no business logic)"
  - "Repositories return domain objects, not DTOs"
  - "Use cases convert domain objects to/from DTOs"
  - "Clock.now() returns UTC datetime"
  - "All async operations use async/await"
  - "UoW commits only after all validations pass"
  - "Repositories raise ValidationError on invalid input"
