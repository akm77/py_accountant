{
  "version": "1.0",
  "project": "py_accountant",
  "updated": "2025-11-28",
  "snippets": [
    {
      "id": "arch-basic",
      "name": "Базовая архитектура",
      "category": "architecture",
      "size_lines": 15,
      "use_case": "При любой разработке",
      "content": "## Architecture Context\n\n**py_accountant** - async-first бухгалтерская система\n- Архитектура: Ports & Adapters (Hexagonal)\n- Слои: Domain (чистый) → Application (use cases) → Infrastructure (I/O)\n- Правило: Domain не зависит от Application/Infrastructure\n- Async только: все use cases и repositories async\n- Версия: 1.1.0 | Schema: 0008_add_account_aggregates\n\n**Dependency Rule**:\n```\nInfrastructure → Application → Domain\n           ↓           ↓\n    (implements)  (defines ports)\n```"
    },
    {
      "id": "ports",
      "name": "Контракты портов",
      "category": "contracts",
      "size_lines": 25,
      "use_case": "При создании/модификации use cases",
      "content": "## Ports (Protocols)\n\n### AsyncUnitOfWork\n```python\nclass AsyncUnitOfWork(Protocol):\n    accounts: AsyncAccountRepository\n    currencies: AsyncCurrencyRepository\n    transactions: AsyncTransactionRepository\n    exchange_rate_events: AsyncExchangeRateEventRepository\n    \n    async def __aenter__(self) -> Self: ...\n    async def __aexit__(self, ...): ...\n    async def commit(self): ...\n    async def rollback(self): ...\n```\n\n### AsyncAccountRepository\n```python\nclass AsyncAccountRepository(Protocol):\n    async def get_by_full_name(self, full_name: str) -> Account | None: ...\n    async def add(self, account: Account) -> None: ...\n    async def list_all(self) -> list[Account]: ...\n    async def get_balances(self, as_of: datetime | None = None) -> dict: ...\n```\n\n**Rule**: CRUD-only, return domain objects (not DTOs), return None (not raise)"
    },
    {
      "id": "dtos",
      "name": "Основные DTOs",
      "category": "contracts",
      "size_lines": 35,
      "use_case": "При работе с входами/выходами use cases",
      "content": "## Core DTOs\n\n### EntryLineDTO (input for transactions)\n```python\n@dataclass\nclass EntryLineDTO:\n    full_name: str        # \"ASSET:CASH_USD\"\n    debit: Decimal        # quantized to 2 decimals\n    credit: Decimal       # quantized to 2 decimals\n```\n\n### TransactionDTO (output)\n```python\n@dataclass\nclass TransactionDTO:\n    transaction_id: int\n    posted_at: datetime   # UTC\n    memo: str\n    lines: list[EntryLineDTO]\n    meta: dict | None\n```\n\n### AccountDTO\n```python\n@dataclass\nclass AccountDTO:\n    full_name: str        # \"TYPE:NAME\"\n    account_type: str     # ASSET|LIABILITY|EQUITY|REVENUE|EXPENSE\n    name: str\n    currency_code: str\n    metadata: dict | None\n```\n\n**Serialization**: Decimal → string, datetime → ISO8601 UTC, keys → snake_case"
    },
    {
      "id": "quantization",
      "name": "Квантизация",
      "category": "rules",
      "size_lines": 25,
      "use_case": "При работе с Decimal (всегда!)",
      "content": "## Quantization Rules\n\n**CRITICAL**: All Decimal values MUST be quantized\n\n```python\nfrom py_accountant.domain.quantize import money_quantize, rate_quantize\nfrom decimal import Decimal\n\n# Money (2 decimals, ROUND_HALF_EVEN)\namount = money_quantize(Decimal(\"100.123\"))  # → 100.12\n\n# Rates (6 decimals, ROUND_HALF_EVEN)\nrate = rate_quantize(Decimal(\"1.234567\"))    # → 1.234567\n\n# FX conversion\namount_base = money_quantize(amount * rate)  # → 2 decimals\n```\n\n**Rules**:\n- ✓ Quantize AFTER arithmetic, BEFORE persistence\n- ✓ Use Decimal, NEVER float\n- ✗ Don't quantize intermediate steps (preserve precision)\n\n**Why ROUND_HALF_EVEN**: Banker's rounding reduces bias"
    },
    {
      "id": "invariants",
      "name": "Инварианты домена",
      "category": "rules",
      "size_lines": 30,
      "use_case": "При реализации бизнес-логики",
      "content": "## Domain Invariants\n\n### Double-Entry (CRITICAL)\n```python\n# sum(debits) == sum(credits)\ntotal_debit = sum(line.debit for line in lines)\ntotal_credit = sum(line.credit for line in lines)\nif total_debit != total_credit:\n    raise ValidationError(\"Transaction does not balance\")\n```\n\n### Account Validation\n- full_name pattern: `^[A-Z0-9]+:[A-Z0-9_]+$` (e.g., \"ASSET:CASH_USD\")\n- account_type: ASSET | LIABILITY | EQUITY | REVENUE | EXPENSE\n- currency_code must exist\n\n### Transaction Rules\n- Minimum 2 lines\n- debit >= 0 AND credit >= 0\n- NOT (debit > 0 AND credit > 0) - one side must be zero\n- All amounts quantized to 2 decimals\n\n### FX Conversion\n- Base currency: rate = 1.0 (always)\n- Non-base: rate > 0 (must exist)\n- Conversion: amount_base = money_quantize(amount * rate)"
    },
    {
      "id": "use-case-pattern",
      "name": "Паттерн use case",
      "category": "patterns",
      "size_lines": 55,
      "use_case": "При создании нового use case",
      "content": "## Use Case Pattern\n\n```python\nfrom dataclasses import dataclass\nfrom py_accountant.application.ports import AsyncUnitOfWork\nfrom py_accountant.application.dto import SomeDTO\n\n@dataclass(slots=True)\nclass AsyncSomeUseCase:\n    \"\"\"Use case description.\n    \n    Args:\n        param1: Description\n        param2: Description\n    \n    Returns:\n        ResultDTO\n    \n    Raises:\n        ValidationError: When domain invariant violated\n        ValueError: When resource not found\n    \"\"\"\n    \n    uow: AsyncUnitOfWork  # Dependency injection\n    # other dependencies (Clock, etc.)\n    \n    async def __call__(self, param1: Type1, param2: Type2) -> ResultDTO:\n        \"\"\"Execute the use case.\"\"\"\n        async with self.uow:\n            # 1. Load dependencies from UoW\n            entity = await self.uow.some_repo.get_by_id(param1)\n            if entity is None:\n                raise ValueError(f\"Not found: {param1}\")\n            \n            # 2. Validate input\n            # 3. Create/modify domain objects\n            # 4. Persist via repositories\n            await self.uow.some_repo.add(entity)\n            \n            # 5. Commit UoW\n            await self.uow.commit()\n            \n            # 6. Return DTO\n            return ResultDTO(...)\n```\n\n**Rules**:\n- ✓ Async only\n- ✓ Dependencies via constructor (DI)\n- ✓ Use UoW for transaction boundary\n- ✓ Convert: DTO → Domain → DTO\n- ✗ No business logic in use case (delegate to domain)"
    },
    {
      "id": "constraints",
      "name": "Архитектурные ограничения",
      "category": "architecture",
      "size_lines": 40,
      "use_case": "Для проверки правильности дизайна",
      "content": "## Architecture Constraints\n\n### Layer Rules\n\n**Domain** (py_accountant.domain)\n- ✓ CAN: Pure functions, validate invariants, raise DomainError/ValidationError\n- ✗ CANNOT: I/O, async/await, import from application/infrastructure\n\n**Application** (py_accountant.application)\n- ✓ CAN: Orchestrate domain, use repos via ports, async/await, convert DTOs\n- ✗ CANNOT: Implement repos, import from infrastructure, business logic\n\n**Infrastructure** (py_accountant.infrastructure)\n- ✓ CAN: Implement repos, DB I/O, import from application/domain\n- ✗ CANNOT: Business logic (delegate to domain)\n\n### Repository Rules\n- CRUD-only (no business logic)\n- Return domain objects (not DTOs)\n- Return None for not found (don't raise)\n- Raise ValidationError on invalid input\n\n### Use Case Rules\n- Async only\n- Dependency injection via constructor\n- Use UoW for transaction boundary\n- No business logic (orchestrate domain instead)\n\n### Import Rules\n```python\n# ✓ ALLOWED\nfrom py_accountant.application.ports import AsyncUnitOfWork\nfrom py_accountant.domain.account import Account\n\n# ✗ FORBIDDEN in application layer\nfrom py_accountant.infrastructure.persistence import SqlAlchemyRepo\n```"
    },
    {
      "id": "quick-card",
      "name": "Quick Reference Card",
      "category": "summary",
      "size_lines": 35,
      "use_case": "Быстрый старт, минимальный контекст",
      "content": "## py_accountant Quick Ref\n\n**Architecture**: Ports & Adapters | **Version**: 1.1.0 | **Async-only**\n\n### Use Case Pattern\n```python\n@dataclass(slots=True)\nclass AsyncSomeUseCase:\n    uow: AsyncUnitOfWork\n    async def __call__(self, ...) -> DTO:\n        async with self.uow:\n            # validate → load → create domain → persist → commit → return DTO\n            await self.uow.commit()\n            return DTO(...)\n```\n\n### Quantization\n```python\nfrom py_accountant.domain.quantize import money_quantize, rate_quantize\namount = money_quantize(Decimal(\"100.123\"))  # → 100.12\n```\n\n### Invariants\n- **Double-entry**: sum(debits) == sum(credits)\n- **Account format**: \"TYPE:NAME\"\n- **Repos**: CRUD-only, return domain objects\n\n### Rules\n- ✓ Decimal (NOT float)\n- ✓ Quantize after arithmetic\n- ✓ Async + UoW transaction\n- ✗ No infra imports in application"
    }
  ],
  "scenarios": [
    {
      "name": "Новый use case",
      "snippets": ["arch-basic", "ports", "dtos", "invariants", "use-case-pattern"],
      "total_lines": 150,
      "savings_percent": 98.6
    },
    {
      "name": "Доработка кода",
      "snippets": ["quantization", "invariants", "use-case-pattern"],
      "total_lines": 110,
      "savings_percent": 99.0
    },
    {
      "name": "Быстрый старт",
      "snippets": ["quick-card"],
      "total_lines": 35,
      "savings_percent": 99.7
    },
    {
      "name": "Архитектурный ревью",
      "snippets": ["arch-basic", "constraints"],
      "total_lines": 55,
      "savings_percent": 99.5
    }
  ],
  "statistics": {
    "total_snippets": 8,
    "traditional_context_lines": 10614,
    "average_snippet_lines": 32,
    "average_savings_percent": 99.1
  }
}

