rpg:
  metadata:
    project_name: "py_accountant"
    version: "1.1.0"
    description: "Монорепозиторий: домен/приложение/инфраструктура. Цель — Clean Architecture с core-only интеграцией через порты и use cases."
    last_updated: "2025-11-26"
    changelog:
      - version: "1.1.0"
        date: "2025-11-26"
        changes:
          - "DOC-REORG: Реорганизована структура документации"
          - "DOC-REORG: Создана папка docs/audit/ (gitignored) для audit материалов"
          - "DOC-REORG: Перемещены 20 файлов в docs/audit/ (AUDIT_*, SPRINT_*, DOCUMENTATION_*, FINAL_REPORT)"
          - "DOC-REORG: docs/ теперь содержит ТОЛЬКО продуктовую документацию (17 files)"
          - "DOC-REORG: Обновлён .gitignore (docs/audit/ excluded)"
          - "DOC-REORG: Обновлён INDEX.md (removed audit sections, clean product docs)"
          - "DOC-REORG: Упрощён CHANGELOG.md (product changes only)"
          - "DOC-REORG: Упрощён README.md (condensed Documentation Quality section)"
          - "DOC-REORG: Обновлены тесты (skip docs/audit/, reduced threshold 50→40)"
          - "DOC-REORG: Все 18 тестов проходят (0.33s execution time) ✅"
          - "DOC-REORG: Чистое разделение: product docs ↔ audit materials"
          - "DOC-REORG: Документация готова к production use"
          - "DOC-S8: Финальная сверка и обновление индекса завершены"
          - "DOC-S8: Создан docs/CHANGELOG.md (Keep a Changelog format, S1-S8 history)"
          - "DOC-S8: Создан docs/DOCUMENTATION_UPDATE_REPORT.md (700+ lines, comprehensive report)"
          - "DOC-S8: Обновлён docs/INDEX.md (version 1.1.0, качество, быстрый старт)"
          - "DOC-S8: Обновлён README.md (Documentation Quality section)"
          - "DOC-S8: Добавлены navigation footers в 10+ документов"
          - "DOC-S8: Создан docs/SPRINT_S8_COMPLETED.md с comprehensive отчётом"
          - "DOC-S8: Все 18 тестов документации проходят (18 passed, 0 failed) ✅"
          - "DOC-S8: Integration time: 30 minutes (target achieved, 8x improvement)"
          - "DOC-S8: Обновлён prompts/sprint_graph.yaml (S8 completed)"
      - version: "1.1.0-S7"
        date: "2025-11-25"
        changes:
          - "DOC-S7: Исправлены все оставшиеся проблемы, обнаруженные тестами документации"
          - "DOC-S7: Исправлен broken link в FINAL_REPORT.md (пример markdown-ссылки)"
          - "DOC-S7: Исправлен malformed code block в examples/cli_basic/README.md"
          - "DOC-S7: Все тесты документации теперь проходят (18 passed, 0 failed) ✅"
          - "DOC-S7: Документация полностью валидна: code examples, links, imports, config"
          - "DOC-S7: Создан docs/SPRINT_S7_COMPLETED.md с отчётом о завершении"
          - "DOC-S7: Обновлён prompts/sprint_graph.yaml (S7 completed)"
          - "DOC-S7: Большинство syntax errors было исправлено в процессе S6"
      - version: "1.1.0-S6"
        date: "2025-11-25"
        changes:
          - "DOC-S6: Созданы автоматизированные тесты для документации (15 тестов)"
          - "DOC-S6: tests/docs/test_code_examples.py — валидация 60+ блоков кода (5 тестов)"
          - "DOC-S6: tests/docs/test_links.py — проверка 50+ внутренних ссылок (4 теста)"
          - "DOC-S6: tests/docs/test_imports.py — валидация 20+ импортов py_accountant (3 теста)"
          - "DOC-S6: tests/docs/test_config_variables.py — проверка 27 переменных окружения (3 теста)"
          - "DOC-S6: Тесты интегрированы в pytest framework"
          - "DOC-S6: Проверка отсутствия legacy references (sdk, presentation.cli)"
          - "DOC-S6: Проверка предпочтения async use cases над sync"
          - "DOC-S6: Создан tests/docs/README.md с описанием тестов"
          - "DOC-S6: Все тесты проходят, общее время выполнения < 5 секунд"
          - "DOC-S6: Тесты обнаружили реальные баги: 12 syntax errors в API_REFERENCE.md"
          - "DOC-S6: Исправлены 2 broken links в docs/AUDIT_PRIORITIES.md"
          - "DOC-S6: Создан docs/SPRINT_S6_COMPLETED.md с отчётом о завершении"
          - "DOC-S6: Обновлён prompts/sprint_graph.yaml (S6 completed)"
      - version: "1.1.0-S5"
        date: "2025-11-25"
        changes:
          - "DOC-S5: Создан CONFIG_REFERENCE.md — полный справочник по конфигурации (2000+ строк)"
          - "DOC-S5: Документированы все 27 переменных окружения с примерами и валидацией"
          - "DOC-S5: Добавлен раздел Configuration Deep Dive в INTEGRATION_GUIDE.md"
          - "DOC-S5: Объяснена dual-URL architecture (DATABASE_URL + DATABASE_URL_ASYNC)"
          - "DOC-S5: Документирован docker-compose.yml с детальными комментариями"
          - "DOC-S5: Создан .env.docker для Docker окружения"
          - "DOC-S5: Создан tools/validate_config.py для валидации конфигурации"
          - "DOC-S5: Добавлены примеры для dev/staging/prod окружений"
          - "DOC-S5: Документированы FX TTL modes (none/delete/archive)"
          - "DOC-S5: Добавлены secrets management примеры (AWS, K8s, Vault)"
          - "DOC-S5: Добавлен Troubleshooting раздел с типичными проблемами"
          - "DOC-S5: Обновлён docs/INDEX.md со ссылкой на CONFIG_REFERENCE.md"
          - "DOC-S5: Обновлён README.md с секцией API и конфигурация"
      - version: "1.1.0-S4"
        date: "2025-11-25"
        changes:
          - "DOC-S4: Создан API_REFERENCE.md — полный справочник публичного API (1500+ строк)"
          - "DOC-S4: Задокументированы все 17 async use cases с детальными примерами и сигнатурами"
          - "DOC-S4: Задокументированы все 6 protocols (Clock, AsyncUnitOfWork, AsyncCurrencyRepository, AsyncAccountRepository, AsyncTransactionRepository, AsyncExchangeRateEventsRepository)"
          - "DOC-S4: Задокументированы 14 основных DTOs с полями и примерами использования"
          - "DOC-S4: Добавлена карта API: таблицы use cases, protocols, DTOs"
          - "DOC-S4: Добавлен раздел Migration Guide (sync → async)"
          - "DOC-S4: Создан инструмент generate_api_docs.py для автоматизации извлечения сигнатур"
          - "DOC-S4: Создан валидатор extract_and_validate_code_examples.py для проверки синтаксиса примеров"
          - "DOC-S4: Обновлён docs/INDEX.md со ссылкой на API_REFERENCE.md"
          - "DOC-S4: Обновлён README.md с секцией Documentation и ссылкой на API Reference"
      - version: "1.1.0-S3"
        date: "2025-11-25"
        changes:
          - "DOC-S3: Создан CHANGELOG.md для telegram_bot example (подтверждена совместимость с async API)"
          - "DOC-S3: Создан полнофункциональный пример FastAPI REST API (examples/fastapi_basic/)"
          - "DOC-S3: Создан полнофункциональный пример CLI с Typer (examples/cli_basic/)"
          - "DOC-S3: Добавлены примеры интеграции FastAPI и CLI в INTEGRATION_GUIDE.md"
          - "DOC-S3: Обновлён examples/__init__.py с документацией всех примеров"
          - "DOC-S3: Все примеры используют async-first API и AsyncSqlAlchemyUnitOfWork"
          - "DOC-S3: Все примеры имеют README.md, requirements.txt и рабочий код"
          - "DOC-S3: Проверен синтаксис Python для всех новых файлов"
      - version: "1.1.0-S2"
        date: "2025-11-25"
        changes:
          - "DOC-S2: Исправлены все 6 критических проблем P0 из AUDIT_PRIORITIES.md"
          - "DOC-S2: FX_AUDIT.md — заменены CLI команды на Python API (AsyncAddExchangeRateEvent, AsyncListExchangeRateEvents, AsyncPlanFxAuditTTL)"
          - "DOC-S2: RUNNING_MIGRATIONS.md — заменена CLI команда на Python API (AsyncGetTradingBalanceDetailed)"
          - "DOC-S2: TRADING_WINDOWS.md — заменены CLI команды на Python API (AsyncGetTradingBalanceRaw с примерами фильтров)"
          - "DOC-S2: README.md — добавлен async пример AsyncGetAccountBalance рядом с sync (deprecated)"
          - "DOC-S2: README.md — добавлено предупреждение об async-first архитектуре и deprecation sync API в v2.0.0"
          - "DOC-S2: ARCHITECTURE_OVERVIEW.md — удалены упоминания Presentation/CLI layer, добавлено примечание о core-only архитектуре с v1.0.0"
          - "DOC-S2: Удалено 6 ссылок на presentation.cli.main из документации"
          - "DOC-S2: Все примеры теперь используют актуальные async use cases из py_accountant.application.use_cases_async"
      - version: "1.1.0-S1"
        date: "2025-11-25"
        changes:
          - "DOC-S1: Проведён полный аудит документации (Спринт S1)"
          - "DOC-S1: Создана инвентаризация 16 документов (docs/AUDIT_INVENTORY.md)"
          - "DOC-S1: Найдено 11 упоминаний удалённых компонентов в 5 файлах (docs/AUDIT_REMOVED_COMPONENTS.md)"
          - "DOC-S1: Создана матрица соответствия документация↔код (docs/AUDIT_CODE_MAPPING.md)"
          - "DOC-S1: Приоритизировано 42 проблемы: P0=6, P1=8, P2=15, P3=13 (docs/AUDIT_PRIORITIES.md)"
          - "DOC-S1: Выявлено покрытие документацией: use cases 44%, protocols 33%, DTOs 30%"
          - "DOC-S1: Критические находки: 4 неработающих CLI примера, 6 ссылок на presentation.cli"
      - version: "1.0.2"
        date: "2025-11-25"
        changes:
          - "DOC-GRAPH: Создан граф спринтов для обновления документации (prompts/sprint_graph.yaml)"
          - "DOC-GRAPH: Созданы детальные промпты для 8 спринтов (prompts/sprint_*.md)"
          - "DOC-GRAPH: Каждый промпт следует методологии RPG с явными критериями успеха"
          - "DOC-GRAPH: Промпты разбиты для работы в пределах контекста LLM"
          - "DOC-GRAPH: Запланировано устранение 50+ упоминаний удалённых компонентов"
      - version: "1.0.1"
        date: "2025-11-24"
        changes:
          - "DOC-PLAN: Создан план исправления документации (DOCUMENTATION_FIX_PROPOSAL.md)"
          - "DOC-PLAN: Выявлено 10 проблем в документации после миграции на core-only"
          - "DOC-PLAN: Предложено 3-фазное решение с автоматизацией и тестами"
          - "DOC-PLAN: Добавлен узел 'documentation' в RPG-граф"
      - version: "1.0.0"
        date: "2025-11-24"
        changes:
          - "Удалён узел 'presentation' (реализуется в интеграторах)"
          - "Добавлена версионность RPG-графа"
          - "Удалён legacy module application/interfaces/ports.py"
          - "Обновлены импорты на application.ports"
      - version: "0.9.0"
        date: "2025-11-23"
        changes:
          - "CORE-01: Переход на core-only интеграцию"
          - "I29: Удаление legacy sync UoW и репозиториев"
          - "ASYNC-03-06: Полный async API"
    environments:
      - name: "test"
        description: "Тестовая среда: локальный запуск, in-memory или локальный Postgres, подробные логи."
        env_vars:
          - name: "ENV"
            required: true
            notes: "ENV=test"
          - name: "DATABASE_URL"
            required: true
            notes: "sqlite+pysqlite:///:memory: или локальный Postgres (sync для Alembic)"
          - name: "DATABASE_URL_ASYNC"
            required: false
            notes: "Опционально: async runtime URL (postgresql+asyncpg://..., sqlite+aiosqlite:///:memory:)"
          - name: "LOG_LEVEL"
            required: false
            notes: "DEBUG"
          - name: "JSON_LOGS"
            required: false
            notes: "false"
          - name: "LOG_FILE"
            required: false
            notes: "Путь к файлу логов. Включает файловый хендлер только при JSON_LOGS=true."
          - name: "LOG_ROTATION"
            required: false
            notes: "Ротация: 'time' (по времени, по умолчанию) или 'size' (по размеру)."
          - name: "LOG_MAX_BYTES"
            required: false
            notes: "Максимальный размер файла (для 'size'), по умолчанию 10MiB."
          - name: "LOG_BACKUP_COUNT"
            required: false
            notes: "Число резервных файлов, по умолчанию 7."
          - name: "LOG_ROTATE_WHEN"
            required: false
            notes: "Гранулярность для 'time' (например 'midnight')."
          - name: "LOG_ROTATE_UTC"
            required: false
            notes: "Использовать UTC для тайм-ротации (true по умолчанию)."
          - name: "FX_TTL_MODE"
            required: false
            notes: "none|delete|archive (по умолчанию none)"
          - name: "FX_TTL_RETENTION_DAYS"
            required: false
            notes: "Число дней хранения событий (например 90)"
          - name: "FX_TTL_BATCH_SIZE"
            required: false
            notes: "Размер партии TTL/архива (например 1000)"
          - name: "FX_TTL_DRY_RUN"
            required: false
            notes: "Сухой прогон, не изменяет БД"
      - name: "production"
        description: "Продакшен: Postgres, структурированные JSON-логи, минимальные права."
        env_vars:
          - name: "ENV"
            required: true
            notes: "ENV=production"
          - name: "DATABASE_URL"
            required: true
            notes: "postgresql+psycopg://... (для Alembic миграций)"
          - name: "DATABASE_URL_ASYNC"
            required: true
            notes: "postgresql+asyncpg://... (runtime)"
          - name: "LOG_LEVEL"
            required: true
            notes: "INFO или WARN"
          - name: "JSON_LOGS"
            required: true
            notes: "true"
          - name: "LOG_FILE"
            required: false
            notes: "Рекомендуется указать путь до файла для ротации JSON логов."
          - name: "LOG_ROTATION"
            required: false
            notes: "'time' (по умолчанию, ротация в полночь) или 'size'."
          - name: "LOG_MAX_BYTES"
            required: false
            notes: "Размер для 'size' ротации (например 10485760 для 10MiB)."
          - name: "LOG_BACKUP_COUNT"
            required: false
            notes: "Количество архивов логов (по умолчанию 7)."
          - name: "LOG_ROTATE_WHEN"
            required: false
            notes: "Период ротации при 'time' (по умолчанию midnight)."
          - name: "LOG_ROTATE_UTC"
            required: false
            notes: "Использовать UTC (true) или локальное время."
          - name: "FX_TTL_MODE"
            required: false
            notes: "Режим TTL для exchange_rate_events: none|delete|archive"
          - name: "FX_TTL_RETENTION_DAYS"
            required: false
            notes: "Порог давности в днях (рекомендуемо 90+)"
          - name: "FX_TTL_BATCH_SIZE"
            required: false
            notes: "Размер партии (по умолчанию 1000)"
          - name: "FX_TTL_DRY_RUN"
            required: false
            notes: "Сухой прогон, не изменяет БД"

  nodes:
    modules:
      - name: "application"
        path: "src/py_accountant/application"
        description: "Сценарии (use cases), DTO и интерфейсы портов (репозитории, UоW, Clock) для core-only пакета `py_accountant`. Интеграторы импортируют только py_accountant.application.*."
      - name: "use_cases_async"
        path: "src/py_accountant/application/use_cases_async"
        description: "Async use cases: currencies/accounts/ledger/trading/fx audit (параллельно sync)."
      - name: "domain"
        path: "src/py_accountant/domain"
        description: "Чистый домен: value-объекты, агрегаты, сервисы (баланс, курсы)."
      - name: "domain.errors"
        path: "src/py_accountant/domain/errors.py"
        description: "Минимальный модуль исключений домена: DomainError, ValidationError (без зависимостей)."
      - name: "domain.quantize"
        path: "src/py_accountant/domain/quantize.py"
        description: "Утилиты квантования: money_quantize, rate_quantize (ROUND_HALF_EVEN, локальный контекст, без изменения глобального Decimal)."
      - name: "domain.currencies"
        path: "src/py_accountant/domain/currencies.py"
        description: "Value object Currency и сервис BaseCurrencyRule: единственная базовая валюта, нормализация курсов через rate_quantize, без пересчёта остальных."
      - name: "domain.accounts"
        path: "src/py_accountant/domain/accounts.py"
        description: "Value object Account: валидация full_name (иерархия через ':'), derive name/parent_path, нормализация currency_code (upper, 3..10), parent_id опционален."
      - name: "domain.ledger"
        path: "src/py_accountant/domain/ledger.py"
        description: "Валидатор баланса LedgerValidator: мультивалютная сверка в базовой валюте (money_quantize), без инфраструктурных зависимостей."
      - name: "domain.trading_balance"
        path: "src/py_accountant/domain/trading_balance.py"
        description: "RawAggregator.aggregate и ConvertedAggregator.aggregate для торгового баланса; чистая доменная логика."
      - name: "domain.fx_audit"
        path: "src/py_accountant/domain/fx_audit.py"
        description: "FX Audit TTL domain service: FxAuditTTLService с make_cutoff/identify_old/batch_plan; чистая логика без I/O."
      - name: "TTLUseCases"
        path: "src/py_accountant/application/use_cases_async/fx_audit_ttl.py"
        description: "Async TTL use cases for FX audit: план и выполнение archival/delete через FxAuditTTLService; репозитории остаются CRUD-only."
      - name: "infrastructure"
        path: "src/py_accountant/infrastructure"
        description: "Адаптеры: SQLAlchemy, миграции Alembic, внешние сервисы, реализация портов."
      - name: "config"
        path: "src/py_accountant/infrastructure/config"
        description: "Конфигурация приложения на pydantic-settings; выбор профиля окружения."
      - name: "logging"
        path: "src/py_accountant/infrastructure/logging"
        description: "Структурированное логирование на structlog; единая инициализация логгера."
      - name: "async_engine"
        path: "src/py_accountant/infrastructure/persistence/sqlalchemy/async_engine.py"
        description: "Async фабрики: normalize_async_url, get_async_engine, get_async_session_factory."
      - name: "repositories_async"
        path: "src/py_accountant/infrastructure/persistence/sqlalchemy/repositories_async.py"
        description: "Async реализации портов репозиториев на SQLAlchemy: CRUD + TTL примитивы, fast-path accounts.get_balance и агрегаты account_balances/account_daily_turnovers."
      - name: "asyncio_utils"
        path: "src/py_accountant/infrastructure/utils/asyncio_utils.py"
        description: "Helper run_sync(coro): безопасный запуск корутин из sync-контекста."
      - name: "currencies (use cases)"
        path: "src/py_accountant/application/use_cases_async/currencies.py"
        description: "Async currencies use cases: валидация и выбор базовой валюты; репозитории — только CRUD."
      - name: "accounts"
        path: "src/py_accountant/application/use_cases_async/accounts.py"
        description: "Async аккаунты: создание/получение/список; используют domain.Account и репозитории."
      - name: "ledger"
        path: "src/py_accountant/application/use_cases/ledger.py"
        description: "Sync ledger и балансы: PostTransaction, GetBalance, GetLedger, ListLedger, GetTradingBalanceRawDTOs, GetTradingBalanceDetailedDTOs."
      - name: "fx_audit"
        path: "src/py_accountant/application/use_cases_async/fx_audit.py"
        description: "Async FX audit: AsyncAddExchangeRateEvent, AsyncListExchangeRateEvents."
      - name: "trading_balance"
        path: "src/py_accountant/application/use_cases_async/trading_balance.py"
        description: "Async trading balance use cases через domain RawAggregator & ConvertedAggregator."
      - name: "fx_audit_ttl"
        path: "src/py_accountant/application/use_cases_async/fx_audit_ttl.py"
        description: "AsyncPlanFxAuditTTL и AsyncExecuteFxAuditTTL: планирование и выполнение TTL/архивации."
      - name: "src/py_accountant/infrastructure/persistence/sqlalchemy/models.py"
        parent_module: "infrastructure"
        description: "ORM schema: CurrencyORM, AccountORM, JournalORM, TransactionLineORM, ExchangeRateEventORM, ExchangeRateEventArchiveORM, AccountBalanceORM, AccountDailyTurnoverORM."
      - name: "src/py_accountant/infrastructure/persistence/sqlalchemy/repositories_async.py"
        parent_module: "infrastructure"
        description: "Async реализации портов репозиториев на SQLAlchemy: CRUD + TTL примитивы и агрегаты."
      - name: "src/py_accountant/infrastructure/persistence/sqlalchemy/uow.py"
        parent_module: "infrastructure"
        description: "AsyncSqlAlchemyUnitOfWork only (legacy sync UoW удалён)."
      - name: "docs/RUNNING_MIGRATIONS.md"
        parent_module: "infrastructure"
        description: "Helper для CI: запуск Alembic миграций, примеры GitHub Actions/GitLab, checklist."
      - name: "src/py_accountant/infrastructure/utils/asyncio_utils.py"
        parent_module: "infrastructure"
        description: "run_sync(coro): запрет nested loop, корректное закрытие корутины при ошибке."
      - name: "documentation"
        path: "docs/"
        description: "Документация проекта и планы улучшения: интеграция, архитектура, обработка ошибок."
        sub_modules:
          - name: "DOCUMENTATION_FIX_PROPOSAL.md"
            description: "Детальный план исправления документации (11 страниц): анализ проблем, 3-фазное решение, метрики успеха."
          - name: "DOCUMENTATION_FIX_SUMMARY.md"
            description: "Краткая сводка предложения по исправлению документации: ключевые исправления, план действий."
          - name: "INTEGRATION_GUIDE.md"
            description: "Руководство по интеграции py_accountant в проекты: setup, примеры, dual-URL. Требует обновления (см. DOCUMENTATION_FIX_PROPOSAL)."
          - name: "ARCHITECTURE_OVERVIEW.md"
            description: "Обзор архитектуры проекта: слои Domain/Application/Infrastructure, диаграммы."
          - name: "ACCOUNTING_CHEATSHEET.md"
            description: "Шпаргалка по бухгалтерским концепциям: дебет/кредит, проводки, балансы."
          - name: "PERFORMANCE.md"
            description: "Документация по производительности: индексы, оптимизации, агрегаты."

  notes:
    - title: "Installed package vs local source"
      description: |
        Note: some integrator projects may have an installed PyPI/Git version of `py-accountant` in their virtualenv which includes a now-deprecated `py_accountant.sdk` module. When running tests in such integrator repositories, the interpreter may import the installed package from `site-packages` instead of the local `py_accountant` source in `src/`. See README for instructions to prefer the local repository (path dependency, uninstall, or PYTHONPATH).

  tests:
    unit_tests:
      - target_component: "AsyncGetAccountBalance"
        test_file: "tests/unit/application/test_async_get_account_balance.py"
        test_functions: ["test_balance_computed_via_ledger_scan", "test_balance_empty_zero"]
        coverage_status: "updated for fast-path"
      - target_component: "AccountAggregates"
        test_file: "tests/unit/infrastructure/test_account_aggregates.py"
        test_functions: [
          "test_repository_upserts_balance",
          "test_repository_upserts_turnover_same_day_multiple_lines",
          "test_repository_concurrent_postings_consistent_balance",
          "test_get_balance_fallback_zero_when_missing",
          "test_get_balance_matches_legacy_scan",
        ]
        coverage_status: "added"
      - target_component: "DomainErrors"
        test_file: "tests/unit/domain/test_errors.py"
        test_functions: ["test_errors_raise_and_inherit"]
        coverage_status: "added"
      - target_component: "QuantizeUtilities"
        test_file: "tests/unit/domain/test_quantize.py"
        test_functions: [
          "test_money_quantize_rounds",
          "test_rate_quantize_rounds",
          "test_no_global_context_mutation",
        ]
        coverage_status: "added"
      - target_component: "CurrencyValueObject"
        test_file: "tests/unit/domain/test_currency_base_rule.py"
        test_functions: ["test_set_base_preserves_other_rates", "test_clear_base", "test_set_base_missing_code_raises"]
        coverage_status: "added"
      - target_component: "AccountValueObject"
        test_file: "tests/unit/domain/test_accounts.py"
        test_functions: ["test_account_full_name_validation", "test_account_parent_id_optional", "test_account_full_name_invalid_raises"]
        coverage_status: "added"
      - target_component: "LedgerBalanceValidation"
        test_file: "tests/unit/domain/test_ledger_balance.py"
        test_functions:
          [
            "test_single_currency_balanced",
            "test_multi_currency_balanced_with_rates",
            "test_unbalanced_detected",
            "test_negative_cases",
            "test_entry_validation",
            "test_non_base_currency_rate_required_and_positive",
            "test_rounding_half_even_comparison",
          ]
        coverage_status: "added"
      - target_component: "RawTradingBalanceAggregation"
        test_file: "tests/unit/domain/test_trading_balance_raw.py"
        test_functions:
          [
            "test_empty_returns_no_lines",
            "test_single_currency_aggregate",
            "test_multi_currency_aggregate_separate_groups",
            "test_rounding_half_even_each_currency",
            "test_preserve_decimal_context",
            "test_reject_non_ledger_entry_input_guard",
          ]
        coverage_status: "added"
      - target_component: "ConvertedTradingBalanceAggregation"
        test_file: "tests/unit/domain/test_trading_balance_converted.py"
        test_functions:
          [
            "test_empty_returns_no_lines_converted",
            "test_single_currency_base_passthrough",
            "test_single_nonbase_with_rate",
            "test_multi_currency_mixed_and_sorting",
            "test_rounding_half_even_in_base",
            "test_missing_rate_raises_for_non_base",
            "test_non_positive_rate_raises",
            "test_unknown_currency_line_raises",
            "test_base_detection_via_get_base_currency",
            "test_preserve_decimal_context_converted",
            "test_input_guard_non_ledger_entry",
          ]
        coverage_status: "added"
      - target_component: "FxAuditTTLService"
        test_file: "tests/unit/domain/test_fx_audit_ttl.py"
        test_functions:
          [
            "test_identify_old_events",
            "test_archival_plan_sizes",
            "test_make_cutoff_normalization_utc",
            "test_validation_errors",
          ]
        coverage_status: "added"
      - target_component: "DocsPresence"
        test_file: "tests/docs/test_docs_sections_present.py"
        test_functions:
          [
            "test_readme_has_sdk_surface_section",
            "test_integration_guide_has_dual_url_and_sdk",
            "test_cheatsheet_exists_and_has_sections",
          ]
        coverage_status: "added"

  edges:
    inter_module_flows:
      - from: "infrastructure"
        to: "application"
        data_type: "Реализации портов (репозитории/UoW)"
        description: "Адаптеры предоставляют реализацию интерфейсов (async only)."
      - from: "application.use_cases_async.ledger"
        to: "infrastructure.persistence.sqlalchemy.repositories_async"
        data_type: "Use case → Repository"
        description: "Постинг транзакций и чтение баланса через репозитории."
      - from: "application.use_cases_async.ledger"
        to: "application.ports"
        data_type: "Use case → Ports"
        description: "Зависит от протоколов AsyncUnitOfWork/Repositories."
      - from: "infrastructure.persistence.sqlalchemy.repositories_async"
        to: "infrastructure.persistence.sqlalchemy.models"
        data_type: "Repository → ORM models"
        description: "Работа с ORM классами, включая агрегаты I31."
      - from: "infrastructure.persistence.sqlalchemy.repositories_async"
        to: "infrastructure.persistence.sqlalchemy.uow"
        data_type: "Repository → UoW"
        description: "Использование AsyncSession в транзакционном scope."
      - from: "tests.integration.ledger"
        to: "application.use_cases_async.ledger"
        data_type: "Integration tests → Use case"
        description: "Проверка сценариев постинга и получения баланса."

  validation_matrix:
    requirement_to_test_map:
      # SDK-specific requirements удалены; остаются только core-требования.
      # ...existing core requirements if any...

  roadmap_updates:
    - id: "ASYNC-03"
      title: "Перевод репозиториев на async API"
      status: "done"
      notes: "repositories_async.py — единственный источник CRUD/TTL для async слоя."
    - id: "ASYNC-04"
      title: "Сохранение синхронного пути для Alembic и вспомогательных сценариев"
      status: "done"
      notes: "alembic/env.py валидирует sync URL, игнорирует DATABASE_URL_ASYNC."
    - id: "ASYNC-05"
      title: "Async Protocols для UoW и репозиториев"
      status: "done"
      notes: "ports.py содержит AsyncUnitOfWork и Async*Repository Protocol; интеграторы реализуют их у себя."
    - id: "ASYNC-06"
      title: "Use cases: переход на async с минимальным шумом"
      status: "done"
      notes: "Добавлены application/use_cases_async/*; sync use cases сохранены для обратной совместимости."
    - id: "I28"
      title: "Deprecate sync repositories"
      status: "done"
      notes: "repositories.py заменён на заглушки; остались только async реализации."
    - id: "I29"
      title: "Удаление legacy sync UоW и репозиториев"
      status: "done"
      notes: "Удалены sync UоW и репозитории; AsyncSqlAlchemyUnitOfWork — единственный UоW в core."
    - id: "CORE-01"
      title: "Переход на core-only интеграцию c installable-пакетом py_accountant"
      status: "done"
      notes: |
        Восстановлен инсталлируемый пакет src/py_accountant с core-only поверхностью (без публичного SDK-слоя).
        Интеграция продолжается через domain/application/ports; внешние проекты импортируют py_accountant.*.
        RPG-граф обновлён: пути узлов указывают на src/py_accountant/...; SDK-узлы и требования удалены или помечены как исторические в документации.
        Интеграторы по-прежнему реализуют свой UnitOfWork и репозитории по контрактам py_accountant.application.ports.
    - id: "DOC-SPRINTS"
      title: "Обновление документации проекта (8 спринтов)"
      status: "completed"
      completion_date: "2025-11-26"
      notes: |
        ✅ ЗАВЕРШЕНО: 8 спринтов по приведению документации к факту после миграции core-only
        - ✅ S1: Аудит и инвентаризация (1 день, 2025-11-25)
        - ✅ S2: Исправление критических несоответствий (1 день, 2025-11-25)
        - ✅ S3: Обновление примеров кода (1 день, 2025-11-25)
        - ✅ S4: Документация API и портов (1 день, 2025-11-25)
        - ✅ S5: Документация окружения (1 день, 2025-11-25)
        - ✅ S6: Автотесты для документации (4 часа, 2025-11-25)
        - ✅ S7: Исправление найденных проблем (1 час, 2025-11-25)
        - ✅ S8: Финальная сверка и индекс (2 часа, 2025-11-25)
        - ✅ DOC-REORG: Реорганизация структуры (1 час, 2025-11-26)
        
        Детали: prompts/sprint_graph.yaml, prompts/sprint_*.md, docs/audit/
        Версия: 1.1.0 (финальная)
        
        Результаты:
        - 18/18 тестов проходят ✅
        - 100% покрытие API (17 use cases, 6 protocols, 14 DTOs)
        - 100% покрытие конфигурации (27 переменных)
        - 3 полнофункциональных примера (FastAPI, CLI, Telegram)
        - Integration time: 30 minutes (8x improvement from 4 hours)
        - docs/ содержит только продуктовую документацию (17 files)
        - docs/audit/ содержит audit материалы (20 files, gitignored)
