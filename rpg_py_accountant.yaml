rpg:
  metadata:
    project_name: "py_accountant"
    description: "Монорепозиторий: домен/приложение/инфраструктура/презентация. Цель — Clean Architecture."
    last_updated: "2025-11-10"
    environments:
      - name: "test"
        description: "Тестовая среда: локальный запуск, in-memory или локальный Postgres, подробные логи."
        env_vars:
          - name: "ENV"
            required: true
            notes: "ENV=test"
          - name: "DATABASE_URL"
            required: true
            notes: "sqlite+pysqlite:///:memory: или локальный Postgres (sync для Alembic)"
          - name: "DATABASE_URL_ASYNC"
            required: false
            notes: "Опционально: async runtime URL (postgresql+asyncpg://..., sqlite+aiosqlite:///:memory:)"
          - name: "LOG_LEVEL"
            required: false
            notes: "DEBUG"
          - name: "JSON_LOGS"
            required: false
            notes: "false"
          - name: "LOG_FILE"
            required: false
            notes: "Путь к файлу логов. Включает файловый хендлер только при JSON_LOGS=true."
          - name: "LOG_ROTATION"
            required: false
            notes: "Ротация: 'time' (по времени, по умолчанию) или 'size' (по размеру)."
          - name: "LOG_MAX_BYTES"
            required: false
            notes: "Максимальный размер файла (для 'size'), по умолчанию 10MiB."
          - name: "LOG_BACKUP_COUNT"
            required: false
            notes: "Число резервных файлов, по умолчанию 7."
          - name: "LOG_ROTATE_WHEN"
            required: false
            notes: "Гранулярность для 'time' (например 'midnight')."
          - name: "LOG_ROTATE_UTC"
            required: false
            notes: "Использовать UTC для тайм-ротации (true по умолчанию)."
          - name: "FX_TTL_MODE"
            required: false
            notes: "none|delete|archive (по умолчанию none)"
          - name: "FX_TTL_RETENTION_DAYS"
            required: false
            notes: "Число дней хранения событий (например 90)"
          - name: "FX_TTL_BATCH_SIZE"
            required: false
            notes: "Размер партии TTL/архива (например 1000)"
          - name: "FX_TTL_DRY_RUN"
            required: false
            notes: "Сухой прогон (true/false)"
      - name: "production"
        description: "Продакшен: Postgres, структурированные JSON-логи, минимальные права."
        env_vars:
          - name: "ENV"
            required: true
            notes: "ENV=production"
          - name: "DATABASE_URL"
            required: true
            notes: "postgresql+psycopg://... (для Alembic миграций)"
          - name: "DATABASE_URL_ASYNC"
            required: true
            notes: "postgresql+asyncpg://... (runtime)"
          - name: "LOG_LEVEL"
            required: true
            notes: "INFO или WARN"
          - name: "JSON_LOGS"
            required: true
            notes: "true"
          - name: "LOG_FILE"
            required: false
            notes: "Рекомендуется указать путь до файла для ротации JSON логов."
          - name: "LOG_ROTATION"
            required: false
            notes: "'time' (по умолчанию, ротация в полночь) или 'size'."
          - name: "LOG_MAX_BYTES"
            required: false
            notes: "Размер для 'size' ротации (например 10485760 для 10MiB)."
          - name: "LOG_BACKUP_COUNT"
            required: false
            notes: "Количество архивов логов (по умолчанию 7)."
          - name: "LOG_ROTATE_WHEN"
            required: false
            notes: "Период ротации при 'time' (по умолчанию midnight)."
          - name: "LOG_ROTATE_UTC"
            required: false
            notes: "Использовать UTC (true) или локальное время."
          - name: "FX_TTL_MODE"
            required: false
            notes: "Режим TTL для exchange_rate_events: none|delete|archive"
          - name: "FX_TTL_RETENTION_DAYS"
            required: false
            notes: "Порог давности в днях (рекомендуемо 90+)"
          - name: "FX_TTL_BATCH_SIZE"
            required: false
            notes: "Размер партии (по умолчанию 1000)"
          - name: "FX_TTL_DRY_RUN"
            required: false
            notes: "Сухой прогон, не изменяет БД"

  nodes:
    modules:
      - name: "application"
        path: "src/application"
        description: "Сценарии (use cases), DTO и интерфейсы портов (репозитории, UoW, Clock)."
      - name: "use_cases_async"
        path: "src/application/use_cases_async"
        description: "Async use cases: currencies/accounts/ledger/trading/fx audit (параллельно sync)."
      - name: "domain"
        path: "src/domain"
        description: "Чистый домен: value-объекты, агрегаты, сервисы (баланс, курсы)."
      - name: "infrastructure"
        path: "src/infrastructure"
        description: "Адаптеры: SQLAlchemy, миграции Alembic, внешние сервисы, реализация портов."
      - name: "presentation"
        path: "src/presentation"
        description: "API/CLI: контроллеры, валидация, презентеры."
      - name: "config"
        path: "src/infrastructure/config"
        description: "Конфигурация приложения на pydantic-settings; выбор профиля окружения."
      - name: "logging"
        path: "src/infrastructure/logging"
        description: "Структурированное логирование на structlog; единая инициалиация логгера."
      - name: "py_accountant"
        path: "src/py_accountant"
        description: "Публичный пакет-оболочка корневого проекта (версия, утилиты)."
      - name: "async_engine"
        path: "src/infrastructure/persistence/sqlalchemy/async_engine.py"
        description: "Async фабрики: normalize_async_url, get_async_engine, get_async_session_factory"
      - name: "repositories_async"
        path: "src/infrastructure/persistence/sqlalchemy/repositories_async.py"
        description: "Async репозитории: Currency, Account, Transaction, Balance, ExchangeRateEvents (эквивалентная семантика sync)."
      - name: "asyncio_utils"
        path: "src/infrastructure/utils/asyncio_utils.py"
        description: "Helper run_sync(coro): безопасный запуск корутин из sync-контекста (guard на running loop, PEP695 generic)."
      - name: "async_bridge"
        path: "src/presentation/async_bridge.py"
        description: "Синхронные фасады над async use cases для CLI (currency/account/tx/ledger/balance/trading/FX)."

    files:
      - name: "__init__.py"
        parent_module: "py_accountant"
        description: "Публичный API версии пакета."
      - name: "alembic.ini"
        parent_module: "infrastructure"
        description: "Конфигурация Alembic."
      - name: "alembic/env.py"
        parent_module: "infrastructure"
        description: "Скрипт миграций Alembic: читает sync URL (DATABASE_URL или sqlalchemy.url), игнорирует DATABASE_URL_ASYNC, явно отклоняет async драйверы (asyncpg/aiosqlite)."
      - name: "docker-compose.yml"
        parent_module: "infrastructure"
        description: "Поднимает Postgres и pgAdmin, доступные снаружи."
      - name: ".env.example"
        parent_module: "infrastructure"
        description: "Пример переменных окружения (DATABASE_URL, DATABASE_URL_ASYNC, LOG_LEVEL, JSON_LOGS, ENV)."
      - name: ".env"
        parent_module: "infrastructure"
        description: "Локальные переменные окружения (dev)."
      - name: "src/application/dto/models.py"
        parent_module: "application"
        description: "DTO: CurrencyDTO, AccountDTO, EntryLineDTO, TransactionDTO, TradingBalanceLineDTO, TradingBalanceDTO, RichTransactionDTO, ExchangeRateEventDTO"
      - name: "src/application/interfaces/ports.py"
        parent_module: "application"
        description: "Порты: Clock, UnitOfWork, CurrencyRepository, AccountRepository, TransactionRepository, BalanceRepository, ExchangeRateEventsRepository."
      - name: "src/application/use_cases_async/__init__.py"
        parent_module: "use_cases_async"
        description: "Пакет экспорта Async* use cases (currencies/accounts/ledger/trading/fx_audit)."
      - name: "src/application/use_cases_async/currencies.py"
        parent_module: "use_cases_async"
        description: "Async валютные кейсы: AsyncCreateCurrency, AsyncSetBaseCurrency, AsyncListCurrencies."
      - name: "src/application/use_cases_async/accounts.py"
        parent_module: "use_cases_async"
        description: "Async аккаунты: AsyncCreateAccount, AsyncGetAccount, AsyncListAccounts."
      - name: "src/application/use_cases_async/ledger.py"
        parent_module: "use_cases_async"
        description: "Async леджер и баланс: AsyncPostTransaction, AsyncListTransactionsBetween, AsyncGetLedger, AsyncGetAccountBalance, AsyncGetTradingBalance."
      - name: "src/application/use_cases_async/fx_audit.py"
        parent_module: "use_cases_async"
        description: "Async FX audit: AsyncAddExchangeRateEvent, AsyncListExchangeRateEvents."
      - name: "src/infrastructure/persistence/sqlalchemy/models.py"
        parent_module: "infrastructure"
        description: "ORM модели: CurrencyORM, AccountORM, JournalORM, TransactionLineORM, BalanceORM, ExchangeRateEventORM, ExchangeRateEventArchiveORM"
      - name: "src/infrastructure/persistence/sqlalchemy/repositories.py"
        parent_module: "infrastructure"
        description: "Sync реализации портов репозиториев на SQLAlchemy (legacy путь)."
      - name: "src/infrastructure/persistence/sqlalchemy/repositories_async.py"
        parent_module: "infrastructure"
        description: "Async реализации портов репозиториев на SQLAlchemy."
      - name: "src/infrastructure/persistence/sqlalchemy/uow.py"
        parent_module: "infrastructure"
        description: "UoW: legacy sync + AsyncSqlAlchemyUnitOfWork (async контекстный менеджер, ленивые async репозитории)."
      - name: "docs/RUNNING_MIGRATIONS.md"
        parent_module: "infrastructure"
        description: "Helper для CI: запуск Alembic миграций, примеры GitHub Actions/GitLab, checklist."
      - name: "src/infrastructure/utils/asyncio_utils.py"
        parent_module: "infrastructure"
        description: "run_sync(coro): запрет nested loop, корректное закрытие корутины при ошибке."
      - name: "src/presentation/async_bridge.py"
        parent_module: "presentation"
        description: "Слой фасадов для CLI, ensure_schema(), маппинг параметров 1-в-1 с командами."

    components:
      - name: "SqlAlchemyUnitOfWork"
        parent_file: "src/infrastructure/persistence/sqlalchemy/uow.py"
        type: "class"
        description: "Legacy sync UoW на SQLAlchemy; sessionmaker, транзакции (обратная совместимость)."
        testable: true
        test_priority: "medium"

      - name: "AsyncSqlAlchemyUnitOfWork"
        parent_file: "src/infrastructure/persistence/sqlalchemy/uow.py"
        type: "class"
        description: "Асинхронный UoW: async context manager (__aenter__/__aexit__), commit/rollback/close на AsyncSession, lazy async repositories."
        testable: true
        test_priority: "high"

      - name: "SyncUnitOfWorkWrapper"
        parent_file: "src/infrastructure/persistence/sqlalchemy/uow.py"
        type: "class"
        description: "Синхронная обёртка поверх async UoW: использует asyncio.run, запрещена внутри активного event loop."
        testable: true
        test_priority: "medium"

      - name: "SqlAlchemy*Repository (sync)"
        parent_file: "src/infrastructure/persistence/sqlalchemy/repositories.py"
        type: "class"
        description: "Реализации портов репозиториев на SQLAlchemy (синхронные)."
        testable: true
        test_priority: "medium"

      - name: "AsyncSqlAlchemy*Repository"
        parent_file: "src/infrastructure/persistence/sqlalchemy/repositories_async.py"
        type: "class"
        description: "Async реализации репозиториев: Currency/Account/Transaction/Balance/ExchangeRateEvents (эквивалентная семантика sync)."
        testable: true
        test_priority: "high"

      - name: "AsyncUseCases"
        parent_file: "src/application/use_cases_async/*"
        type: "module"
        description: "Async аналоги основных use cases; тонкая оркестрация поверх AsyncUnitOfWork."
        testable: true
        test_priority: "medium"

      - name: "run_sync"
        parent_file: "src/infrastructure/utils/asyncio_utils.py"
        type: "function"
        description: "Generic PEP695 синхронный запуск корутин; проверка активного event loop, close() + RuntimeError."
        testable: true
        test_priority: "high"

      - name: "AsyncBridgeFacades"
        parent_file: "src/presentation/async_bridge.py"
        type: "module"
        description: "Фасады: create_currency_sync, set_base_currency_sync, list_currencies_sync, create_account_sync, post_transaction_sync, list_transactions_between_sync, get_ledger_sync, get_account_balance_sync, get_trading_balance_sync, get_trading_balance_detailed_sync, add/list FX событий, set/bulk rates."
        testable: true
        test_priority: "high"

  tests:
    unit_tests:
      - target_component: "Async repositories"
        test_file: "tests/unit/application/test_async_repositories.py"
        test_functions:
          [
            "test_currency_upsert_and_base",
            "test_currency_set_base_missing_raises",
            "test_account_create_and_unique",
            "test_transactions_add_and_list_between_with_meta",
            "test_aggregate_trading_balance",
            "test_ledger_pagination_order_and_edges",
            "test_balances_cache_upsert_get_clear",
            "test_fx_events_list_filters_and_limits",
          ]
        coverage_status: "added"
      - target_component: "Async use cases smoke"
        test_file: "tests/unit/application/test_async_use_cases_smoke.py"
        test_functions:
          [
            "test_async_use_cases_smoke",
            "test_async_set_base_missing_currency_raises",
            "test_async_create_account_missing_currency",
            "test_async_post_transaction_missing_account",
          ]
        coverage_status: "added"
      - target_component: "FX Audit repository (sync)"
        test_file: "tests/unit/test_fx_audit.py"
        test_functions: ["test_fx_audit_events_basic", "test_fx_audit_limit"]
        coverage_status: "exists"
      - target_component: "Docs sections presence"
        test_file: "tests/docs/test_docs_sections_present.py"
        test_functions: ["test_required_doc_sections_present"]
        coverage_status: "added"
    integration_tests:
      - integration_point: "FX TTL async repository"
        test_description: "Удаление и архивирование событий по порогу давности (async repos)"
        test_file: "tests/integration/test_async_fx_ttl.py"
        coverage_status: "added"
      - integration_point: "Alembic sync migrations"
        test_description: "Upgrade head и downgrade base на синхронном URL; отказ на async URL"
        test_file: "tests/integration/alembic/test_sync_migrations_still_work.py"
        coverage_status: "added"
      - integration_point: "Config dual URLs"
        test_description: "Проверка различий драйверов runtime async и migrations sync"
        test_file: "tests/integration/config/test_dual_url_consistency.py"
        coverage_status: "added"
    fixtures:
      - name: "async_uow"
        file: "tests/conftest.py"
        description: "pytest-asyncio фикстура: создаёт файл-базу SQLite, поднимает схему, открывает Async UoW и закрывает по окончании теста."

  edges:
    inter_module_flows:
      - from: "infrastructure"
        to: "application"
        data_type: "Реализации портов (репозитории/UoW)"
        description: "Адаптеры предоставляют реализацию интерфейсов (sync и async)."

  roadmap_updates:
    - id: "ASYNC-03"
      title: "Перевод репозиториев на async API"
      status: "done"
    - id: "ASYNC-04"
      title: "Сохранение синхронного пути для Alembic и вспомогательных сценариев"
      status: "done"
      notes: "alembic/env.py валидирует sync URL, игнорирует DATABASE_URL_ASYNC, тесты alembic/config/docs добавлены; документация обновлена (INTEGRATION_GUIDE, MIGRATION_HISTORY, README)."
    - id: "ASYNC-05"
      title: "Async Protocols для UoW и репозиториев"
      status: "done"
      notes: "ports.py дополнен AsyncUnitOfWork и Async*Repository Protocol; sync контракты сохранены; добавлен структурный тест test_async_ports_protocols.py."
    - id: "ASYNC-06"
      title: "Use cases: переход на async с минимальным шумом"
      status: "done"
      notes: |
        Добавлен пакет application/use_cases_async с async вариантами ключевых сценариев:
        - Валюты: AsyncCreateCurrency, AsyncSetBaseCurrency, AsyncListCurrencies
        - Счета: AsyncCreateAccount, AsyncGetAccount, AsyncListAccounts
        - Транзакции/Леджер: AsyncPostTransaction, AsyncListTransactionsBetween, AsyncGetLedger, AsyncGetAccountBalance, AsyncGetTradingBalance
        - FX audit: AsyncAddExchangeRateEvent, AsyncListExchangeRateEvents
        Добавлен unit smoke тест tests/unit/application/test_async_use_cases_smoke.py (создание валют/счёта/транзакции, леджер, балансы, edge: limit=0/offset<0, ошибки). Существующие sync use cases не изменялись. Все новые функции имеют докстроки.
    - id: "ASYNC-07"
      title: "CLI/Presentation: синхронные обёртки поверх async use cases"
      status: "done"
      notes: |
        CLI теперь использует async use cases через синхронные фасады (presentation/async_bridge.py) и общий helper run_sync.
        Публичное поведение CLI (формат вывода, тексты ошибок) не изменилось; perf/e2e тесты зелёные.
        Добавлена защита от вложенного event loop, исправлены замечания линтера (UP047, SIM105, import shadowing).
