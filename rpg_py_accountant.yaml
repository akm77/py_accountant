rpg:
  metadata:
    project_name: "py_accountant"
    description: "Монорепозиторий: домен/приложение/инфраструктура/презентация. Цель — Clean Architecture."
    last_updated: "2025-11-11"
    environments:
      - name: "test"
        description: "Тестовая среда: локальный запуск, in-memory или локальный Postgres, подробные логи."
        env_vars:
          - name: "ENV"
            required: true
            notes: "ENV=test"
          - name: "DATABASE_URL"
            required: true
            notes: "sqlite+pysqlite:///:memory: или локальный Postgres (sync для Alembic)"
          - name: "DATABASE_URL_ASYNC"
            required: false
            notes: "Опционально: async runtime URL (postgresql+asyncpg://..., sqlite+aiosqlite:///:memory:)"
          - name: "LOG_LEVEL"
            required: false
            notes: "DEBUG"
          - name: "JSON_LOGS"
            required: false
            notes: "false"
          - name: "LOG_FILE"
            required: false
            notes: "Путь к файлу логов. Включает файловый хендлер только при JSON_LOGS=true."
          - name: "LOG_ROTATION"
            required: false
            notes: "Ротация: 'time' (по времени, по умолчанию) или 'size' (по размеру)."
          - name: "LOG_MAX_BYTES"
            required: false
            notes: "Максимальный размер файла (для 'size'), по умолчанию 10MiB."
          - name: "LOG_BACKUP_COUNT"
            required: false
            notes: "Число резервных файлов, по умолчанию 7."
          - name: "LOG_ROTATE_WHEN"
            required: false
            notes: "Гранулярность для 'time' (например 'midnight')."
          - name: "LOG_ROTATE_UTC"
            required: false
            notes: "Использовать UTC для тайм-ротации (true по умолчанию)."
          - name: "FX_TTL_MODE"
            required: false
            notes: "none|delete|archive (по умолчанию none)"
          - name: "FX_TTL_RETENTION_DAYS"
            required: false
            notes: "Число дней хранения событий (например 90)"
          - name: "FX_TTL_BATCH_SIZE"
            required: false
            notes: "Размер партии TTL/архива (например 1000)"
          - name: "FX_TTL_DRY_RUN"
            required: false
            notes: "Сухой прогон, не изменяет БД"
      - name: "production"
        description: "Продакшен: Postgres, структурированные JSON-логи, минимальные права."
        env_vars:
          - name: "ENV"
            required: true
            notes: "ENV=production"
          - name: "DATABASE_URL"
            required: true
            notes: "postgresql+psycopg://... (для Alembic миграций)"
          - name: "DATABASE_URL_ASYNC"
            required: true
            notes: "postgresql+asyncpg://... (runtime)"
          - name: "LOG_LEVEL"
            required: true
            notes: "INFO или WARN"
          - name: "JSON_LOGS"
            required: true
            notes: "true"
          - name: "LOG_FILE"
            required: false
            notes: "Рекомен��уется указать путь до файла для ротации JSON логов."
          - name: "LOG_ROTATION"
            required: false
            notes: "'time' (по умолчанию, ротация в полночь) или 'size'."
          - name: "LOG_MAX_BYTES"
            required: false
            notes: "Размер для 'size' ротации (например 10485760 для 10MiB)."
          - name: "LOG_BACKUP_COUNT"
            required: false
            notes: "Количество архивов логов (по умолчанию 7)."
          - name: "LOG_ROTATE_WHEN"
            required: false
            notes: "Период ротации при 'time' (по умолчанию midnight)."
          - name: "LOG_ROTATE_UTC"
            required: false
            notes: "Использовать UTC (true) или локальное время."
          - name: "FX_TTL_MODE"
            required: false
            notes: "Режим TTL для exchange_rate_events: none|delete|archive"
          - name: "FX_TTL_RETENTION_DAYS"
            required: false
            notes: "Порог давности в днях (рекомендуемо 90+)"
          - name: "FX_TTL_BATCH_SIZE"
            required: false
            notes: "Размер партии (по умолчанию 1000)"
          - name: "FX_TTL_DRY_RUN"
            required: false
            notes: "Сухой прогон, не изменяет БД"

  nodes:
    modules:
      - name: "application"
        path: "src/application"
        description: "Сценарии (use cases), DTO и интерфейсы портов (репозитории, UoW, Clock)."
      - name: "use_cases_async"
        path: "src/application/use_cases_async"
        description: "Async use cases: currencies/accounts/ledger/trading/fx audit (параллельно sync)."
      - name: "domain"
        path: "src/domain"
        description: "Чистый домен: value-объекты, агрегаты, сервисы (баланс, курсы)."
      - name: "domain.errors"
        path: "src/domain/errors.py"
        description: "Минимальный модуль исключений домена: DomainError, ValidationError (без зависимостей)."
      - name: "domain.quantize"
        path: "src/domain/quantize.py"
        description: "Утилиты квантования: money_quantize, rate_quantize (ROUND_HALF_EVEN, локальный контекст, без изменения глобального Decimal)."
      - name: "domain.currencies"
        path: "src/domain/currencies.py"
        description: "Value object Currency и сервис BaseCurrencyRule: единственная базовая валюта, нормализация курсов через rate_quantize, без пересчёта остальных."
      - name: "domain.accounts"
        path: "src/domain/accounts.py"
        description: "Value object Account: валидация full_name (иерархия через ':'), derive name/parent_path, нормализация currency_code (upper, 3..10), parent_id опционален."
      - name: "domain.ledger"
        path: "src/domain/ledger.py"
        description: "Валидатор баланса LedgerValidator: мультивалютная сверка в базовой валюте (money_quantize), без инфраструктурных зависимостей."
      - name: "domain.trading_balance"
        path: "src/domain/trading_balance.py"
        description: "RawAggregator: агрегация дебет/кредит по валюте без конверсии, квантование итогов (2dp HALF_EVEN), возврат списка RawBalanceLine (отсортирован по currency_code). ConvertedAggregator: агрегация по валюте с конвертацией в базовую валюту по rate_to_base; DTO ConvertedBalanceLine включает base_currency_code, used_rate (6 знаков), debit/credit/net и debit_base/credit_base/net_base; сортировка по currency_code."
      - name: "domain.fx_audit"
        path: "src/domain/fx_audit.py"
        description: "FX Audit TTL domain service: FxAuditTTLService with make_cutoff/identify_old/batch_plan; dataclasses ExchangeRateEventRef, TTLConfig, Batch; ArchivalMode enum; чистая логика без I/O."
      - name: "infrastructure"
        path: "src/infrastructure"
        description: "Адаптеры: SQLAlchemy, миграции Alembic, внешние сервисы, реализация портов."
      - name: "presentation"
        path: "src/presentation"
        description: "API/CLI: контроллеры, валидация, презентеры."
      - name: "config"
        path: "src/infrastructure/config"
        description: "Конфигурация приложения на pydantic-settings; выбор профиля окружения."
      - name: "logging"
        path: "src/infrastructure/logging"
        description: "Структурированное логирование на structlog; единая инициалиация логгера."
      - name: "py_accountant"
        path: "src/py_accountant"
        description: "Публичный пакет-оболочка корневого проекта (версия, утилиты)."
      - name: "async_engine"
        path: "src/infrastructure/persistence/sqlalchemy/async_engine.py"
        description: "Async фабрики: normalize_async_url, get_async_engine, get_async_session_factory"
      - name: "repositories_async"
        path: "src/infrastructure/persistence/sqlalchemy/repositories_async.py"
        description: "Async репозитории (CRUD only; no aggregations). Валюты/аккаунты/журналы/FX audit; баланс‑кэш — DEPRECATED (только CRUD)."
      - name: "asyncio_utils"
        path: "src/infrastructure/utils/asyncio_utils.py"
        description: "Helper run_sync(coro): безопасный запуск корутин из sync-контекста (guard на running loop, PEP695 generic)."
      - name: "async_bridge"
        path: "src/presentation/async_bridge.py"
        description: "Синхронные фасады над async use cases для CLI (currency/account/tx/ledger/balance/trading/FX)."

    files:
      - name: "__init__.py"
        parent_module: "py_accountant"
        description: "Публичный API версии пакета."
      - name: "alembic.ini"
        parent_module: "infrastructure"
        description: "Конфигурация Alembic."
      - name: "alembic/env.py"
        parent_module: "infrastructure"
        description: "Скрипт миграций Alembic: читает sync URL (DATABASE_URL или sqlalchemy.url), игнорирует DATABASE_URL_ASYNC, явно отклоняет async драйверы (asyncpg/aiosqlite)."
      - name: "docker-compose.yml"
        parent_module: "infrastructure"
        description: "Поднимает Postgres и pgAdmin, доступные снаружи."
      - name: ".env.example"
        parent_module: "infrastructure"
        description: "Пример переменных окружения (DATABASE_URL, DATABASE_URL_ASYNC, LOG_LEVEL, JSON_LOGS, ENV)."
      - name: ".env"
        parent_module: "infrastructure"
        description: "Локальные переменные окружения (dev)."
      - name: "src/domain/errors.py"
        parent_module: "domain.errors"
        description: "Определяет DomainError и ValidationError; публичный контракт домена."
      - name: "src/domain/quantize.py"
        parent_module: "domain.quantize"
        description: "Функции для безопасного квантования денег (2 знака) и курсов (6 знаков) с ROUND_HALF_EVEN без изменения глобального Decimal контекста."
      - name: "src/domain/currencies.py"
        parent_module: "domain.currencies"
        description: "Класс Currency (code/is_base/rate_to_base) и сервис BaseCurrencyRule; helper get_base_currency."
      - name: "src/domain/accounts.py"
        parent_module: "domain.accounts"
        description: "Класс Account: валидация имени, derive name/parent_path, нормализация currency_code."
      - name: "src/domain/ledger.py"
        parent_module: "domain.ledger"
        description: "EntrySide, LedgerEntry, LedgerValidator.validate — проверка баланса в базовой валюте; конверсия небазовых сумм через amount * rate_to_base, сравнение после money_quantize."
      - name: "src/domain/trading_balance.py"
        parent_module: "domain.trading_balance"
        description: "RawAggregator.aggregate: группировка LedgerEntry по currency_code, накопление debit/credit, квантование итогов и вычисление net; возврат list[RawBalanceLine] сортированного по коду. ConvertedAggregator.aggregate: группировка + конвертация в базовую валюту, валидация наличия положительного rate_to_base, определение базы по base_code или get_base_currency, возврат list[ConvertedBalanceLine] с полями used_rate/debit_base/credit_base/net_base."
      - name: "src/domain/fx_audit.py"
        parent_module: "domain.fx_audit"
        description: "Доменные вычисления TTL: UTC cutoff, фильтрация старых событий (stable), построение batch-плана; без зависимостей от БД/репозиториев."
      - name: "src/application/dto/models.py"
        parent_module: "application"
        description: "DTO: CurrencyDTO, AccountDTO, EntryLineDTO, TransactionDTO, TradingBalanceLineDTO (DEPRECATED alias/compat), TradingBalanceDTO, RichTransactionDTO, ExchangeRateEventDTO; I09: добавлены TradingBalanceLineSimple и TradingBalanceLineDetailed (frozen, slots)."
      - name: "src/application/interfaces/ports.py"
        parent_module: "application"
        description: "DEPRECATED proxy: re-exports async ports from application.ports (I11)."
      - name: "src/application/ports.py"
        parent_module: "application"
        description: "Unified async Protocols: Clock, AsyncUnitOfWork, Async*Repository, SupportsCommitRollback."
      - name: "src/application/use_cases_async/__init__.py"
        parent_module: "use_cases_async"
        description: "Пакет экспорта Async* use cases (currencies/accounts/ledger/trading/fx_audit)."
      - name: "src/application/use_cases_async/currencies.py"
        parent_module: "use_cases_async"
        description: "DEPRECATED entry; use the module node below"
      - name: "use_cases_async"
        path: "src/application/use_cases_async"
        description: "Async use cases: currencies/accounts/ledger/trading/fx audit (параллельно sync)."
      - name: "src/application/use_cases_async/currencies.py (use cases)"
        parent_module: "use_cases_async"
        description: "use_cases_async/currencies: используют доменные сервисы для валидации и выбора базы; репозитории — только CRUD."
      - name: "src/application/use_cases_async/accounts.py"
        parent_module: "use_cases_async"
        description: "Async аккаунты: AsyncCreateAccount использует domain.Account для валидации и нормализации full_name/currency_code; проверяет существование валюты и уникальность full_name; репозитории — только CRUD. AsyncGetAccount/AsyncListAccounts — passthrough."
      - name: "src/application/use_cases_async/ledger.py"
        parent_module: "use_cases_async"
        description: "Async леджер и баланс: AsyncPostTransaction (доменная проверка баланса через LedgerValidator перед записью), AsyncListTransactionsBetween, AsyncGetLedger, AsyncGetAccountBalance, AsyncGetTradingBalance. Ошибки: ValidationError (формат/валидация), DomainError (несбалансированность), ValueError (отсутствующие ресурсы)."
      - name: "src/application/use_cases_async/fx_audit.py"
        parent_module: "use_cases_async"
        description: "Async FX audit: AsyncAddExchangeRateEvent, AsyncListExchangeRateEvents."
      - name: "src/infrastructure/persistence/sqlalchemy/models.py"
        parent_module: "infrastructure"
        description: "ORM schema only: CurrencyORM, AccountORM, JournalORM, TransactionLineORM, BalanceORM (DEPRECATED balance cache), ExchangeRateEventORM, ExchangeRateEventArchiveORM. No helpers or business logic (I12)."
      - name: "src/infrastructure/persistence/sqlalchemy/repositories.py"
        parent_module: "infrastructure"
        description: "Sync реализации портов репозиториев на SQLAlchemy (legacy путь)."
      - name: "src/infrastructure/persistence/sqlalchemy/repositories_async.py"
        parent_module: "infrastructure"
        description: "Async реализации портов репозиториев на SQLAlchemy."
      - name: "src/infrastructure/persistence/sqlalchemy/uow.py"
        parent_module: "infrastructure"
        description: "UoW: legacy sync + AsyncSqlAlchemyUnitOfWork (упрощённый: без retry/backoff/statement_timeout; ответственность за повторные попытки вынесена наружу; ленивые async репозитории)."
      - name: "docs/RUNNING_MIGRATIONS.md"
        parent_module: "infrastructure"
        description: "Helper для CI: запуск Alembic миграций, примеры GitHub Actions/GitLab, checklist."
      - name: "src/infrastructure/utils/asyncio_utils.py"
        parent_module: "infrastructure"
        description: "run_sync(coro): запрет nested loop, корректное закрытие корутины при ошибке."
      - name: "src/presentation/async_bridge.py"
        parent_module: "presentation"
        description: "Слой фасадов для CLI, ensure_schema(), маппинг параметров 1-в-1 с командами."
      - name: "tests/unit/domain/test_errors.py"
        parent_module: "domain.errors"
        description: "Тест проверяет иерархию DomainError/ValidationError и текст сообщений."
      - name: "tests/unit/domain/test_quantize.py"
        parent_module: "domain.quantize"
        description: "Тесты для функций квантования денег и курсов: money_quantize, rate_quantize."
      - name: "tests/unit/domain/test_currency_base_rule.py"
        parent_module: "domain.currencies"
        description: "Тесты правила единственной базовой валюты: смена базы без изменения курсов и очистка базы."
      - name: "tests/unit/domain/test_accounts.py"
        parent_module: "domain.accounts"
        description: "Тесты Account: валидация full_name, derive name/parent_path, опциональный parent_id."
      - name: "tests/unit/domain/test_ledger_balance.py"
        parent_module: "domain.ledger"
        description: "Тесты валидатора баланса: одно- и мультивалютные кейсы, несбалансированность, негативные сценарии, проверка контекста Decimal и округле��ия."
      - name: "tests/unit/domain/test_trading_balance_raw.py"
        parent_module: "domain.trading_balance"
        description: "Тесты RawAggregator: пустой вход, одиночная валюта, мульти-валюта, округление HALF_EVEN, неизменность Decimal контекста, защита от неверного типа."
      - name: "tests/unit/domain/test_trading_balance_converted.py"
        parent_module: "domain.trading_balance"
        description: "Тесты ConvertedAggregator/ConvertedBalanceLine: пустой вход, passthrough базовой валюты, небаза с курсом, смешанные валюты и сортировка, HALF_EVEN в базе, отсутствие/неположительный курс — ValidationError, неизвестная валюта — ValidationError, определение базы через get_base_currency, сохранение Decimal контекста, guard на не-LedgerEntry."
      - name: "tests/unit/domain/test_fx_audit_ttl.py"
        parent_module: "domain.fx_audit"
        description: "Юнит‑тесты TTL: identify_old (naive/aware/strictly older), batch_plan (offset/limit покрытие), make_cutoff нормализация UTC, валидации аргументов."
      - name: "tests/report/test_inventory.md"
        parent_module: "py_accountant"
        description: "Снимок инвентаризации тестов (I08A): категории и план миграции тестов (KEEP-ASIS/ADAPT-SHALLOW/REWRITE-DOMAIN/UPGRADE-CLI/DROP-TRIVIAL/OBSOLETE/PERF-OPTIONAL/SPLIT/MOVE)."

    components:
      - name: "DomainErrors"
        parent_file: "src/domain/errors.py"
        type: "module"
        description: "Исключения домена: базовый класс DomainError и ValidationError для валидации."
        testable: true
        test_priority: "high"
      - name: "QuantizeUtilities"
        parent_file: "src/domain/quantize.py"
        type: "module"
        description: "Функции money_quantize и rate_quantize: банковское округление (2 и 6 знаков) с ROUND_HALF_EVEN, без изменения глобального Decimal контекста."
        testable: true
        test_priority: "high"
      - name: "CurrencyValueObject"
        parent_file: "src/domain/currencies.py"
        type: "module"
        description: "Currency, BaseCurrencyRule, get_base_currency: единая базовая валюта, нормализация курсов, без пересчёта остальных."
        testable: true
        test_priority: "high"
      - name: "AccountValueObject"
        parent_file: "src/domain/accounts.py"
        type: "module"
        description: "Account: валидация full_name, derive name/parent_path, нормализация currency_code, parent_id опционален."
        testable: true
        test_priority: "high"
      - name: "LedgerBalanceValidation"
        parent_file: "src/domain/ledger.py"
        type: "module"
        description: "EntrySide, LedgerEntry, LedgerValidator.validate: мультивалютная проверка баланса в базовой валюте; конверсия по rate_to_base (>0), сравнение после money_quantize; ошибки ValidationError/DomainError; без инфраструктурных зависимостей."
        testable: true
        test_priority: "high"
      - name: "RawTradingBalanceAggregation"
        parent_file: "src/domain/trading_balance.py"
        type: "module"
        description: "RawAggregator.aggregate: группировка LedgerEntry по currency_code, накопление debit/credit, квантование (2dp HALF_EVEN), вычисление net, сортировка по коду."
        testable: true
        test_priority: "high"
      - name: "ConvertedTradingBalanceAggregation"
        parent_file: "src/domain/trading_balance.py"
        type: "module"
        description: "ConvertedAggregator.aggregate: группировка LedgerEntry по currency_code, определение базовой валюты по base_code или get_base_currency, проверка наличия положительного rate_to_base для небазовых валют, умножение необрезанных итогов на курс, округление на выходе (money_quantize), возврат DTO ConvertedBalanceLine с used_rate (rate_quantize)."
        testable: true
        test_priority: "high"
      - name: "FxAuditTTLService"
        parent_file: "src/domain/fx_audit.py"
        type: "class"
        description: "Сервис домена: make_cutoff(now, retention_days) -> UTC datetime; identify_old(events, cutoff) -> list[ExchangeRateEventRef] (stable order); batch_plan(total, batch_size) -> list[Batch]. Валидация аргументов через ValidationError."
        testable: true
        test_priority: "high"
      - name: "SqlAlchemyUnitOfWork"
        parent_file: "src/infrastructure/persistence/sqlalchemy/uow.py"
        type: "class"
        description: "Legacy sync UoW на SQLAlchemy; sessionmaker, транзакции (обратная совместимость)."
        testable: true
        test_priority: "medium"

      - name: "AsyncSqlAlchemyUnitOfWork"
        parent_file: "src/infrastructure/persistence/sqlalchemy/uow.py"
        type: "class"
        description: "Асинхронный UoW (упрощённый): async context manager (__aenter__/__aexit__), один AsyncSession, явный commit()/rollback(); при отсутствии явного commit — автокоммит на выход, без retry/backoff/statement_timeout."
        testable: true
        test_priority: "high"

      - name: "SyncUnitOfWorkWrapper"
        parent_file: "src/infrastructure/persistence/sqlalchemy/uow.py"
        type: "class"
        description: "Синхронная обёртка поверх async UoW: использует asyncio.run, запрещена внутри активного event loop."
        testable: true
        test_priority: "medium"

      - name: "SqlAlchemy*Repository (sync)"
        parent_file: "src/infrastructure/persistence/sqlalchemy/repositories.py"
        type: "class"
        description: "Реализации портов репозиториев на SQLAlchemy (синхронные)."
        testable: true
        test_priority: "medium"

      - name: "AsyncSqlAlchemy*Repository"
        parent_file: "src/infrastructure/persistence/sqlalchemy/repositories_async.py"
        type: "class"
        description: "Async реализации репозиториев: Currency/Account/Transaction/Balance/ExchangeRateEvents — CRUD-only; без агрегаций/конверсии. Balance cache помечен DEPRECATED."
        testable: true
        test_priority: "high"

      - name: "AsyncUseCases"
        parent_file: "src/application/use_cases_async/*"
        type: "module"
        description: "Async аналоги основных use cases; тонкая оркестрация поверх AsyncUnitOfWork."
        testable: true
        test_priority: "medium"

      - name: "run_sync"
        parent_file: "src/infrastructure/utils/asyncio_utils.py"
        type: "function"
        description: "Generic PEP695 синхронный запуск корутин; проверка активного event loop, close() + RuntimeError."
        testable: true
        test_priority: "high"

      - name: "AsyncBridgeFacades"
        parent_file: "src/presentation/async_bridge.py"
        type: "module"
        description: "Фасады: create_currency_sync, set_base_currency_sync, list_currencies_sync, create_account_sync, post_transaction_sync, list_transactions_between_sync, get_ledger_sync, get_account_balance_sync, get_trading_balance_sync, get_trading_balance_detailed_sync, add/list FX событий, set/bulk rates."
        testable: true
        test_priority: "high"

  tests:
    unit_tests:
      - target_component: "DomainErrors"
        test_file: "tests/unit/domain/test_errors.py"
        test_functions: ["test_errors_raise_and_inherit"]
        coverage_status: "added"
      - target_component: "QuantizeUtilities"
        test_file: "tests/unit/domain/test_quantize.py"
        test_functions: ["test_money_quantize_rounds", "test_rate_quantize_rounds", "test_no_global_context_mutation"]
        coverage_status: "added"
      - target_component: "CurrencyValueObject"
        test_file: "tests/unit/domain/test_currency_base_rule.py"
        test_functions: ["test_set_base_preserves_other_rates", "test_clear_base", "test_set_base_missing_code_raises"]
        coverage_status: "added"
      - target_component: "AccountValueObject"
        test_file: "tests/unit/domain/test_accounts.py"
        test_functions: ["test_account_full_name_validation", "test_account_parent_id_optional", "test_account_full_name_invalid_raises"]
        coverage_status: "added"
      - target_component: "LedgerBalanceValidation"
        test_file: "tests/unit/domain/test_ledger_balance.py"
        test_functions:
          [
            "test_single_currency_balanced",
            "test_multi_currency_balanced_with_rates",
            "test_unbalanced_detected",
            "test_negative_cases",
            "test_entry_validation",
            "test_non_base_currency_rate_required_and_positive",
            "test_rounding_half_even_comparison",
          ]
        coverage_status: "added"
      - target_component: "RawTradingBalanceAggregation"
        test_file: "tests/unit/domain/test_trading_balance_raw.py"
        test_functions:
          [
            "test_empty_returns_no_lines",
            "test_single_currency_aggregate",
            "test_multi_currency_aggregate_separate_groups",
            "test_rounding_half_even_each_currency",
            "test_preserve_decimal_context",
            "test_reject_non_ledger_entry_input_guard",
          ]
        coverage_status: "added"
      - target_component: "ConvertedTradingBalanceAggregation"
        test_file: "tests/unit/domain/test_trading_balance_converted.py"
        test_functions:
          [
            "test_empty_returns_no_lines_converted",
            "test_single_currency_base_passthrough",
            "test_single_nonbase_with_rate",
            "test_multi_currency_mixed_and_sorting",
            "test_rounding_half_even_in_base",
            "test_missing_rate_raises_for_non_base",
            "test_non_positive_rate_raises",
            "test_unknown_currency_line_raises",
            "test_base_detection_via_get_base_currency",
            "test_preserve_decimal_context_converted",
            "test_input_guard_non_ledger_entry",
          ]
        coverage_status: "added"
      - target_component: "FxAuditTTLService"
        test_file: "tests/unit/domain/test_fx_audit_ttl.py"
        test_functions:
          [
            "test_identify_old_events",
            "test_archival_plan_sizes",
            "test_make_cutoff_normalization_utc",
            "test_validation_errors",
          ]
        coverage_status: "added"
      - target_component: "Async repositories"
        test_file: "tests/unit/application/test_async_repositories.py"
        test_functions:
          [
            "test_currency_upsert_and_base",
            "test_currency_set_base_missing_raises",
            "test_account_create_and_unique",
            "test_transactions_add_and_list_between_with_meta",
            "test_aggregate_trading_balance",
            "test_ledger_pagination_order_and_edges",
            "test_balances_cache_upsert_get_clear",
            "test_fx_events_list_filters_and_limits",
          ]
        coverage_status: "added"
      - target_component: "Async use cases smoke"
        test_file: "tests/unit/application/test_async_use_cases_smoke.py"
        test_functions:
          [
            "test_async_use_cases_smoke",
            "test_async_set_base_missing_currency_raises",
            "test_async_create_account_missing_currency",
            "test_async_post_transaction_missing_account",
          ]
        coverage_status: "added"
      - target_component: "FX Audit repository (sync)"
        test_file: "tests/unit/test_fx_audit.py"
        test_functions: ["test_fx_audit_events_basic", "test_fx_audit_limit"]
        coverage_status: "exists"
      - target_component: "Docs sections presence"
        test_file: "tests/docs/test_docs_sections_present.py"
        test_functions: ["test_required_doc_sections_present"]
        coverage_status: "added"
      - target_component: "DTO trading balance refactor I09"
        test_file: "tests/unit/domain/test_dto_trading_balance_refactor.py"
        test_functions:
          [
            "test_simple_line_without_converted_fields",
            "test_detailed_line_contains_conversion",
            "test_docstrings_present_public_classes",
            "test_frozen_slots_behavior",
          ]
        coverage_status: "added"
      - target_component: "Application DTO mapping use cases"
        test_file: "tests/unit/application/test_trading_balance_use_cases_dto_mapping.py"
        test_functions:
          [
            "test_raw_use_case_returns_simple_dto",
            "test_detailed_use_case_returns_detailed_dto",
            "test_legacy_alias_points_to_detailed_class",
            "test_no_converted_fields_in_simple_output",
          ]
        coverage_status: "added"
    integration_tests:
      - integration_point: "FX TTL async repository"
        test_description: "Удаление и архивирование событий по порогу давности (async repos)"
        test_file: "tests/integration/test_async_fx_ttl.py"
        coverage_status: "added"
      - integration_point: "Alembic sync migrations"
        test_description: "Upgrade head и downgrade base на синхронном URL; отказ на async URL"
        test_file: "tests/integration/alembic/test_sync_migrations_still_work.py"
        coverage_status: "added"
      - integration_point: "Config dual URLs"
        test_description: "Проверка различий драйверов runtime async и migrations sync"
        test_file: "tests/integration/config/test_dual_url_consistency.py"
        coverage_status: "added"
    fixtures:
      - name: "async_uow"
        file: "tests/conftest.py"
        description: "pytest-asyncio фикстура: создаёт файл-базу SQLite, поднимает схему, открывает Async UoW и закрывает по окончании теста."

  edges:
    inter_module_flows:
      - from: "infrastructure"
        to: "application"
        data_type: "Реализации портов (репозитории/UoW)"
        description: "Адаптеры предоставляют реализацию интерфейсов (sync и async)."

  roadmap_updates:
    - id: "ASYNC-03"
      title: "Перевод репозиториев на async API"
      status: "done"
    - id: "ASYNC-04"
      title: "Сохранение синхронного пути для Alembic и вспомогательных сценариев"
      status: "done"
      notes: "alembic/env.py валидирует sync URL, игнорирует DATABASE_URL_ASYNC, тесты alembic/config/docs добавлены; документация обновлена (INTEGRATION_GUIDE, MIGRATION_HISTORY, README)."
    - id: "ASYNC-05"
      title: "Async Protocols для UoW и репозиториев"
      status: "done"
      notes: "ports.py дополнен AsyncUnitOfWork и Async*Repository Protocol; sync контракты сохранены; добавлен структурный тест test_async_ports_protocols.py."
    - id: "ASYNC-06"
      title: "Use cases: переход на async с минимальным шумом"
      status: "done"
      notes: |
        Добавлен пакет application/use_cases_async с async вариантами ключевых сценариев:
        - Валюты: AsyncCreateCurrency, AsyncSetBaseCurrency, AsyncListCurrencies
        - Счета: AsyncCreateAccount, AsyncGetAccount, AsyncListAccounts
        - Транзакции/Леджер: AsyncPostTransaction, AsyncListTransactionsBetween, AsyncGetLedger, AsyncGetAccountBalance, AsyncGetTradingBalance
        - FX audit: AsyncAddExchangeRateEvent, AsyncListExchangeRateEvents
        Добавлен unit smoke тест tests/unit/application/test_async_use_cases_smoke.py (создание валют/счёта/транзакции, леджер, балансы, edge: limit=0/offset<0, ошибки). Существующие sync use cases не изменялись. Все новые функции имеют докстроки.
    - id: "ASYNC-07"
      title: "CLI/Presentation: синхронные обёртки поверх async use cases"
      status: "done"
      notes: |
        CLI теперь использует async use cases через синхронные фасады (presentation/async_bridge.py) и общий helper run_sync.
        Публичное поведение CLI (формат вывода, тексты ошибок) не изменилось; perf/e2e тесты зелёные.
        Добавлена защита от вложенного event loop, исправлены замечания линтера (UP047, SIM105, import shadowing).
