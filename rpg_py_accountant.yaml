rpg:
  metadata:
    project_name: "py_accountant"
    description: "Монорепозиторий: домен/приложение/инфраструктура/презентация. Цель — Clean Architecture."
    last_updated: "2025-11-14"
    environments:
      - name: "test"
        description: "Тестовая среда: локальный запуск, in-memory ил�� локальный Postgres, подробные логи."
        env_vars:
          - name: "ENV"
            required: true
            notes: "ENV=test"
          - name: "DATABASE_URL"
            required: true
            notes: "sqlite+pysqlite:///:memory: или локальный Postgres (sync для Alembic)"
          - name: "DATABASE_URL_ASYNC"
            required: false
            notes: "Опционально: async runtime URL (postgresql+asyncpg://..., sqlite+aiosqlite:///:memory:)"
          - name: "LOG_LEVEL"
            required: false
            notes: "DEBUG"
          - name: "JSON_LOGS"
            required: false
            notes: "false"
          - name: "LOG_FILE"
            required: false
            notes: "Путь к файлу логов. Включает файловый хендлер только при JSON_LOGS=true."
          - name: "LOG_ROTATION"
            required: false
            notes: "Ротация: 'time' (по времени, по умолчанию) или 'size' (по размеру)."
          - name: "LOG_MAX_BYTES"
            required: false
            notes: "Максимальный размер файла (для 'size'), по умолчанию 10MiB."
          - name: "LOG_BACKUP_COUNT"
            required: false
            notes: "Число резервных файлов, по умолчанию 7."
          - name: "LOG_ROTATE_WHEN"
            required: false
            notes: "Гранулярность для 'time' (например 'midnight')."
          - name: "LOG_ROTATE_UTC"
            required: false
            notes: "Использовать UTC для тайм-ротации (true по умолчанию)."
          - name: "FX_TTL_MODE"
            required: false
            notes: "none|delete|archive (по умолчанию none)"
          - name: "FX_TTL_RETENTION_DAYS"
            required: false
            notes: "Число дней хранения событий (например 90)"
          - name: "FX_TTL_BATCH_SIZE"
            required: false
            notes: "Размер партии TTL/архива (например 1000)"
          - name: "FX_TTL_DRY_RUN"
            required: false
            notes: "Сухой прогон, не изменяет БД"
      - name: "production"
        description: "Продакшен: Postgres, структурированные JSON-логи, минимальные права."
        env_vars:
          - name: "ENV"
            required: true
            notes: "ENV=production"
          - name: "DATABASE_URL"
            required: true
            notes: "postgresql+psycopg://... (для Alembic миграций)"
          - name: "DATABASE_URL_ASYNC"
            required: true
            notes: "postgresql+asyncpg://... (runtime)"
          - name: "LOG_LEVEL"
            required: true
            notes: "INFO или WARN"
          - name: "JSON_LOGS"
            required: true
            notes: "true"
          - name: "LOG_FILE"
            required: false
            notes: "Рекомендуется указать путь до файла для ротации JSON логов."
          - name: "LOG_ROTATION"
            required: false
            notes: "'time' (по умолчанию, ротация в полночь) или 'size'."
          - name: "LOG_MAX_BYTES"
            required: false
            notes: "Размер для 'size' ротации (например 10485760 для 10MiB)."
          - name: "LOG_BACKUP_COUNT"
            required: false
            notes: "Количество архивов логов (по умолчанию 7)."
          - name: "LOG_ROTATE_WHEN"
            required: false
            notes: "Период ротации при 'time' (по умолчанию midnight)."
          - name: "LOG_ROTATE_UTC"
            required: false
            notes: "Использовать UTC (true) или локальное время."
          - name: "FX_TTL_MODE"
            required: false
            notes: "Режим TTL для exchange_rate_events: none|delete|archive"
          - name: "FX_TTL_RETENTION_DAYS"
            required: false
            notes: "Порог давности в днях (рекомендуемо 90+)"
          - name: "FX_TTL_BATCH_SIZE"
            required: false
            notes: "Размер партии (по умолчанию 1000)"
          - name: "FX_TTL_DRY_RUN"
            required: false
            notes: "Сухой прогон, не изменяет БД"

  nodes:
    modules:
      - name: "application"
        path: "src/application"
        description: "Сценарии (use cases), DTO и интерфейсы портов (репозитории, UоW, Clock)."
      - name: "use_cases_async"
        path: "src/application/use_cases_async"
        description: "Async use cases: currencies/accounts/ledger/trading/fx audit (параллельно sync)."
      - name: "domain"
        path: "src/domain"
        description: "Чистый домен: value-объекты, агрегаты, сервисы (баланс, курсы)."
      - name: "domain.errors"
        path: "src/domain/errors.py"
        description: "Минимальный модуль исключений домена: DomainError, ValidationError (без зависимостей)."
      - name: "domain.quantize"
        path: "src/domain/quantize.py"
        description: "Утилиты квантования: money_quantize, rate_quantize (ROUND_HALF_EVEN, локальный контекст, без изменения глобального Decimal)."
      - name: "domain.currencies"
        path: "src/domain/currencies.py"
        description: "Value object Currency и сервис BaseCurrencyRule: единственная базовая валюта, нормализация курсов через rate_quantize, без пересчёта остальных."
      - name: "domain.accounts"
        path: "src/domain/accounts.py"
        description: "Value object Account: валидация full_name (иерархия через ':'), derive name/parent_path, нормализация currency_code (upper, 3..10), parent_id опционален."
      - name: "domain.ledger"
        path: "src/domain/ledger.py"
        description: "Валидатор баланса LedgerValidator: мультивалютная сверка в базовой валюте (money_quantize), без инфраструктурных зависимостей."
      - name: "domain.trading_balance"
        path: "src/domain/trading_balance.py"
        description: "RawAggregator.aggregate: группировка LedgerEntry по currency_code, накопление debit/credit, квантование итогов и вычисление net; возврат list[RawBalanceLine]. ConvertedAggregator.aggregate: группировка + конвертация в базовую валюту (обязан rate_to_base для небазовых), определение базы по base_code или get_base_currency, возврат list[ConvertedBalanceLine] с полями used_rate/debit_base/credit_base/net_base."
      - name: "domain.fx_audit"
        path: "src/domain/fx_audit.py"
        description: "FX Audit TTL domain service: FxAuditTTLService with make_cutoff/identify_old/batch_plan; dataclasses ExchangeRateEventRef, TTLConfig, Batch; ArchivalMode enum; чистая логика без I/O."
      - name: "TTLUseCases"
        path: "src/application/use_cases_async/fx_audit_ttl.py"
        description: "Async TTL use cases for FX audit: plan and execute archival/delete using domain FxAuditTTLService; repositories stay CRUD-only; supports dry_run."
      - name: "infrastructure"
        path: "src/infrastructure"
        description: "Адаптеры: SQLAlchemy, миграции Alembic, внешние сервисы, реализация портов."
      - name: "presentation"
        path: "src/presentation"
        description: "API/CLI: контроллеры, валидация, презентеры."
      - name: "config"
        path: "src/infrastructure/config"
        description: "Конфигурация приложения на pydantic-settings; выбор профиля окружения."
      - name: "logging"
        path: "src/infrastructure/logging"
        description: "Структурированное логирование на structlog; единая инициализация логгера."
      - name: "py_accountant"
        path: "src/py_accountant"
        description: "Публичный пакет-оболочка корневого проекта (версия, утилиты)."
      - name: "py_accountant.sdk"
        path: "src/py_accountant/sdk"
        description: "Публичный SDK-слой: json/errors/use_cases; тонкие фасады над async use cases."
      - name: "py_accountant.sdk.bootstrap"
        path: "src/py_accountant/sdk/bootstrap.py"
        description: "init_app(settings|env) -> AppContext{uow_factory, clock, logger, settings}; runtime-валидация dual-URL."
      - name: "py_accountant.sdk.settings"
        path: "src/py_accountant/sdk/settings.py"
        description: "Загрузка из ENV (DATABASE_URL/DATABASE_URL_ASYNC), validate_dual_url(sync/async)."
      - name: "py_accountant.sdk.uow"
        path: "src/py_accountant/sdk/uow.py"
        description: "build_uow_factory(settings) -> Callable[AsyncSqlAlchemyUnitOfWork]."
      - name: "async_engine"
        path: "src/infrastructure/persistence/sqlalchemy/async_engine.py"
        description: "Async фабрики: normalize_async_url, get_async_engine, get_async_session_factory"
      - name: "repositories_async"
        path: "src/infrastructure/persistence/sqlalchemy/repositories_async.py"
        description: "Async реализации портов репозиториев на SQLAlchemy: CRUD + TTL примитивы (list_old_events/archive_events/delete_events_by_ids). С I31 добавлено: метод accounts.get_balance и апдейт агрегатов при постинге (account_balances, account_daily_turnovers)."
      - name: "asyncio_utils"
        path: "src/infrastructure/utils/asyncio_utils.py"
        description: "Helper run_sync(coro): безопасный запуск корутин из sync-контекста (guard на running loop, PEP695 generic)."
      - name: "async_cli_foundation"
        path: "src/presentation/cli/main.py"
        description: "Async Typer CLI foundation (I21): provides 'version' and 'diagnostics ping' commands, minimal DI (_get_uow, _get_clock), predispatch for help/version/ping without full click stack. Future business commands added in I22+."
      - name: "currencies"
        path: "src/application/use_cases_async/currencies.py"
        description: "DEPRECATED entry; use the module node ниже"
      - name: "currencies (use cases)"
        path: "src/application/use_cases_async/currencies.py"
        description: "use_cases_async/currencies: используют доменные сервисы для валидации и выбора базы; репозитории — только CRUD."
      - name: "accounts"
        path: "src/application/use_cases_async/accounts.py"
        description: "Async аккаунты: AsyncCreateAccount использует domain.Account для валидации и нормализации full_name/currency_code; проверяет существование валюты и уникальность full_name; репозитории — только CRUD. AsyncGetAccount/AsyncListAccounts — passthrough."
      - name: "ledger"
        path: "src/application/use_cases_async/ledger.py"
        description: "Async леджер и баланс: AsyncPostTransaction, AsyncListTransactionsBetween, AsyncGetLedger, AsyncGetAccountBalance (оптимизирован для чтения из account_balances при as_of=None). Legacy AsyncGetTradingBalance — удалён (I30)."
      - name: "fx_audit"
        path: "src/application/use_cases_async/fx_audit.py"
        description: "Async FX audit: AsyncAddExchangeRateEvent, AsyncListExchangeRateEvents."
      - name: "trading_balance"
        path: "src/application/use_cases_async/trading_balance.py"
        description: "Async trading balance use cases (I18): AsyncGetTradingBalanceRaw / Detailed через domain RawAggregator & ConvertedAggregator; репозитории — только CRUD."
      - name: "fx_audit_ttl"
        path: "src/application/use_cases_async/fx_audit_ttl.py"
        description: "AsyncPlanFxAuditTTL (план: cutoff, ids, batches) и AsyncExecuteFxAuditTTL (выполнение: delete/archive с dry_run). Ошибки: ValidationError для параметров и несогласованностей плана."
      - name: "src/infrastructure/persistence/sqlalchemy/models.py"
        parent_module: "infrastructure"
        description: "ORM schema only: CurrencyORM, AccountORM, JournalORM, TransactionLineORM, ExchangeRateEventORM, ExchangeRateEventArchiveORM. I31: добавлены AccountBalanceORM и AccountDailyTurnoverORM."
      - name: "src/infrastructure/persistence/sqlalchemy/repositories_async.py"
        parent_module: "infrastructure"
        description: "Async реализации портов репозиториев на SQLAlchemy: CRUD + TTL примитивы. I31: добавлен fast-path accounts.get_balance и апдейты агрегатов при постинге."
      - name: "src/infrastructure/persistence/sqlalchemy/uow.py"
        parent_module: "infrastructure"
        description: "AsyncSqlAlchemyUnitOfWork only (legacy sync UoW и wrapper удалены в I29)."
      - name: "docs/RUNNING_MIGRATIONS.md"
        parent_module: "infrastructure"
        description: "Helper для CI: запуск Alembic миграций, примеры GitHub Actions/GitLab, checklist."
      - name: "src/infrastructure/utils/asyncio_utils.py"
        parent_module: "infrastructure"
        description: "run_sync(coro): запрет nested loop, корректное закрытие корутины при ошибке."
      - name: "src/py_accountant/sdk/__init__.py"
        parent_module: "py_accountant.sdk"
        description: "Экспорт модулей SDK: json, errors, use_cases, reports."
      - name: "src/py_accountant/sdk/json.py"
        parent_module: "py_accountant.sdk"
        description: "JSON presenter: Decimal→str, datetime→ISO8601 UTC (Z/+00:00), детерминированный dumps."
      - name: "src/py_accountant/sdk/errors.py"
        parent_module: "py_accountant.sdk"
        description: "Публичные ошибки SDK и map_exception() для маппинга внутренних исключений."
      - name: "src/py_accountant/sdk/use_cases.py"
        parent_module: "py_accountant.sdk"
        description: "SimpleTransactionParser и тонкие async фасады post_transaction/get_account_balance/get_ledger."
      - name: "py_accountant.sdk.reports"
        path: "src/py_accountant/sdk/reports"
        description: "SDK отчётность: пакет фасадов отчётов поверх денормализованных агрегатов."
      - name: "py_accountant.sdk.reports.turnover"
        path: "src/py_accountant/sdk/reports/turnover.py"
        description: "Фасад get_account_daily_turnovers: читает account_daily_turnovers, возвращает DailyTurnoverLine[], маппит ошибки через sdk.errors."
      - name: "examples/telegram_bot/app.py"
        parent_module: "presentation"
        description: "Пример Telegram-бота обновлён на SDK bootstrap (init_app → uow_factory), единый подход к ошибкам/форматам (I-DOC-01)."
      - name: "examples/telegram_bot/README.md"
        parent_module: "presentation"
        description: "README примера обновлён: запуск через SDK bootstrap, smoke-вызовы, локальный SQLite (I-DOC-01)."

  tests:
    unit_tests:
      - target_component: "AsyncGetAccountBalance"
        test_file: "tests/unit/application/test_async_get_account_balance.py"
        test_functions: ["test_balance_computed_via_ledger_scan", "test_balance_empty_zero"]
        coverage_status: "updated for fast-path"
      - target_component: "AccountAggregates"
        test_file: "tests/unit/infrastructure/test_account_aggregates.py"
        test_functions: ["test_repository_upserts_balance", "test_repository_upserts_turnover_same_day_multiple_lines", "test_repository_concurrent_postings_consistent_balance", "test_get_balance_fallback_zero_when_missing", "test_get_balance_matches_legacy_scan"]
        coverage_status: "added"
      - target_component: "DomainErrors"
        test_file: "tests/unit/domain/test_errors.py"
        test_functions: ["test_errors_raise_and_inherit"]
        coverage_status: "added"
      - target_component: "QuantizeUtilities"
        test_file: "tests/unit/domain/test_quantize.py"
        test_functions: ["test_money_quantize_rounds", "test_rate_quantize_rounds", "test_no_global_context_mutation"]
        coverage_status: "added"
      - target_component: "CurrencyValueObject"
        test_file: "tests/unit/domain/test_currency_base_rule.py"
        test_functions: ["test_set_base_preserves_other_rates", "test_clear_base", "test_set_base_missing_code_raises"]
        coverage_status: "added"
      - target_component: "AccountValueObject"
        test_file: "tests/unit/domain/test_accounts.py"
        test_functions: ["test_account_full_name_validation", "test_account_parent_id_optional", "test_account_full_name_invalid_raises"]
        coverage_status: "added"
      - target_component: "LedgerBalanceValidation"
        test_file: "tests/unit/domain/test_ledger_balance.py"
        test_functions:
          [
            "test_single_currency_balanced",
            "test_multi_currency_balanced_with_rates",
            "test_unbalanced_detected",
            "test_negative_cases",
            "test_entry_validation",
            "test_non_base_currency_rate_required_and_positive",
            "test_rounding_half_even_comparison",
          ]
        coverage_status: "added"
      - target_component: "RawTradingBalanceAggregation"
        test_file: "tests/unit/domain/test_trading_balance_raw.py"
        test_functions:
          [
            "test_empty_returns_no_lines",
            "test_single_currency_aggregate",
            "test_multi_currency_aggregate_separate_groups",
            "test_rounding_half_even_each_currency",
            "test_preserve_decimal_context",
            "test_reject_non_ledger_entry_input_guard",
          ]
        coverage_status: "added"
      - target_component: "ConvertedTradingBalanceAggregation"
        test_file: "tests/unit/domain/test_trading_balance_converted.py"
        test_functions:
          [
            "test_empty_returns_no_lines_converted",
            "test_single_currency_base_passthrough",
            "test_single_nonbase_with_rate",
            "test_multi_currency_mixed_and_sorting",
            "test_rounding_half_even_in_base",
            "test_missing_rate_raises_for_non_base",
            "test_non_positive_rate_raises",
            "test_unknown_currency_line_raises",
            "test_base_detection_via_get_base_currency",
            "test_preserve_decimal_context_converted",
            "test_input_guard_non_ledger_entry",
          ]
        coverage_status: "added"
      - target_component: "FxAuditTTLService"
        test_file: "tests/unit/domain/test_fx_audit_ttl.py"
        test_functions:
          [
            "test_identify_old_events",
            "test_archival_plan_sizes",
            "test_make_cutoff_normalization_utc",
            "test_validation_errors",
          ]
        coverage_status: "added"
      - target_component: "py_accountant.sdk"
        test_file: "tests/unit/sdk/test_imports.py"
        test_functions: ["test_sdk_imports_available_from_root"]
        coverage_status: "added"
      - target_component: "py_accountant.sdk"
        test_file: "tests/unit/sdk/test_json_presenter.py"
        test_functions:
          [
            "test_decimal_to_str",
            "test_datetime_aware_to_z",
            "test_datetime_naive_treated_as_utc",
            "test_list_of_dicts_serializes",
            "test_to_json_deterministic_keys",
          ]
        coverage_status: "added"
      - target_component: "py_accountant.sdk"
        test_file: "tests/unit/sdk/test_error_mapping.py"
        test_functions:
          [
            "test_map_validation_error_to_user_input",
            "test_map_domain_error_to_domain_violation",
            "test_map_value_error_to_user_input",
            "test_map_other_to_unexpected",
          ]
        coverage_status: "added"
      - target_component: "py_accountant.sdk.settings"
        test_file: "tests/unit/sdk/test_settings_dual_url.py"
        test_functions:
          [
            "test_only_async_url_ok",
            "test_sync_and_async_pair_sqlite_ok",
            "test_sync_is_async_driver_raises",
            "test_async_is_sync_driver_raises",
            "test_mismatched_hosts_pg_raises",
            "test_missing_both_urls_raises_in_init_app_when_use_env_true",
          ]
        coverage_status: "added"
      - target_component: "DocsPresence"
        test_file: "tests/docs/test_docs_sections_present.py"
        test_functions:
          [
            "test_readme_has_sdk_surface_section",
            "test_integration_guide_has_dual_url_and_sdk",
            "test_cheatsheet_exists_and_has_sections",
          ]
        coverage_status: "added"
      - target_component: "SDKReportsTurnover"
        test_file: "tests/unit/sdk/test_reports_turnover.py"
        test_functions: [
          "test_turnover_empty",
          "test_turnover_single_day",
          "test_turnover_cross_days",
          "test_turnover_validation",
        ]
        coverage_status: "added"

  edges:
    inter_module_flows:
      - from: "infrastructure"
        to: "application"
        data_type: "Реализации портов (репозитории/UoW)"
        description: "Адаптеры предоставляют реализацию интерфейсов (async only)."
      - from: "application.use_cases_async.ledger"
        to: "infrastructure.persistence.sqlalchemy.repositories_async"
        data_type: "Use case → Repository"
        description: "Постинг транзакций и чтение баланса через репозитории."
      - from: "application.use_cases_async.ledger"
        to: "application.ports"
        data_type: "Use case → Ports"
        description: "Зависит от протоколов AsyncUnitOfWork/Repositories."
      - from: "infrastructure.persistence.sqlalchemy.repositories_async"
        to: "infrastructure.persistence.sqlalchemy.models"
        data_type: "Repository → ORM models"
        description: "Работа с ORM классами, включая агрегаты I31."
      - from: "infrastructure.persistence.sqlalchemy.repositories_async"
        to: "infrastructure.persistence.sqlalchemy.uow"
        data_type: "Repository → UoW"
        description: "Использование AsyncSession в транзакционном scope."
      - from: "py_accountant.sdk.use_cases"
        to: "application.use_cases_async.ledger"
        data_type: "SDK facade → Use case"
        description: "SDK вызывает AsyncGetAccountBalance/AsyncPostTransaction."
      - from: "py_accountant.sdk.reports.turnover"
        to: "infrastructure.persistence.sqlalchemy.models"
        data_type: "SDK facade → ORM"
        description: "Читает агрегаты AccountDailyTurnoverORM через UoW session."
      - from: "py_accountant.sdk.reports.turnover"
        to: "infrastructure.persistence.sqlalchemy.uow"
        data_type: "SDK facade → UoW (session)"
        description: "Использует AsyncSession из AsyncSqlAlchemyUnitOfWork."
      - from: "py_accountant.sdk.reports.turnover"
        to: "py_accountant.sdk.json"
        data_type: "Serialization"
        description: "Результаты сериализуются JSON презентером (Decimal→str, datetime→ISO)."
      - from: "tests.unit.sdk"
        to: "py_accountant.sdk.reports.turnover"
        data_type: "Tests → SDK reports"
        description: "Юнит-тесты фасада отчётности по оборотам."
      - from: "tests.integration.ledger"
        to: "application.use_cases_async.ledger"
        data_type: "Integration tests → Use case"
        description: "Проверка сценариев постинга и получения баланса."

  validation_matrix:
    requirement_to_test_map:
      - sdk_fast_balance: [
          "tests/unit/sdk/test_balance_fast_path_smoke.py",
          "tests/unit/application/test_async_get_account_balance.py",
        ]
      - sdk_docs_updated: [
          "tests/docs/test_docs_sections_present.py",
        ]
      - sdk_serialization_stable: [
          "tests/unit/sdk/test_json_presenter.py",
        ]
      - sdk_errors_mapping: [
          "tests/unit/sdk/test_error_mapping.py",
        ]
      - sdk_turnovers_facade: [
          "tests/unit/sdk/test_reports_turnover.py",
        ]

  roadmap_updates:
    - id: "ASYNC-03"
      title: "Перевод репозиториев на async API"
      status: "done"
    - id: "ASYNC-04"
      title: "Сохранение синхронного пути для Alembic и вспомогательных сценариев"
      status: "done"
      notes: "alembic/env.py валидирует sync URL, игнорирует DATABASE_URL_ASYNC, тесты alembic/config/docs добавлены; документация обновлена (INTEGRATION_GUIDE, MIGRATION_HISTORY, README)."
    - id: "ASYNC-05"
      title: "Async Protocols для UoW и репозиториев"
      status: "done"
      notes: "ports.py дополнен AsyncUnitOfWork и Async*Repository Protocol; sync контракты сохранены; добавлен структурный тест test_async_ports_protocols.py."
    - id: "ASYNC-06"
      title: "Use cases: переход на async с минимальным шумом"
      status: "done"
      notes: |
        Добавлен пакет application/use_cases_async с async вариантами ключевых сценариев:
        - Валюты: AsyncCreateCurrency, AsyncSetBaseCurrency, AsyncListCurrencies
        - Счета: AsyncCreateAccount, AsyncGetAccount, AsyncListAccounts
        - Транзакции/Леджер: AsyncPostTransaction, AsyncListTransactionsBetween, AsyncGetLedger, AsyncGetAccountBalance, AsyncGetTradingBalance
        - FX audit: AsyncAddExchangeRateEvent, AsyncListExchangeRateEvents
        Добавлен unit smoke тест tests/unit/application/test_async_use_cases_smoke.py (создание валют/счёта/транзакции, леджер, балансы, edge: limit=0/offset<0, ошибки). Существующие sync use cases не изменялись. Все новые функции имеют докстроки.
    - id: "ASYNC-07"
      title: "CLI/Presentation: синхронные обёртки поверх async use cases"
      status: "done"
      notes: |
        CLI ранее временно использовал async use cases через синхронные фасады (presentation/async_bridge.py) и helper run_sync.
        В I27 этот слой удалён; CLI работает напрямую через async команды и эфемерный async UoW.
    - id: "I28"
      title: "Deprecate sync repositories"
      status: "done"
      notes: "repositories.py заменён на заглушки; добавлены структурные тесты; граф обновлён."
    - id: "I29"
      title: "Удаление legacy sync UoW и репозиториев"
      status: "done"
      notes: "Удалены классы SqlAlchemyUnitOfWork, SyncUnitOfworkWrapper и репозитории из repositories.py; осталась только асинхронная реализация."
    - id: "I-UX-01"
      title: "CLI улучшение post: occurred-at, Rate, дружелюбные ошибки"
      status: "done"
      notes: |
        Внедрены улучшения CLI леджера: опция --occurred-at (UTC), парсер --line с опциональным :Rate и поддержкой вложенных ':' в Account, дружелюбный маппинг ошибок через SDK; совместимость флагов/формата сохранена; добавлены интеграционные тесты tests/integration/cli/test_cli_ledger_post_minimal.py."
    - id: "I-DX-02"
      title: "SDK bootstrap/settings/uow и runtime‑валидация dual‑URL"
      status: "done"
      notes: "Добавлены модули sdk.settings/uow/bootstrap, обновлены реэкспорты в sdk и корне, добавлены тесты (unit/integration); pytest зелёный."
    - id: "I-UX-02"
      title: "CLI загрузка строк из файла (CSV/JSON)"
      status: "done"
      notes: |
        В 'ledger post' добавлена опция --lines-file <path> с поддержкой CSV (заголовки side,account,amount,currency[,rate]) и JSON (массив строк или объектов). Строки из файла нормализуются к формату парсера и объединяются с --line; порядок сохраняется. Ошибки формата/файла приводят к exit code 2 (через sdk.errors.map_exception). Добавлены интеграционные тесты tests/integration/cli/test_cli_ledger_post_files.py."
    - id: "I-DX-03"
      title: "Идемпотентность постинга транзакций"
      status: "done"
      changes:
        - "CLI: добавлен флаг --idempotency-key; приоритет над --meta idempotency_key; пустые строки игнорируются."
        - "ORM: JournalORM получил nullable колонку idempotency_key (String(255)); добавлен уникальный индекс."
        - "Repo: AsyncSqlAlchemyTransactionRepository — метод get_by_idempotency_key(); add() теперь проверяет ключ и сохраняет tx_id в journal.meta для стабильного возврата id; обработка IntegrityError для гонок."
        - "Alembic: миграция 0006_add_journal_idempotency_key (batch + unique index для SQLite совместимости)."
      tests:
        - "tests/integration/test_idempotent_posting.py"
      notes:
        - "Поведение без ключа не изменилось; повторные постинги с одним ключом возвращают первый tx.id (tx:<uuid>)."
        - "Конкурентные вставки защищены уникальным индексом; при конфликте выполняется повторное чтение."
    - id: "I-DOC-01"
      title: "Документация и примеры на SDK"
      status: "done"
      notes: |
        Добавлен раздел "SDK surface" в README с краткими примерами init_app/post/balance/ledger и ссылками.
        В docs/INTEGRATION_GUIDE.md консолидирован dual-URL и добавлена подробная секция по SDK (init_app/UоW/операции/TTL/errors/форматы).
        Создан новый файл docs/ACCOUNTING_CHEATSHEET.md с форматами, файлами, ошибками и идемпотентностью.
        Пример Telegram-бота обновлён на SDK bootstrap; README примера переписан.
        Добавлен docs-тест tests/docs/test_docs_sections_present.py на наличие ключевых разделов.
      tests:
        - "tests/docs/test_docs_sections_present.py"
    - id: "I13-cleanup-fx-orchestration"
      title: "Удаление orchestration метода move_events_to_archive из async FX репозитория"
      status: "done"
      notes: "Метод удалён из AsyncSqlAlchemyExchangeRateEventsRepository и AsyncExchangeRateEventsRepository Protocol; TTL теперь только через примитивы list_old_events + archive_events + delete_events_by_ids; оркестрация (plan/execute) в FxAuditTTLService и use cases."
    - id: "I31"
      title: "Денормализованные агрегаты баланса/оборотов и fast-path баланса (AsyncGetAccountBalance)"
      status: "done (phase 1)"
      notes: |
        Выполнено:
        - Миграции / ORM: добавлены таблицы account_balances и account_daily_turnovers; в models.py добавлены AccountBalanceORM и AccountDailyTurnoverORM.
        - Репозитории: при постинге транзакции выполняется upsert агрегатов; accounts.get_balance читает из account_balances с fallback=0.
        - Use case: AsyncGetAccountBalance использует fast-path для текущего баланса.
        - Тесты: добавлены unit-тесты tests/unit/infrastructure/test_account_aggregates.py.
        - Документация: README и docs/ACCOUNTING_CHEATSHEET.md дополнены секцией о денормализации (I31).
        Следующие шаги:
        - Интеграционные и performance-тесты для Postgres (конкурентные постинги и бенчмарки).
    - id: "I31-SDK"
      title: "SDK фасад периодных оборотов (turnovers) на агрегатах"
      status: "done"
      notes: "Добавлен модуль sdk.reports.turnover.get_account_daily_turnovers; покрыт юнит-тестами и отражён в README."
