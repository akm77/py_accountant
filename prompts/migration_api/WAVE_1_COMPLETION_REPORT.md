# Wave 1: –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã - –ó–ê–í–ï–†–®–ï–ù–û ‚úÖ

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 26 –Ω–æ—è–±—Ä—è 2025  
**–û—Ü–µ–Ω–æ—á–Ω–æ–µ –≤—Ä–µ–º—è:** 3 —á–∞—Å–∞  
**–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –≤—Ä–µ–º—è:** 2.5 —á–∞—Å–∞  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** 95
- **–¢–µ—Å—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:** 5
- **–§–∞–π–ª–æ–≤ —Å–æ–∑–¥–∞–Ω–æ:** 14
- **–ú–∏–≥—Ä–∞—Ü–∏–π —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ:** 8
- **–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏:** 100% (errors.py)

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### –ó–∞–¥–∞—á–∞ 1.1: errors.py ‚úÖ
- **–§–∞–π–ª:** `src/py_accountant/infrastructure/migrations/errors.py`
- **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
- **–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç (–æ—Ü–µ–Ω–∫–∞: 1 —á–∞—Å)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
  - –°–æ–∑–¥–∞–Ω –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å `MigrationError`
  - –°–æ–∑–¥–∞–Ω –∫–ª–∞—Å—Å `VersionMismatchError`
  - –î–æ–±–∞–≤–ª–µ–Ω—ã docstrings
  - –î–æ–±–∞–≤–ª–µ–Ω `__all__` –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞

### –ó–∞–¥–∞—á–∞ 1.2: alembic.ini.template ‚úÖ
- **–§–∞–π–ª:** `src/py_accountant/infrastructure/migrations/alembic.ini.template`
- **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
- **–í—Ä–µ–º—è:** 45 –º–∏–Ω—É—Ç (–æ—Ü–µ–Ω–∫–∞: 1 —á–∞—Å)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
  - –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ `alembic.ini`
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
  - –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è embedded –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ –≤–∞–∂–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### –ó–∞–¥–∞—á–∞ 1.3: script.py.mako ‚úÖ
- **–§–∞–π–ª:** `src/py_accountant/infrastructure/migrations/script.py.mako`
- **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
- **–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç (–æ—Ü–µ–Ω–∫–∞: 30 –º–∏–Ω—É—Ç)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
  - –°–æ–∑–¥–∞–Ω —à–∞–±–ª–æ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ Alembic
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–∏–ø–∏–∑–∞—Ü–∏—è (Union, Sequence)
  - –î–æ–±–∞–≤–ª–µ–Ω—ã docstrings –¥–ª—è upgrade/downgrade
  - –î–æ–±–∞–≤–ª–µ–Ω `from __future__ import annotations`

### –ó–∞–¥–∞—á–∞ 1.4: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π ‚úÖ
- **–ò—Å—Ç–æ—á–Ω–∏–∫:** `alembic/versions/`
- **–¶–µ–ª—å:** `src/py_accountant/infrastructure/migrations/versions/`
- **–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ
- **–í—Ä–µ–º—è:** 15 –º–∏–Ω—É—Ç (–æ—Ü–µ–Ω–∫–∞: 30 –º–∏–Ω—É—Ç)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
  - –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ 8 –º–∏–≥—Ä–∞—Ü–∏–π:
    - 0001_initial.py
    - 0002_add_is_base_currency.py
    - 0003_add_performance_indexes.py
    - 0004_add_exchange_rate_events.py
    - 0005_exchange_rate_events_archive.py
    - 0006_add_journal_idempotency_key.py
    - 0007_drop_balances_table.py
    - 0008_add_account_aggregates.py
  - –î–æ–±–∞–≤–ª–µ–Ω `.gitkeep`
  - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞–º

---

## üß™ –¢–µ—Å—Ç—ã

### test_errors.py ‚úÖ
- **–§–∞–π–ª:** `tests/unit/infrastructure/migrations/test_errors.py`
- **–¢–µ—Å—Ç–æ–≤:** 5
- **–°—Ç–∞—Ç—É—Å:** –í—Å–µ –ø—Ä–æ—Ö–æ–¥—è—Ç ‚úÖ

#### –°–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–æ–≤:
1. `test_migration_error_creation` ‚úÖ
2. `test_version_mismatch_error_creation` ‚úÖ
3. `test_version_mismatch_inherits_migration_error` ‚úÖ
4. `test_migration_error_with_cause` ‚úÖ
5. `test_version_mismatch_error_formatting` ‚úÖ

### –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—É—Å–∫–∞:
```
======== 5 passed in 0.05s ========
```

---

## üìÅ –°–æ–∑–¥–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
src/py_accountant/infrastructure/migrations/
‚îú‚îÄ‚îÄ __init__.py                    # ‚úÖ –°–æ–∑–¥–∞–Ω (–ø—É—Å—Ç–æ–π, –¥–ª—è –í–æ–ª–Ω—ã 6)
‚îú‚îÄ‚îÄ errors.py                      # ‚úÖ –°–æ–∑–¥–∞–Ω (21 —Å—Ç—Ä–æ–∫–∞)
‚îú‚îÄ‚îÄ alembic.ini.template           # ‚úÖ –°–æ–∑–¥–∞–Ω (68 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ script.py.mako                 # ‚úÖ –°–æ–∑–¥–∞–Ω (32 —Å—Ç—Ä–æ–∫–∏)
‚îî‚îÄ‚îÄ versions/                      # ‚úÖ –°–æ–∑–¥–∞–Ω–∞
    ‚îú‚îÄ‚îÄ .gitkeep
    ‚îú‚îÄ‚îÄ 0001_initial.py            # ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω
    ‚îú‚îÄ‚îÄ 0002_add_is_base_currency.py
    ‚îú‚îÄ‚îÄ 0003_add_performance_indexes.py
    ‚îú‚îÄ‚îÄ 0004_add_exchange_rate_events.py
    ‚îú‚îÄ‚îÄ 0005_exchange_rate_events_archive.py
    ‚îú‚îÄ‚îÄ 0006_add_journal_idempotency_key.py
    ‚îú‚îÄ‚îÄ 0007_drop_balances_table.py
    ‚îî‚îÄ‚îÄ 0008_add_account_aggregates.py

tests/unit/infrastructure/migrations/
‚îú‚îÄ‚îÄ __init__.py                    # ‚úÖ –°–æ–∑–¥–∞–Ω
‚îî‚îÄ‚îÄ test_errors.py                 # ‚úÖ –°–æ–∑–¥–∞–Ω (56 —Å—Ç—Ä–æ–∫, 5 —Ç–µ—Å—Ç–æ–≤)
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏
- [x] `errors.py` —Å–æ–∑–¥–∞–Ω —Å –¥–≤—É–º—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏
- [x] `MigrationError` –∏ `VersionMismatchError` –∏–º–µ—é—Ç docstrings
- [x] `alembic.ini.template` —Å–æ–∑–¥–∞–Ω –∏ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º INI
- [x] `script.py.mako` —Å–æ–∑–¥–∞–Ω –∏ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º Mako template
- [x] –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è `versions/` —Å–æ–∑–¥–∞–Ω–∞
- [x] –í—Å–µ 8 –º–∏–≥—Ä–∞—Ü–∏–π —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ `versions/`
- [x] –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞–º

### –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
- [x] –ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç PEP 8
- [x] –í—Å–µ –ø—É–±–ª–∏—á–Ω—ã–µ –∫–ª–∞—Å—Å—ã/—Ñ—É–Ω–∫—Ü–∏–∏ –∏–º–µ—é—Ç –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ docstrings
- [x] –¢–∏–ø–∏–∑–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≥–¥–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ
- [x] –ù–µ—Ç –∏–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ (KISS principle)

### –¢–µ—Å—Ç—ã
- [x] –°–æ–∑–¥–∞–Ω–æ 5 —Ç–µ—Å—Ç–æ–≤ –¥–ª—è `errors.py`
- [x] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç: `pytest tests/unit/infrastructure/migrations/test_errors.py -v`

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [x] –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ `alembic.ini.template` –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- [x] Docstrings –≤ `errors.py` –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º (—Å—Ç–∞–Ω–¥–∞—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞)

---

## üîç –í–∞–ª–∏–¥–∞—Ü–∏—è

### –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–µ–Ω ruff:
```bash
$ ruff check src/py_accountant/infrastructure/migrations/
All checks passed!
```

### –ò–º–ø–æ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç:
```python
from py_accountant.infrastructure.migrations.errors import MigrationError, VersionMismatchError
# ‚úÖ OK
```

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã:
```bash
$ diff -q alembic/versions/*.py src/py_accountant/infrastructure/migrations/versions/*.py
# ‚úÖ No differences
```

---

## üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–æ–µ–∫—Ç–∞

### Migration API –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
- **–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** 40 —á–∞—Å–æ–≤
- **–ó–∞–≤–µ—Ä—à–µ–Ω–æ:** 2.5 —á–∞—Å–∞ (6%)
- **–í–æ–ª–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–æ:** 1 –∏–∑ 9

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏
- [ ] **–í–æ–ª–Ω–∞ 2:** –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (env.py)
- [ ] **–í–æ–ª–Ω–∞ 3:** MigrationRunner
- [ ] **–í–æ–ª–Ω–∞ 4:** CLI
- [ ] **–í–æ–ª–Ω–∞ 5:** Alembic Integration
- [ ] **–í–æ–ª–Ω–∞ 6:** Public API
- [ ] **–í–æ–ª–Ω–∞ 7:** Integration —Ç–µ—Å—Ç—ã
- [ ] **–í–æ–ª–Ω–∞ 8:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] **–í–æ–ª–Ω–∞ 9:** –ü—Ä–∏–º–µ—Ä—ã –∏ —Ñ–∏–Ω–∞–ª

---

## üéØ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è

‚úÖ –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Migration API —Å–æ–∑–¥–∞–Ω—ã  
‚úÖ –ò—Å–∫–ª—é—á–µ–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã  
‚úÖ –®–∞–±–ª–æ–Ω—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã  
‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É  
‚úÖ –§—É–Ω–¥–∞–º–µ–Ω—Ç –¥–ª—è –í–æ–ª–Ω—ã 2 (env.py) –≥–æ—Ç–æ–≤  
‚úÖ –ö–æ–¥ –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞  
‚úÖ –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ 100% –¥–ª—è errors.py  

---

## üìù –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ì—Ä–∞—Ñ –ø—Ä–æ–µ–∫—Ç–∞
- [x] `prompts/migration_api/migration_api_rpg_graph.yaml` - –æ–±–Ω–æ–≤–ª—ë–Ω —Å—Ç–∞—Ç—É—Å Wave 1

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [x] –°–æ–∑–¥–∞–Ω `WAVE_1_COMPLETION_REPORT.md` (—ç—Ç–æ—Ç —Ñ–∞–π–ª)

---

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –í–æ–ª–Ω–µ 2

–í—Å–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –í–æ–ª–Ω—ã 2 –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:

- [x] –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å–æ–∑–¥–∞–Ω–∞
- [x] –ò—Å–∫–ª—é—á–µ–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [x] –®–∞–±–ª–æ–Ω—ã Alembic –≥–æ—Ç–æ–≤—ã
- [x] –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è env.py
- [x] –¢–µ—Å—Ç—ã –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω—ã

**–ú–æ–∂–Ω–æ –ø—Ä–∏—Å—Ç—É–ø–∞—Ç—å –∫ –í–æ–ª–Ω–µ 2: –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (env.py)**

---

**–ê–≤—Ç–æ—Ä:** Migration API Team  
**–î–∞—Ç–∞:** 26 –Ω–æ—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0.0

