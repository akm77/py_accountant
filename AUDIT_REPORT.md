# Py-Accountant: аудит архитектуры и кода

_Дата:_ 2025-11-16  \
_Аудитор:_ GitHub Copilot (роль системного архитектора)

## 1. Исполнительное резюме
| Область | Статус | Комментарии |
| --- | --- | --- |
| Слоистая архитектура | ✅ Сильная | Чёткое разделение (Domain → Application → Infrastructure → Presentation), выполнение исключительно в async-режиме соблюдается. |
| Зависимости и инструменты | ⚠️ Нужна чистка | Современный стек (Python 3.13, SQLAlchemy 2.x, Typer, Ruff), но зависимости Poetry смешивают прод и dev, часть пинов не обоснована. |
| Качество кода | ⚠️ Смешанное | Доменные объекты и use case'ы структурированы, но линтер обнаружил 66 нарушений (именование, неиспользуемые импорты, типизация). |
| Тестирование | ⚠️ Частичный сигнал | Полный `pytest` прерван >5 мин, зато `tests/unit` прошёл (265 ✅, 2 skip). Нужно восстановить телеметрию полного прогона. |
| Документация и DX | ✅ Полная | README + docs (шпаргалка, интеграции, архитектура) актуальны; RPG-граф обновлён (2025-11-14). |
| Наблюдаемость и эксплуатация | ❓ Неизвестно | Логирование описано, но нет явных следов метрик/трейсинга или CI-скриптов в репо. |

**Ключевые риски**
1. **Задолженность по линту мешает CI** — Ruff фиксирует 66 проблем (именование, импорты, типы), что ломает CI и сигнализирует о дрейфе стиля.
2. **Длительные интеграционные тесты** — полный `pytest` (377 тестов) превысил 5 минут и был прерван; медленная обратная связь скрывает регрессии.
3. **Гигиена зависимостей** — базовые пакеты (asyncpg, alembic, structlog) находятся в общем разделе, нет прозрачности между рантаймом и dev-only.

**Быстрые победы**
- Аккуратно запустить `ruff --fix`, затем вручную добить оставшиеся случаи (лямбды `l`, Option по умолчанию, `assert False`).
- Чётко развести Poetry-группы (`[tool.poetry.dependencies]` vs `[tool.poetry.group.dev]`), чтобы прод-установка была легче.
- Оптимизировать/распараллелить интеграционные тесты (reuse БД, CLI-fixtures) или завести целевые цели (`pytest tests/unit tests/integration/cli -m "not slow"`).

## 2. Журнал доказательств
| Команда | Итог |
| --- | --- |
| `poetry run pytest` | **Timeout** через ~300 c на интеграционных тестах (лог обрывается на `tests/integration/test_idempotent_posting.py`). |
| `poetry run pytest tests/unit -q` | **PASS** — 265 пройдено / 2 пропущено за 8.15 c (Python 3.13.3). |
| `poetry run ruff check` | **FAIL** — 66 находок: порядок импортов, лямбды `l`, `assert False`, модернизация typing, Option по умолчанию, неиспользуемые импорты. |
| Обзор документации | README, `docs/ARCHITECTURE_OVERVIEW.md` и RPG YAML (`rpg_py_accountant.yaml`) подтверждают async-only подход. |

## 3. Топология репозитория
- Корень: `README.md`, `docker-compose.yml`, `pyproject.toml`, `poetry.lock`, `.pre-commit-config.yaml`, `rpg_py_accountant.yaml` (RPG-граф).
- Исходники: `src/domain`, `src/application`, `src/infrastructure`, `src/presentation`, `src/py_accountant/sdk` — соответствуют Clean Architecture.
- Миграции: `alembic/`, версии до `0008_add_account_aggregates.py` (инициатива I31 для быстрых балансов).
- Тесты: `tests/unit`, `tests/integration`, `tests/e2e`, `tests/docs`, `tests/examples`, `tests/perf` — широкое покрытие, но требуется маркировка для контроля времени.
- Документация: каталог `docs/` (архитектура, шпаргалка, интеграции, FX audit, trading windows, parity/performance, миграции).
- Примеры: `examples/telegram_bot` демонстрирует использование SDK bootstrap.

## 4. Оценка зависимостей и инструментов
- **Рантайм** (`pyproject.toml`): `sqlalchemy 2.x`, `psycopg 3.x`, `pydantic 2.7`, `pydantic-settings 2.2`, `typer 0.12`, `click 8.1.7`, `asyncpg`, `alembic`, `structlog`, `aiosqlite`. Dev-инструменты: `pytest>=8`, `pytest-asyncio`, `ruff`, `pre-commit`.
- **Наблюдения**:
  - Средовые пакеты (`asyncpg`, `alembic`, `structlog`) находятся в основном разделе; стоит вынести в группы (prod/dev/extras).
  - Требование Python `>=3.13,<4.0`; убедиться, что все пины реально поддерживают 3.13 (structlog 25.x и Typer 0.12 — да, но проверить транзитивные зависимости).
  - Конфиг Ruff строгий, но фактически не соблюдается (см. §6).
  - Pre-commit есть; важно синхронизировать хуки с CI (Ruff, pytest, форматтер).

## 5. Качество кода и архитектура
- **Домен** — value-объекты (`domain/accounts.py`, `domain/currencies.py`), квантизация, сервисы леджера/трейдинга без внешних зависимостей.
- **Прикладной слой** — async use case'ы (`application/use_cases_async/ledger.py` и др.) инкапсулируют оркестрацию, опираются на Protocol-порты. Docstring описывают контракты и ошибки.
- **Инфраструктура** — Async SQLAlchemy-репозитории строго CRUD, реализуют агрегаты и TTL-примитивы.
- **SDK** — публичный фасад (bootstrap, JSON, ошибки) для интеграторов, стабильные API.
- **Замеченные проблемы**:
  - Массовое использование лямбды `l` → `E741` (читаемость и сопровождение).
  - CLI напрямую вызывает `typer.Option` в аргументах функции (`B008`) — нужно `Annotated` или синглтоны.
  - Некоторые дженерики/типизация (`run_ephemeral_async_uow`) не задают TypeVar (UP047).

## 6. Тесты и QA
- **Покрытие** — 377 тестов: docs, примеры, множество интеграций (CLI, config, DB, ledger, reporting), SDK, unit для домена и инфраструктуры.
- **Время** — полный прогон >5 мин (CLI-вызовы + миграции). Стоит профилировать, включить по умолчанию `pytest -m "not slow"` или разделить пайплайны.
- **Проверка fast-path** — есть юнит-тесты агрегатов аккаунтов и быстрых балансов, что подтверждает фокус на целостности данных.
- **Явных падений** — нет в целевом unit-прогоне; линт — красный (см. §7).

## 7. Линт и статический анализ
- Примеры находок Ruff:
  - **Лямбды `l` (`E741`)** — десятки случаев в application/presentation/tests.
  - **Опции Typer (`B008`)** — вызовы `Option` в сигнатурах вместо `Annotated`.
  - **`assert False` (`B011`)** — в тестах, заменить на `pytest.fail` или `with pytest.raises`.
  - **Импорты (`I001`, `F401`)** — несортированные или неиспользуемые импорты (Alembic, тесты).
  - **Современная типизация (`UP007`, `UP017`, `UP047`)** — синтаксис `str | None`, `datetime.UTC`, корректные TypeVar.
  - **Читаемость (`SIM108`)** — простые тернарные выражения.
- **Рекомендация** — применить `ruff --fix` к импортам и простым правилам, затем вручную устранить сложные случаи (Option, лямбды, тестовые assert). Подключить Ruff к CI.

## 8. Документация и DX
- README покрывает quick start, SDK-пример, CLI, быстрые балансы.
- Каталог docs содержит архитектуру, FX audit, trading windows, parity, performance, миграции, интеграционный гид, шпаргалку.
- RPG-граф (`rpg_py_accountant.yaml`) детализирован (обновлён 2025-11-14), перечисляет модули, порты, тесты, связи — отличный onboarding.
- Примеры (`examples/telegram_bot`) демонстрируют SDK bootstrap.
- Предложение: добавить короткую "Testing strategy" с перечнем обязательных/опциональных прогонов (unit/integration/perf).

## 9. Риски, возможности и следующие шаги
### Высокий приоритет
1. **Починить Ruff** — иначе CI останется красным; владельцы CLI и тестов.
2. **Стабилизировать полный pytest** — найти самые медленные группы (CLI/integration), настроить переиспользование БД или шардирование.
3. **Уточнить группы зависимостей** — вынести infra-only пакеты в extras/dev, чтобы не тянуть их в каждую установку.

### Средний приоритет
4. **Показать CI** — в репо нет pipeline'ов; если CI приватный, задокументировать. Иначе создать workflow: lint + unit + integration (возможно, матрица по БД).
5. **Наблюдаемость** — логирование есть, но метрик/трейсинга нет. Добавить хуки (Prometheus, audit trail).
6. **Регрессионные перф-тесты** — `tests/perf/` не задокументирован; описать запуск и чтение результатов.

### Быстрые улучшения
- Переименовать `l` → `line`/`entry` и т.п.
- Заменить `assert False` на `pytest.fail` или `with pytest.raises`.
- Переписать сигнатуры CLI на `Annotated[..., Option(...)]` для Typer 0.12.
- Добавить Make/Invoke-цели (`make lint`, `make test-unit`, `make test-integration`) для удобства.

## 10. Чек-лист последующих действий
- [ ] Запустить `ruff --fix` и довести оставшиеся нарушения вручную.
- [ ] Снять профили `pytest --durations=25`, изолировать медленные тесты.
- [ ] Повторить полный `pytest` после оптимизаций и зафиксировать время/результат.
- [ ] Пересмотреть группы Poetry, задокументировать разделение рантайм/разработка.
- [ ] Рассмотреть smoke-тесты для `examples/telegram_bot`, чтобы пример не устаревал.

---
_Аудит выполнен через анализ структуры репозитория, изучение манифестов зависимостей, выборочное чтение документации, запуск Ruff и целевых pytest-команд. RPG-граф остаётся главным артефактом планирования будущих итераций._
