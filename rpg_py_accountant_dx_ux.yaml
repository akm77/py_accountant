# Repository Planning Graph (RPG) — DX/UX план внедрения
# Источники: rpg_py_accountant.yaml, ACCOUNTING_AUDИТ.md, ARCHITECTURE_DX_UX_AУДИТ_GPT5.md, ARCHITECTURE_AУДИТ.md

rpg:
  metadata:
    project_name: "py_accountant"
    plan_name: "DX_UX_Enhancements"
    description: "Пошаговый план улучшений DX/UX: публичный SDK-слой, улучшения CLI, идемпотентность постинга, стандартизация ошибок и JSON, документация."
    last_updated: "2025-11-13"
    sizing_guideline: "Размер одной итерации <= ~5–6k токенов для LLM; каждую итерацию выполнять и тестировать отдельно."

  goals:
    - Упростить интеграцию (DX) через стабильный слой `py_accountant.sdk` (bootstrap, uow, use cases, json, errors).
    - Улучшить UX бухгалтера в CLI (дата операции, курс на строке, загрузка из файла, дружелюбные ошибки).
    - Добавить идемпотентность постинга транзакций.
    - Централизовать сериализацию и маппинг ошибок для CLI/ботов/HTTP.
    - Обновить примеры и документацию (SDK surface, dual-URL, шпаргалка проводок).

  scope:
    in_scope:
      - Новый пакет `src/py_accountant/sdk/*` и переэкспорт в `src/py_accountant/__init__.py`.
      - Изменения CLI: `src/presentation/cli/ledger.py`, `src/presentation/cli/infra.py` (минимальные правки контроллеров).
      - Идемпотентность: модель/репозиторий журналов, миграция Alembic, тесты.
      - Документация и примеры (README/INTEGRATION_GUIDE/Telegram).
    out_of_scope:
      - Переписывание домена/use case’ов (сохраняем чистоту слоёв).
      - Полный рефактор CLI за пределами указанных команд.
      - Нефункциональные оптимизации, не влияющие на DX/UX.

  planned_nodes:
    modules_to_add:
      - name: "py_accountant.sdk"
        path: "src/py_accountant/sdk"
        description: "Публичный SDK-слой: bootstrap, settings, uow, use_cases, json, errors, logging."
      - name: "py_accountant.sdk.bootstrap"
        path: "src/py_accountant/sdk/bootstrap.py"
        description: "init_app(settings|env) -> AppContext{uow_factory, clock, logger, settings}; runtime‑валидация dual‑URL."
      - name: "py_accountant.sdk.uow"
        path: "src/py_accountant/sdk/uow.py"
        description: "Фабрики Async UoW, нормализация async URL, таймауты/параметры пула."
      - name: "py_accountant.sdk.settings"
        path: "src/py_accountant/sdk/settings.py"
        description: "Загрузка настроек из env; validate_dual_url(sync, async)."
      - name: "py_accountant.sdk.errors"
        path: "src/py_accountant/sdk/errors.py"
        description: "Публичные ошибки (UserInputError/DomainViolation/NotFound/UnexpectedError) и map_exception()."
      - name: "py_accountant.sdk.json"
        path: "src/py_accountant/sdk/json.py"
        description: "JSON presenter: Decimal→str, datetime→UTC ISO, snake_case."
      - name: "py_accountant.sdk.use_cases"
        path: "src/py_accountant/sdk/use_cases.py"
        description: "Тонкие фасады: постинг, баланс счёта, выписка, trading balance, FX TTL."

    files_to_update:
      - name: "src/py_accountant/__init__.py"
        description: "Переэкспорт SDK фасадов (не ломая совместимость)."
      - name: "src/presentation/cli/ledger.py"
        description: "CLI улучшения: --occurred-at, пятый токен Rate, дружелюбные ошибки, --idempotency-key, (позже) --lines-file."
      - name: "src/presentation/cli/infra.py"
        description: "Опционально: использование SDK bootstrap/uow helper'ов."
      - name: "src/infrastructure/persistence/sqlalchemy/models.py"
        description: "Индекс идемпотентности: уникальный ключ для idempotency_key (nullable unique)."
      - name: "src/infrastructure/persistence/sqlalchemy/repositories_async.py"
        description: "Guard на идемпотентность: поиск по key перед insert; возврат существующей транзакции."
      - name: "alembic/versions/0006_add_journal_idempotency_key.py"
        description: "Новая миграция: добавить колонку idempotency_key и уникальный индекс."

    components_to_add:
      - name: "SimpleTransactionParser"
        parent_file: "src/py_accountant/sdk/use_cases.py"
        type: "function"
        description: "Парсер формата SIDE:Account:Amount:Currency[:Rate] → list[EntryLineDTO], валидация."
      - name: "ErrorMatrix"
        parent_file: "src/py_accountant/sdk/errors.py"
        type: "mapping"
        description: "Карта кодов ошибок → человекочитаемые подсказки (invalid_line_format, unbalanced_ledger, missing_base_currency и т.д.)."

  edges:
    inter_module_flows:
      - from: "py_accountant.sdk.use_cases"
        to: "src/application/use_cases_async/*"
        data_type: "Вызовы фасадов use case’ов"
        description: "SDK фасады оборачивают существующие async use case’ы без логики домена."
      - from: "py_accountant.sdk.uow"
        to: "src/infrastructure/persistence/sqlalchemy/uow.py"
        data_type: "Фабрики UoW"
        description: "SDK строит AsyncSqlAlchemyUnitOfWork по URL/settings."
      - from: "src/presentation/cli/ledger.py"
        to: "py_accountant.sdk.errors"
        data_type: "Маппинг ошибок для UX"
        description: "CLI использует map_exception() для дружелюбных сообщений."
      - from: "src/presentation/cli/ledger.py"
        to: "py_accountant.sdk.use_cases"
        data_type: "Парсинг/постинг/баланс"
        description: "CLI может использовать общий парсер и фасады SDK."
      - from: "repositories_async (transactions)"
        to: "models.JournalORM"
        data_type: "Идемпотентность"
        description: "Уникальный индекс idempotency_key и проверка перед вставкой."

  acceptance_criteria:
    - SDK импорты стабильны: `from py_accountant.sdk import bootstrap, use_cases, json, errors` доступны.
    - CLI принимает 5-й токен Rate; поддерживает `--occurred-at`; печатает дружелюбные сообщения (exit code 2 для ожидаемых ошибок).
    - Идемпотентность: повторный постинг с тем же ключом не создаёт дублей (юнит/интеграция зелёные).
    - JSON сериализация детерминирована (Decimal→str, datetime→UTC ISO).
    - Документация содержит раздел «SDK surface» и «Шпаргалка проводок».

  iterations:
    - id: "I-DX-01"
      title: "SDK каркас: json + errors + use_cases (тонкие фасады)"
      size: "~4k токенов"
      status: "done"
      deliverables:
        - Добавить пакет `py_accountant/sdk` с модулями: `__init__.py`, `json.py`, `errors.py`, `use_cases.py` (фасады к AsyncPostTransaction/AsyncGetAccountBalance/AsyncGetLedger). [done]
        - Переэкспортировать фасады в `py_accountant/__init__.py`. [done]
        - Реализовать SimpleTransactionParser (без файловых форматов). [done]
      tests:
        - tests/unit/sdk/test_imports.py — импорт фасадов из корневого пакета. [added]
        - tests/unit/sdk/test_json_presenter.py — Decimal/datetime сериализация. [added]
        - tests/unit/sdk/test_error_mapping.py — маппинг ошибок домена в публичные. [added]
      risks:
        - Несогласованность snake_case полей — покрыть тестами to_dict().

    - id: "I-UX-01"
      title: "CLI улучшение post: occurred-at, Rate, дружелюбные ошибки"
      size: "~3k токенов"
      status: "done"
      deliverables:
        - В `ledger post` добавить опцию `--occurred-at <ISO>` (UTC нормализация). [done]
        - Расширить парсер `--line` до формата `SIDE:Account:Amount:Currency[:Rate]` с поддержкой вложенных `:` в Account. [done]
        - Использовать `sdk.errors.map_exception()` для человекочитаемых сообщений; сохранить коды выхода: 0/2/1. [done]
      tests:
        - tests/integration/cli/test_cli_ledger_post_minimal.py — успешный постинг с Rate и occurred_at; негативные кейсы формата/несбалансированности. [added]
      notes: |
        Внутренне: локальный парсер CLI оставлен вместо SDK-парсера для корректной поддержки иерархических счетов с двоеточиями. Ошибки формата/валидности имеют дружелюбные подсказки; при маппинге исключений повторно выбрасываются ValidationError/ValueError для сохранения exit code=2.

    - id: "I-DX-02"
      title: "SDK bootstrap/settings/uow и runtime‑валидация dual‑URL"
      size: "~4k токенов"
      status: "done"
      deliverables:
        - `sdk.settings.load_from_env()` и `validate_dual_url()`. [done]
        - `sdk.uow.build_uow_factory(settings)`; `sdk.bootstrap.init_app()` возвращает AppContext. [done]
      tests:
        - tests/unit/sdk/test_settings_dual_url.py — позитив/негатив. [added]
        - tests/integration/sdk/test_bootstrap_sqlite.py — init_app() + простой use case. [added]
      notes: "Рефактор завершён: добавлены модули settings/uow/bootstrap, реэкспортированы в SDK/корень; pytest зелёный (вкл. новые тесты)."

    - id: "I-UX-02"
      title: "CLI загрузка строк из файла (CSV/JSON)"
      size: "~4k токенов"
      status: "done"
      deliverables:
        - В `ledger post` добавить `--lines-file <path>`: поддержка CSV (side,account,amount,currency,rate?) и JSON (массив объектов/строк). [done]
        - Объекты из файлов нормализуются в строковый формат и валидируются существующим CLI-парсером. [done]
      tests:
        - tests/integration/cli/test_cli_ledger_post_files.py — CSV/JSON успешные/ошибочные сценарии. [added]

    - id: "I-DX-03"
      title: "Идемпотентность постинга (meta + индекс + guard)"
      size: "~4k токенов"
      status: "done"
      deliverables:
        - CLI: опция `--idempotency-key` → meta["idempotency_key"].
        - ORM: колонка `idempotency_key` (nullable), уникальный индекс (условный), миграция Alembic.
        - Репозиторий: при add() — проверка существования по ключу; при коллизии — возврат существующей транзакции; сохранение `tx_id` в journal.meta для стабильного ID.
      tests:
        - tests/integration/test_idempotent_posting.py — повторный вызов не создаёт дубль, возвращает тот же id.
      notes:
        - Миграция для SQLite выполняется через batch_alter_table + уникальный индекс (вместо ALTER CONSTRAINT); на Postgres поведение эквивалентно.
        - Без ключа поведение прежнее; при повторе с ключом возвращается первый tx.id (tx:<uuid>), конфликт payload не детектируется в этой итерации.
        - Гонки вставки обрабатываются через UNIQUE и перехват IntegrityError с повторным чтением по ключу.

    - id: "I-DOC-01"
      title: "Документация и примеры на SDK"
      size: "~3k токенов"
      deliverables:
        - README: раздел «SDK surface» (+ примеры FastAPI/aiogram/cron).
        - docs/INTEGRATION_GUIDE.md: dual‑URL в одном месте; примеры SDK.
        - «Шпаргалка проводок» в README или отдельном docs/ACCOUNTING_CHEATSHEET.md.
        - examples/telegram_bot/*: переход на SDK bootstrap + error mapping.
      tests:
        - tests/docs/test_docs_sections_present.py

    - id: "I-OPT-01 (optional)"
      title: "Совместимость Python 3.11–3.12 и метрики"
      size: "~3k токенов"
      deliverables:
        - Прогон тестов на 3.11/3.12; при успехе — обновить pyproject.toml (`>=3.11,<4.0`).
        - feature-flag логирования метрик в SDK (use_case_time_ms, uow_time_ms).
      tests:
        - CI matrix + smoke‑тесты SDK.

  test_matrix:
    unit:
      - tests/unit/sdk/test_imports.py
      - tests/unit/sdk/test_json_presenter.py
      - tests/unit/sdk/test_error_mapping.py
      - tests/unit/sdk/test_settings_dual_url.py
    integration:
      - tests/integration/sdk/test_bootstrap_sqlite.py
      - tests/integration/cli/test_cli_ledger_post_minimal.py
      - tests/integration/cli/test_cli_ledger_post_files.py
      - tests/integration/test_idempotent_posting.py
    docs:
      - tests/docs/test_docs_sections_present.py

  risks_and_mitigations:
    - risk: "Разночтения сериализации JSON между CLI/SDK"
      mitigation: "Единый presenter в sdk.json; CLI использует его напрямую."
    - risk: "Сломать существующих интеграторов"
      mitigation: "Переэкспорт в корневом пакете; не менять публичные пути вне SDK; фичи CLI добавлять обратносуместимо."
    - risk: "Миграция БД для идемпотентности на проде"
      mitigation: "Индекс условный (на non‑null); сухой прогон миграций; фича — опциональна до включения ключа."

  success_metrics:
    - "Время до первой интеграции" снижается (пример SDK из README работает без доп. кода).
    - "Ошибки формата проводки" уменьшаются за счёт парсера/подсказок.
    - Повторы постинга не создают дублей при использовании ключа.

  notes:
    - План следует принципу «тонкий SDK над существующими слоями» — домен/use case’ы не меняются.
    - Итерации независимы топологически (I-DX-01 и I-UX-01 можно выполнять параллельно), но публикация SDK в README делается после I-DX-01.
