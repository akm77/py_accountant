rpg_docs_plan:
  metadata:
    project: "py_accountant"
    description: "План приведения документации в соответствие с текущим состоянием репозитория по методике RPG"
    generated_at: "2025-11-12"
    owner: "docs/architecture"
    methodology: "Repository Planning Graph (RPG): узлы = документы/источники истины, рёбра = зависимости и порядок работ"

  nodes:
    documents:
      - id: DOCS_CLI_QUICKSTART
        path: docs/CLI_QUICKSTART.md
        role: "Публичный быстрый старт по CLI"
      - id: DOCS_ARCH_OVERVIEW
        path: docs/ARCHITECTURE_OVERVIEW.md
        role: "Обзор архитектуры слоёв и потоков данных"
      - id: DOCS_FX_AUDIT
        path: docs/FX_AUDIT.md
        role: "Описание аудита курсов и TTL"
      - id: DOCS_TRADING_WINDOWS
        path: docs/TRADING_WINDOWS.md
        role: "Семантика торговых окон и отчётов"
      - id: DOCS_INTEGRATION_GUIDE
        path: docs/INTEGRATION_GUIDE.md
        role: "Гайд по встраиванию (SDK-паттерн)"
      - id: DOCS_PERFORMANCE
        path: docs/PERFORMANCE.md
        role: "Форматы метрик производительности"
      - id: DOCS_PARITY_REPORT
        path: docs/PARITY_REPORT.md
        role: "Отчёт согласованности без legacy (внутренний инструмент)"
      - id: README
        path: README.md
        role: "Root обзор и Quick Start"
      - id: RUN_MIGRATIONS
        path: docs/RUNNING_MIGRATIONS.md
        role: "Процедуры Alembic (актуально, сверка ссылок)"

    sources_of_truth:
      - id: CLI_MAIN
        path: src/presentation/cli/main.py
        role: "Точки входа CLI и регистрация саб-приложений"
      - id: CLI_LEDGER
        path: src/presentation/cli/ledger.py
        role: "Команды ledger: post/list/balance"
      - id: CLI_TRADING
        path: src/presentation/cli/trading_balance.py
        role: "Команды trading: raw/detailed"
      - id: CLI_FX
        path: src/presentation/cli/fx_audit.py
        role: "Команды fx: add-event/list/ttl-plan"
      - id: CLI_ACCOUNTS
        path: src/presentation/cli/accounts.py
        role: "Команды account: list/add/get"
      - id: CLI_CURRENCIES
        path: src/presentation/cli/currencies.py
        role: "Команды currency: list/add/set-base"
      - id: DOMAIN_QUANTIZE
        path: src/domain/quantize.py
        role: "Квантизация: money=2dp, rate=6dp, HALF_EVEN"
      - id: DOMAIN_TRADING
        path: src/domain/trading_balance.py
        role: "Raw/Converted агрегация, поведение ставок"
      - id: USECASES_TRADING
        path: src/application/use_cases_async/trading_balance.py
        role: "Async use cases: trading raw/detailed"
      - id: USECASES_FX_TTL_PLAN
        path: src/application/use_cases_async/fx_audit_ttl.py
        role: "Async план и выполнение TTL (план/execute)"
      - id: ALEMBIC_ENV
        path: alembic/env.py
        role: "Sync URL только для миграций"

  edges:
    # Документы зависят от актуальных модулей CLI/Domain/UseCases
    - from: DOCS_CLI_QUICKSTART
      to: [CLI_MAIN, CLI_LEDGER, CLI_TRADING, CLI_FX, CLI_ACCOUNTS, CLI_CURRENCIES]
      description: "Команды и их синтаксис"
    - from: README
      to: [DOCS_CLI_QUICKSTART]
      description: "Повторяет Quick Start и ссылки"
    - from: DOCS_ARCH_OVERVIEW
      to: [DOMAIN_QUANTIZE, DOMAIN_TRADING, USECASES_TRADING, USECASES_FX_TTL_PLAN, ALEMBIC_ENV]
      description: "Слои, квантизация, поведение балансов, TTL, sync Alembic"
    - from: DOCS_FX_AUDIT
      to: [CLI_FX, USECASES_FX_TTL_PLAN]
      description: "Команды fx и TTL (план), отсутствие execute в CLI"
    - from: DOCS_TRADING_WINDOWS
      to: [CLI_TRADING, DOMAIN_TRADING, USECASES_TRADING]
      description: "Raw vs Detailed, база и ошибки"
    - from: DOCS_INTEGRATION_GUIDE
      to: [CLI_MAIN, USECASES_TRADING, USECASES_FX_TTL_PLAN]
      description: "Async-only интеграция, отсутствие sync UoW"
    - from: DOCS_PERFORMANCE
      to: [CLI_MAIN]
      description: "Общие принципы; ссылки не на несуществующие тесты"
    - from: DOCS_PARITY_REPORT
      to: []
      description: "Отметить внутренний статус; убрать CLI-вызовы"

  iterations:
    - id: I1
      title: "Привести CLI Quickstart и README к актуальным space-командам"
      goal: "Пользователь может скопировать команды из Quickstart и успешно выполнить их"
      changes:
        - file: docs/CLI_QUICKSTART.md
          edits:
            - "Заменить двоеточие-формат на Typer-группы: currency add|set-base; account add; ledger post|balance; trading raw|detailed; fx add-event|list|ttl-plan"
            - "Удалить несуществующие diagnostics:rates-audit и diagnostics:parity-report; добавить diagnostics ping"
            - "Обновить примеры --line формата и JSON-флаги"
        - file: README.md
          edits:
            - "Синхронизировать Quick Start с CLI_QUICKSTART.md"
            - "Удалить ссылки на несуществующие CLI-команды diagnostics:rates-audit/parity-report"
            - "Оставить ссылку на RUNNING_MIGRATIONS.md и INTEGRATION_GUIDE.md"
      acceptance_criteria:
        - "Греп по репо: отсутствуют строки 'diagnostics:rates-audit' и 'diagnostics:parity-report' в README и CLI_QUICKSTART"
        - "Все примеры команд соответствуют реально существующим Typer-командам (по исходникам CLI)"
        - "Мини-смоук: diagnostics ping выполняется"
      status: done
      completed_at: "2025-11-12"
      verification:
        grep_readme_cli_quickstart: pass
        commands_match_typer: pass
        smoke_diagnostics_ping: pass
        notes:
          - "README.md и docs/CLI_QUICKSTART.md обновлены; команды в формате Typer групп с пробелом"
          - "Удалены упоминания diagnostics:rates-audit / diagnostics:parity-report в этих файлах"
          - "Добавлен diagnostics ping; уточнён формат --line без rate; синхронизированы примеры"
          - "Актуализированы ссылки (добавлен RUNNING_MIGRATIONS.md в README)."

    - id: I2
      title: "ARCHITECTURE_OVERVIEW: async-only, порты, квантизация и поведение Trading"
      goal: "Архитектурный обзор отражает текущее ядро и контракты"
      changes:
        - file: docs/ARCHITECTURE_OVERVIEW.md
          edits:
            - "Добавить явное: ядро async-only (I29); Alembic использует только sync драйвер"
            - "Порты: application/ports.py (Async* Protocols); репозитории CRUD-only"
            - "Квантизация: money=2dp, rate=6dp, ROUND_HALF_EVEN (src/domain/quantize.py)"
            - "Trading Detailed: used_rate=1 только для базовой валюты; для небазовой при отсутствии/неположительном rate → ValidationError"
            - "Удалить упоминания баланс-кэша и любых I/O из домена"
            - "Добавить раздел о FX Audit TTL: план (CLI) и выполнение (SDK)"
            - "Обновить диаграмму потоков данных (CLI → async use cases → порты → infra)"
      acceptance_criteria:
        - "Документ упоминает правильные масштабы квантизации (2dp/6dp)"
        - "Нет упоминаний про sync UoW/репозитории или кэш-баланс"
        - "Есть раздел про TTL: CLI план есть, execute только через use case"
      status: done
      completed_at: "2025-11-12"
      verification:
        criteria_quantization_scales: pass
        criteria_no_sync_uow_mentions: pass
        criteria_ttl_plan_vs_execute: pass
        diagram_sources_present: pass
        readme_links_updated: pass
        notes:
          - "Обновлён docs/ARCHITECTURE_OVERVIEW.md под async-only ядро и порты (src/application/ports.py)"
          - "Закреплена квантизация: money=2dp, rate=6dp, ROUND_HALF_EVEN (src/domain/quantize.py)"
          - "Описано поведение Trading Detailed: base обязателен; used_rate=1 для базы; ошибки при отсутствии/неположительном курсе"
          - "Добавлен раздел про FX TTL (план vs исполнение); CLI не вызывает execute"
          - "Добавлена PlantUML-диаграмма docs/ARCHITECTURE_OVERVIEW.puml"
          - "Сгенерирован SVG docs/ARCHITECTURE_OVERVIEW.svg; ссылка добавлена в README и встройка предпросмотра"
          - "Поток данных и таблицы БД перечислены (accounts, currencies, transactions/lines, exchange_rate_events, exchange_rate_events_archive)"

    - id: I3
      title: "FX_AUDIT: команды fx и TTL-план вместо maintenance"
      goal: "Документ даёт корректные инструкции по аудиту курсов и TTL"
      changes:
        - file: docs/FX_AUDIT.md
          edits:
            - "Заменить fx:update/diagnostics:rates-аудит/maintenance:fx-ttl на: fx add-event, fx list, fx ttl-plan"
            - "Сохранить описание схемы exchange_rate_events и archive, индексы"
            - "Явно зафиксировать: в CLI есть только план TTL; выполнение — через AsyncExecuteFxAuditTTL (SDK/воркер)"
            - "Примеры JSON: rate шестью знаками, datetime в ISO8601 UTC"
      acceptance_criteria:
        - "В документе отсутствуют команды maintenance:fx-ttl и diagnostics:rates-аудит"
        - "Примеры команд успешно сопоставляются с исходниками CLI"
        - "Есть явная оговорка про отсутствие CLI-исполнения TTL"
      status: done
      completed_at: "2025-11-12"
      verification:
        criteria_no_legacy_commands: pass
        commands_match_typer: pass
        ttl_execute_outside_cli: pass
        examples_json_formats: pass
        notes:
          - "docs/FX_AUDIT.md переписан под async-only: add-event, list, ttl-plan; удалены устаревшие команды."
          - "Добавлен раздел 'TTL исполнение (execute) — вне CLI' с описанием AsyncExecuteFxAuditTTL."
          - "JSON-форматы: Decimal как строка с 6 знаками; datetime ISO8601 UTC."
          - "Добавлены ссылки на quantize.py и ARCHITECTURE_OVERVIEW.md для согласованной терминологии."

    - id: I4
      title: "TRADING_WINDOWS: raw/detailed, требования к базе и ошибкам"
      goal: "Пользователь понимает различия raw vs detailed и корректно задаёт base"
      changes:
        - file: docs/TRADING_WINDOWS.md
          edits:
            - "Переименовать trading:balance → trading raw; trading:detailed → trading detailed"
            - "Уточнить: detailed требует base (явно или из справочника), при отсутствии базы — ValidationError"
            - "Уточнить: для небазовой валюты при отсутствии/неположительном курсе — ValidationError"
            - "Обновить CLI-примеры и граничные случаи"
      acceptance_criteria:
        - "Все примеры используют существующие команды"
        - "Раздел Ошибки отражает поведение домена/юзкейсов"
      status: done
      completed_at: "2025-11-12"
      verification:
        no_legacy_commands_in_doc: pass
        commands_match_typer: pass
        formats_quantization_stated: pass
        errors_listed: pass
        notes:
          - "docs/TRADING_WINDOWS.md обновлён под async-only; команды trading raw/detailed."
          - "Удалены упоминания trading:balance/trading:detailed; добавлены Typer-примеры с --json."
          - "Добавлены разделы: окно времени, meta, квантизация (2dp/6dp), примеры JSON, ошибки."
          - "Зафиксировано требование к base в detailed; used_rate=1 для базовой; проверки ставок > 0."

    - id: I5
      title: "INTEGRATION_GUIDE: переписать на async-only"
      goal: "Гайд показывает актуальные паттерны интеграции без sync-слоя"
      changes:
        - file: docs/INTEGRATION_GUIDE.md
          edits:
            - "Удалить примеры с SqlAlchemyUnitOfWork (sync) и SyncUnitOfWorkWrapper"
            - "Добавить минимальные примеры с AsyncSqlAlchemyUnitOfWork и application.use_cases_async.*"
            - "Раздел Runtime vs Migration URLs оставить; подчеркнуть sync для Alembic"
            - "TTL: показать план и выполнение через use cases; запуск как фонового джоба"
            - "Показать настройки пакета py_accountant для async работы"
            - "Telegram Bot: на каждый запрос — новый Async UoW; список используемых async use cases"
      acceptance_criteria:
        - "Нет упоминаний sync UoW/обёрток"
        - "Присутствуют рабочие async-примеры с актуальными импортами"
      status: done
      completed_at: "2025-11-12"
      verification:
        no_sync_uow_mentions: pass  # grep -nE 'SqlAlchemyUnitOfWork\b|SyncUnitOfWorkWrapper' пуст для sync вариантов
        no_colon_cli_commands: pass  # grep legacy patterns пуст
        commands_match_typer: pass  # примеры соответствуют src/presentation/cli/*.py
        async_examples_present: pass  # есть AsyncSqlAlchemyUnitOfWork + async use cases
        ttl_plan_vs_execute: pass  # CLI только ttl-plan; execute через AsyncExecuteFxAuditTTL
        formats_consistent: pass  # Decimal строки, ISO8601 UTC, 2dp/6dp
        notes:
          - "Документ переписан на async-only; удалены все sync примеры."
          - "CLI команды в формате групп (currency add, ledger post, trading detailed,...)."
          - "TTL: план через CLI, исполнение через AsyncExecuteFxAuditTTL (SDK пример добавлен)."
          - "Telegram Bot секция обновлена на фабрику нового Async UoW."
          - "Smoke сценарии без двоеточий, все команды актуальны."

    - id: I6
      title: "PARITY_REPORT: пометить как внутренний инструмент (без публичной CLI)"
      goal: "Документ не вводит в заблуждение относительно доступности CLI"
      changes:
        - file: docs/PARITY_REPORT.md
          edits:
            - "Удалить раздел запуска через CLI; добавить пометку internal/SDK"
            - "Сохранить формат отчёта как спецификацию для тестов/интеграций"
      acceptance_criteria:
        - "В документе нет примеров вызова несуществующей CLI"
        - "Ясно указан статус и назначение документа"

    - id: I7
      title: "PERFORMANCE: синхронизация ссылок/примеров"
      goal: "Нет ссылок на несуществующие тесты, формат отчёта актуален"
      changes:
        - file: docs/PERFORMANCE.md
          edits:
            - "Уточнить запуск профиля/смоуков без привязки к несуществующим тестам"
            - "Оставить JSON-формат и интерпретацию полей"
      acceptance_criteria:
        - "Отсутствуют 404-ссылки на тесты"
        - "Формат отчёта не противоречит актуальному CLI/слою"

    - id: I8
      title: "Финальная сверка ссылок и терминов (link/term sweep)"
      goal: "Внутренние ссылки и терминология согласованы во всех документах"
      changes:
        - files:
            - docs/CLI_QUICKSTART.md
            - docs/ARCHITECTURE_OVERVIEW.md
            - docs/FX_AUDIT.md
            - docs/TRADING_WINDOWS.md
            - docs/INTEGRATION_GUIDE.md
            - docs/PERFORMANCE.md
            - docs/PARITY_REPORT.md
            - README.md
          edits:
            - "Проверить все внутренние ссылки и упоминания команд"
            - "Единообразие форматов: Decimal→строка, datetime→ISO8601 Z"
            - "Обновить Roadmap/исторические заметки где необходимо"
      acceptance_criteria:
        - "grep по репозиторию не находит старые формы команд (например, 'trading:balance', 'maintenance:fx-ttl')"
        - "Все ссылки указывают на существующие файлы в репозитории"

  topology:
    order: [I1, I2, I3, I4, I5, I6, I7, I8]
    rationale:
      - "Сначала исправить точки входа пользователя (Quick Start/README)"
      - "Затем обновить архитектурный каркас и ключевые тематические разделы (FX/Trading)"
      - "После — интеграционный гайд"
      - "В конце — вспомогательные документы и финальная сверка"

  quality_gates:
    - "Сборка не требуется; документация в Markdown должна проходить линт/просмотр"
    - "Команды из Quick Start выполняются на sqlite+aiosqlite (локально)"
    - "Файлы docs не содержат ссылок на несуществующие команды/пути"

  risks:
    - "Возможны скрытые упоминания устаревших команд в неохваченных документах — минимизируем финальной сверкой"
    - "Потребуется уточнение формулировок на английском/русском — держать стиль единым"
